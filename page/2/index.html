
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  
  <title>HankLiu的博客小屋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="努力去听风的声音，不必在意风的方向。">
<meta property="og:type" content="website">
<meta property="og:title" content="HankLiu的博客小屋">
<meta property="og:url" content="https://hankliu62.github.io/page/2/index.html">
<meta property="og:site_name" content="HankLiu的博客小屋">
<meta property="og:description" content="努力去听风的声音，不必在意风的方向。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="HankLiu">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/img/favicon.ico" sizes="16x16">
  
  <link rel="stylesheet" href="/css/style.css?t=1">
  
    <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
  

<meta name="generator" content="Hexo 7.1.1"></head>

<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner">
    <div id="banner-mask"></div>
  </div>
  <div id="header-outer" class="outer">
    <nav id="upper-nav" class="inner">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <div class="sub-nav">
        
        
          <a id="nav-github" class="nav-icon" href="https://github.com/hankliu62"></a>
        
      </div>
    </nav>
    <div id="header-title">
      
        <h1 id="blog-title-wrap">
          <a href="/" id="blog-title">HankLiu的博客小屋</a>
        </h1>
      
      
        <h5 class="blog-subtitle-wrap">努力去听风的声音，不必在意风的方向。</h5>
      
    </div>
    <div id="contenedor">
      <ul class="cube">
        <li class="cara"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="100" width="100" viewBox="-50 -50 200 200">
          <circle cx="50" cy="50" r="45" stroke-width="5" stroke="black" stroke-opacity="0.5" fill-opacity="0"></circle>
          <rect id="clockwise" x="47.5" y="27.5" width="5" height="25" rx="2.5" ry="2.5" fill="black" fill-opacity="0.5" transform="rotate(330 50 50)"></rect>
          <rect id="minute" x="48.5" y="16.5" width="3" height="35" rx="1.5" ry="1.5" fill="black" fill-opacity="0.5"></rect>
        </svg></li>
        <li class="cara">P</li>
        <li class="cara">X</li>
        <li class="cara">L</li>
        <li class="cara">C</li>
        <li class="cara">Y</li>
      </ul>
    </div>
    <nav id="main-nav">
      
        <a class="main-nav-link" href="/">主页</a>
      
        <a class="main-nav-link" href="/archives">文章</a>
      
        <a class="main-nav-link" href="/toolkit">小工具</a>
      
        <a class="main-nav-link" href="/resume">小简介</a>
      
        <a class="main-nav-link" href="/about">小关于</a>
      
    </nav>
  </div>
</header>

    <div class="outer">
      <section id="main">
  
    <article id="post-github-pages-env" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/01/12/github-pages-env/" class="article-date">
  <time datetime="2024-01-12T21:51:20.000Z" itemprop="datePublished">2024-01-12</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/01/12/github-pages-env/">NextJs 获取 Github Action 部署的环境变量</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="NextJs-获取-Github-Action-部署的环境变量"><a href="#NextJs-获取-Github-Action-部署的环境变量" class="headerlink" title="NextJs 获取 Github Action 部署的环境变量"></a>NextJs 获取 Github Action 部署的环境变量</h2><h3 id="设置变量"><a href="#设置变量" class="headerlink" title="设置变量"></a>设置变量</h3><p>项目中需要某些私有密钥，不能直接暴露在仓库中，在编译<code>Next.js</code>的时候，需要将该密钥通过环境变量的形式注入到<code>Next.js</code>项目中，所以第一步，我们需要将这个密钥储存到当前仓库的<code>Settings/Secrets</code>里面，具体操作如下图所示：</p>
<p><img src="https://github.com/hankliu62/interview/assets/8088864/887a0ad5-6b4a-4977-a2cb-8c7adc5b63b6" alt="image"></p>
<h3 id="配置变量"><a href="#配置变量" class="headerlink" title="配置变量"></a>配置变量</h3><p>在<code>Next.js</code>中获取<code>GitHub Actions</code>环境变量，你可以使用<code>process.env</code>对象来访问在<code>GitHub Actions</code>中设置的环境变量。以下是一个如何在<code>Next.js</code>中获取<code>GitHub Actions</code>环境变量的例子：</p>
<p>首先，在GitHub Actions的工作流文件中设置环境变量，例如在 <code>.github/workflows/ci.yml</code>中：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="number">14</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">Next.js</span> <span class="string">App</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">MY_ENV_VAR:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.MY_SECRET_ENV_VAR</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br></pre></td></tr></table></figure>

<p>在这个例子中，<code>MY_ENV_VAR</code>是一个环境变量，它可以是一个秘密值，通过<code>GitHub Actions</code>的秘密（secrets）功能来安全地设置。</p>
<p>然后，需要将环境变量添加到 <code>Next</code> 项目的配置文件中，在 <code>next.config.js</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">env</span>: &#123;</span><br><span class="line">    <span class="attr">MY_ENV_VAR</span>: process.<span class="property">env</span>.<span class="property">MY_ENV_VAR</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取变量"><a href="#获取变量" class="headerlink" title="获取变量"></a>获取变量</h3><p>然后，在Next.js的应用代码中，你可以这样获取这个环境变量：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> myEnvVar = process.<span class="property">env</span>.<span class="property">MY_ENV_VAR</span>;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>The environment variable is: &#123;myEnvVar || &#x27;undefined&#x27;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，<code>process.env.MY_ENV_VAR</code> 将会获取在 <code>GitHub Actions</code> 中设置的环境变量<code>MY_ENV_VAR</code>的值。如果环境变量存在，它将被显示在页面上；如果不存在，则会显示<code>&#39;undefined&#39;</code>。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/github/" rel="tag">github</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/01/12/github-pages-env/" data-id="cluz1as9e000eqnq982gaeheh" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-github-pages" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2023/12/27/github-pages/" class="article-date">
  <time datetime="2023-12-27T12:20:26.000Z" itemprop="datePublished">2023-12-27</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/12/27/github-pages/">使用 Github Pages 和 Issues 搭建博客</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Github-Pages-简介"><a href="#Github-Pages-简介" class="headerlink" title="Github Pages 简介"></a>Github Pages 简介</h2><p>自己维护博客服务器，需要购买服务器，配置域名等一些列操作，比较繁琐，索性直接找个现成的稳定的博客平台，github pages成为首选，这里有几个思路</p>
<ul>
<li>使用github pages，编写静态网页</li>
<li>使用github pages 与静态网页生成工具，需要本地电脑编写文章</li>
<li>使用github pages 与自建后端服务器，需要另外维护一个后端服务器</li>
<li>使用issues 写文章，issues页面就是一个博客网站</li>
<li>使用github pages 与 github api，使用issues写文章</li>
</ul>
<h3 id="使用github-pages，编写静态网页"><a href="#使用github-pages，编写静态网页" class="headerlink" title="使用github pages，编写静态网页"></a>使用github pages，编写静态网页</h3><p>有很多文档网站是使用这种方式搭建，一般是作为demo页面或者单页文档页面，否则页面稍微一复杂，就变得非常难以维护</p>
<h3 id="使用github-pages-与-静态网页生成工具"><a href="#使用github-pages-与-静态网页生成工具" class="headerlink" title="使用github pages 与 静态网页生成工具"></a>使用github pages 与 静态网页生成工具</h3><p>有很多博客网站与文档网站都是使用这种方式，这是一种最简单最方便的方式，现在流行的工具有 <code>hexo</code> 和 <code>Jekyll</code> 等，这种方式还要在本地维护一个仓库，生成静态页面后再上传，操作过于繁琐，而且每个页面之间切换都需要重新载入所有资源，网页数据传输量较大</p>
<p>具体工具如下所示:</p>
<ul>
<li><a href="https://github.com/hexojs/hexo">hexo</a></li>
<li><a href="https://github.com/jekyll/jekyll">Jekyll</a></li>
</ul>
<h3 id="使用github-pages-与-自建后端服务器"><a href="#使用github-pages-与-自建后端服务器" class="headerlink" title="使用github pages 与 自建后端服务器"></a>使用github pages 与 自建后端服务器</h3><p>在github pages编写一个单页面应用，数据通过跨域请求来自于自建的服务器，这种方式有三大难点：前端、后端、服务器</p>
<p><strong>前端</strong></p>
<p>需要编写一个单页面应用，这对技术需要一定的水平，基本很少有开源工具</p>
<p><strong>后端</strong></p>
<p>需要后端服务，这可以使用现成工具提供api，比如wordpress、drupal、ghost等</p>
<h3 id="使用issues-写文章"><a href="#使用issues-写文章" class="headerlink" title="使用issues 写文章"></a>使用issues 写文章</h3><p>这种方式简单粗暴，直接在issues写文章，评论、标签、提醒神马的都有了，现在其实很流行这种方式，看看这几个博客，都几千个star了</p>
<ul>
<li><a href="https://github.com/tmallfe/tmallfe.github.io">https://github.com/tmallfe/tmallfe.github.io</a></li>
<li><a href="https://github.com/xufei/blog">https://github.com/xufei/blog</a></li>
<li><a href="https://github.com/fouber/blog">https://github.com/fouber/blog</a></li>
</ul>
<p>要说它的缺点嘛，就是人人都可以往你博客提交文章，界面千篇一律，而且也不怎么好看</p>
<p><strong>服务器</strong></p>
<p>这个问题很严重，问题来了，你都有自建的服务器了，还要用github pages干嘛呢，哪天自建服务器挂了，博客照样挂。</p>
<p>这种方式可以使用域名来提升逼格。</p>
<h3 id="使用github-pages-与-github-api"><a href="#使用github-pages-与-github-api" class="headerlink" title="使用github pages 与 github api"></a>使用github pages 与 github api</h3><p>这种方案与上一种对比起来其实没多大区别，唯一的区别就是自建服务换成了github的另一个服务，就是说，github帮我们建好了。<br>github api：<a href="https://developer.github.com/v3/">https://developer.github.com/v3/</a></p>
        
          <p class="article-more-link">
            <a href="/2023/12/27/github-pages/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/github-pages/" rel="tag">github pages</a></li></ul>

        <a data-url="https://hankliu62.github.io/2023/12/27/github-pages/" data-id="cluz1as9f000fqnq99txkani5" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-thread-loader" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2023/02/23/thread-loader/" class="article-date">
  <time datetime="2023-02-23T10:10:20.000Z" itemprop="datePublished">2023-02-23</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/02/23/thread-loader/">thread-loader</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="thread-loader"><a href="#thread-loader" class="headerlink" title="thread-loader"></a>thread-loader</h2><p><code>thread-loader</code> 是一种在 <code>worker</code> 池中运行以下 <code>loader</code> 的工具。</p>
<h3 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h3><p>通过 npm、yarn 或 pnpm 安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev thread-loader</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add -D thread-loader</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add -D thread-loader</span><br></pre></td></tr></table></figure>

<p>将其放在其他 <code>loader</code> 的前面，以下 <code>loader</code> 将在 <code>worker</code> 池中运行。</p>
<p>在 <code>worker</code> 池中运行的 <code>loader</code> 有一些限制。例如：</p>
<ul>
<li><code>loader</code> 不能发射文件。</li>
<li><code>loader</code> 不能使用自定义 <code>loader API</code>（即插件）。</li>
<li><code>loader</code> 不能访问 <code>webpack</code> 配置项。</li>
</ul>
<p>每个 <code>worker</code> 是一个单独的 <code>node.js</code> 进程，启动一个 <code>worker</code> 大约需要 600ms 的时间。此外，进程间通信也存在一定的开销。</p>
<p>因此，仅将此 <code>loader</code> 用于计算密集型操作！</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><h4 id="webpack-config-js"><a href="#webpack-config-js" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">include</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;src&#x27;</span>),</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="string">&#x27;thread-loader&#x27;</span>,</span><br><span class="line">          <span class="comment">// 你的计算密集型 loader（例如 babel-loader）</span></span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="带有选项"><a href="#带有选项" class="headerlink" title="带有选项"></a>带有选项</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">use</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">loader</span>: <span class="string">&#x27;thread-loader&#x27;</span>,</span><br><span class="line">    <span class="comment">// 选项相同的 loader 将共享 worker 池</span></span><br><span class="line">    <span class="attr">options</span>: &#123;</span><br><span class="line">      <span class="comment">// 生成的 worker 数量，默认为（CPU 核心数 - 1）或当 require(&#x27;os&#x27;).cpus() 未定义时回退到 1</span></span><br><span class="line">      <span class="attr">workers</span>: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 一个 worker 并行处理的 job 数量</span></span><br><span class="line">      <span class="comment">// 默认为 20</span></span><br><span class="line">      <span class="attr">workerParallelJobs</span>: <span class="number">50</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 额外的 node.js 参数</span></span><br><span class="line">      <span class="attr">workerNodeArgs</span>: [<span class="string">&#x27;--max-old-space-size=1024&#x27;</span>],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 允许重新生成已死亡的 worker 池</span></span><br><span class="line">      <span class="comment">// 重新生成会减慢整个编译速度</span></span><br><span class="line">      <span class="comment">// 在开发环境中应将其设置为 false</span></span><br><span class="line">      <span class="attr">poolRespawn</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 当空闲时杀死 worker 进程的超时时间</span></span><br><span class="line">      <span class="comment">// 默认为 500 (ms)</span></span><br><span class="line">      <span class="comment">// 对于保持 worker 存活的监视构建，可以设置为 Infinity</span></span><br><span class="line">      <span class="attr">poolTimeout</span>: <span class="number">2000</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 池分配给 worker 的工作数量</span></span><br><span class="line">      <span class="comment">// 默认为 200</span></span><br><span class="line">      <span class="comment">// 降低这个数值会降低总体的效率，但是会提升工作分布更均一</span></span><br><span class="line">      <span class="attr">poolParallelJobs</span>: <span class="number">50</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 池的名称</span></span><br><span class="line">      <span class="comment">// 可以修改名称来创建其余选项都一样的池</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;my-pool&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 耗时的 loader（例如 babel-loader）</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h3 id="预热"><a href="#预热" class="headerlink" title="预热"></a>预热</h3><p>为了防止在启动 <code>worker</code> 时出现高延迟，可以预热 <code>worker</code> 池。</p>
<p>这将启动池中的最大 <code>worker</code> 数量，并将指定的模块加载到 <code>node.js</code> 模块缓存中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> threadLoader = <span class="built_in">require</span>(<span class="string">&#x27;thread-loader&#x27;</span>);</span><br><span class="line"></span><br><span class="line">threadLoader.<span class="title function_">warmup</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 池选项，像传递给 loader 选项那样</span></span><br><span class="line">    <span class="comment">// 必须匹配 loader 选项以启动正确的池</span></span><br><span class="line">  &#125;,</span><br><span class="line">  [</span><br><span class="line">    <span class="comment">// 要加载的模块</span></span><br><span class="line">    <span class="comment">// 可以是任何模块，例如</span></span><br><span class="line">    <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;babel-preset-es2015&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sass-loader&#x27;</span>,</span><br><span class="line">  ]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>翻译: <a href="https://www.npmjs.com/package/thread-loader">thread-loader</a></p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/loader/" rel="tag">loader</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/translate/" rel="tag">translate</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li></ul>

        <a data-url="https://hankliu62.github.io/2023/02/23/thread-loader/" data-id="cluz1as9s0018qnq9g0ao7f33" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-cache-loader" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2023/01/10/cache-loader/" class="article-date">
  <time datetime="2023-01-10T10:10:20.000Z" itemprop="datePublished">2023-01-10</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/01/10/cache-loader/">cache-loader</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="cache-loader"><a href="#cache-loader" class="headerlink" title="cache-loader"></a>cache-loader</h2><p><code>cache-loader</code> 允许在磁盘（默认）或数据库中缓存后续加载器的结果。</p>
<h3 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h3><p>要开始使用，您需要安装 <code>cache-loader</code>：</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev cache-loader</span><br></pre></td></tr></table></figure>

<p>将此加载器添加到其他（耗时的）加载器前面，以便在磁盘上缓存结果。</p>
<p>webpack.config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.ext$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;cache-loader&#x27;</span>, ...loaders],</span><br><span class="line">        <span class="attr">include</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;src&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>⚠️ 请注意，保存和读取缓存文件会有一定的开销，因此只将此加载器用于缓存耗时的加载器。</p>
</blockquote>
<h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">类型</th>
<th align="center">n 默认值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong><code>cacheContext</code></strong></td>
<td align="center"><code>&#123;String&#125;</code></td>
<td align="center"><code>undefined</code></td>
<td align="left">允许您覆盖默认的缓存上下文，以便相对于某个路径生成缓存。默认情况下，它将使用绝对路径。</td>
</tr>
<tr>
<td align="center"><strong><code>cacheKey</code></strong></td>
<td align="center"><code>&#123;Function(options, request) -&gt; &#123;String&#125;&#125;</code></td>
<td align="center"><code>undefined</code></td>
<td align="left">允许您覆盖默认的缓存键生成器。</td>
</tr>
<tr>
<td align="center"><strong><code>cacheDirectory</code></strong></td>
<td align="center"><code>&#123;String&#125;</code></td>
<td align="center"><code>findCacheDir(&#123; name: &#39;cache-loader&#39; &#125;) or os.tmpdir()</code></td>
<td align="left">提供一个缓存目录，其中应存储缓存项（用于默认的读写实现）。</td>
</tr>
<tr>
<td align="center"><strong><code>cacheIdentifier</code></strong></td>
<td align="center"><code>&#123;String&#125;</code></td>
<td align="center"><code>cache-loader:&#123;version&#125; &#123;process.env.NODE_ENV&#125;</code></td>
<td align="left">提供一个无效标识符，用于生成哈希值。您可以将其用于加载器的额外依赖项（用于默认的读写实现）</td>
</tr>
<tr>
<td align="center"><strong><code>compare</code></strong></td>
<td align="center"><code>&#123;Function(stats, dep) -&gt; &#123;Boolean&#125;&#125;</code></td>
<td align="center"><code>undefined</code></td>
<td align="left">允许您覆盖缓存的依赖项与正在读取的依赖项之间的默认比较函数。返回 <code>true</code> 以使用缓存的资源。</td>
</tr>
<tr>
<td align="center"><strong><code>precision</code></strong></td>
<td align="center"><code>&#123;Number&#125;</code></td>
<td align="center"><code>0</code></td>
<td align="left">在将这些参数传递给比较函数之前，使用此毫秒数对<code>stats</code>和<code>dep</code>的<code>mtime</code>进行四舍五入。</td>
</tr>
<tr>
<td align="center"><strong><code>read</code></strong></td>
<td align="center"><code>&#123;Function(cacheKey, callback) -&gt; &#123;void&#125;&#125;</code></td>
<td align="center"><code>undefined</code></td>
<td align="left">允许您覆盖从文件中读取默认缓存数据的函数。</td>
</tr>
<tr>
<td align="center"><strong><code>readOnly</code></strong></td>
<td align="center"><code>&#123;Boolean&#125;</code></td>
<td align="center"><code>false</code></td>
<td align="left">允许您覆盖默认值，并使缓存只读（在某些环境中很有用，您不希望更新缓存，而只是从中读取）。</td>
</tr>
<tr>
<td align="center"><strong><code>write</code></strong></td>
<td align="center"><code>&#123;Function(cacheKey, data, callback) -&gt; &#123;void&#125;&#125;</code></td>
<td align="center"><code>undefined</code></td>
<td align="left">允许您覆盖将默认缓存数据写入文件（例如Redis，memcached）的函数。</td>
</tr>
</tbody></table>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><h4 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h4><p><strong>webpack.config.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;cache-loader&#x27;</span>, <span class="string">&#x27;babel-loader&#x27;</span>],</span><br><span class="line">        <span class="attr">include</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;src&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在基础示例中，<code>cache-loader</code> 被用于缓存对 <code>.js</code> 文件的处理结果。当文件内容发生变化时，缓存将被无效化，并且会重新处理文件。这种缓存机制可以显著提高构建速度，特别是当处理大量未更改的文件时。</p>
<h4 id="数据库集成"><a href="#数据库集成" class="headerlink" title="数据库集成"></a>数据库集成</h4><p><strong>webpack.config.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 或者使用其他数据库客户端 - memcached, mongodb, ...</span></span><br><span class="line"><span class="keyword">const</span> redis = <span class="built_in">require</span>(<span class="string">&#x27;redis&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 连接到客户端</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BUILD_CACHE_TIMEOUT</span> = <span class="number">24</span> * <span class="number">3600</span>; <span class="comment">// 1天</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">digest</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> crypto</span><br><span class="line">    .<span class="title function_">createHash</span>(<span class="string">&#x27;md5&#x27;</span>)</span><br><span class="line">    .<span class="title function_">update</span>(str)</span><br><span class="line">    .<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成自定义缓存键</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cacheKey</span>(<span class="params">options, request</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`build:cache:<span class="subst">$&#123;digest(request)&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数据库读取数据并解析</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">key, callback</span>) &#123;</span><br><span class="line">  client.<span class="title function_">get</span>(key, <span class="function">(<span class="params">err, result</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">callback</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Key <span class="subst">$&#123;key&#125;</span> not found`</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(result);</span><br><span class="line">      <span class="title function_">callback</span>(<span class="literal">null</span>, data);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="title function_">callback</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在cacheKey下将数据写入数据库</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">key, data, callback</span>) &#123;</span><br><span class="line">  client.<span class="title function_">set</span>(key, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data), <span class="string">&#x27;EX&#x27;</span>, <span class="variable constant_">BUILD_CACHE_TIMEOUT</span>, callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;cache-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              cacheKey,</span><br><span class="line">              read,</span><br><span class="line">              write,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">include</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;src&#x27;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>ache-loader</code> 被配置为使用自定义的读取和写入函数，这些函数将数据存储在 <code>Redis</code> 数据库中。通过 <code>cacheKey</code> 函数，可以为每个请求生成一个唯一的缓存键。<code>read</code> 函数从数据库中读取缓存数据，并将其解析为 <code>JavaScript</code> 对象。<code>write</code> 函数将处理后的数据写入数据库，并设置了一个过期时间（在这种情况下为 <code>1</code> 天）。</p>
<p>通过这种方式，缓存数据可以在构建过程中跨多个运行实例共享，并且可以持久化存储，即使 <code>webpack</code> 构建进程重启也不会丢失。这可以进一步提高构建速度，特别是在大型项目中，并且可以在多个构建任务之间共享缓存数据。</p>
<p>翻译: <a href="https://www.npmjs.com/package/cache-loader">cache-loader</a></p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/loader/" rel="tag">loader</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/translate/" rel="tag">translate</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li></ul>

        <a data-url="https://hankliu62.github.io/2023/01/10/cache-loader/" data-id="cluz1as950001qnq9hisqhrmd" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-offscreen-canvas" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2022/12/08/offscreen-canvas/" class="article-date">
  <time datetime="2022-12-08T12:12:26.000Z" itemprop="datePublished">2022-12-08</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/12/08/offscreen-canvas/">OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="OffscreenCanvas-离屏Canvas-—-使用Web-Worker提高你的Canvas运行速度"><a href="#OffscreenCanvas-离屏Canvas-—-使用Web-Worker提高你的Canvas运行速度" class="headerlink" title="OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度"></a>OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度</h2><p>OffscreenCanvas提供了一个可以脱离屏幕渲染的canvas对象。</p>
<p>有了离屏Canvas，你可以不用在你的主线程中绘制图像了！</p>
<p>Canvas 是一个非常受欢迎的表现方式，同时也是WebGL的入口。它能绘制图形，图片，展示动画，甚至是处理视频内容。它经常被用来在富媒体web应用中创建炫酷的用户界面或者是制作在线（web）游戏。</p>
<p>它是非常灵活的，这意味着绘制在Canvas的内容可以被编程。JavaScript就提供了Canvas的系列API。这些给了Canvas非常好的灵活度。</p>
<p>但同时，在一些现代化的web站点，脚本解析运行是实现流畅用户反馈的最大的问题之一。因为Canvas计算和渲染和用户操作响应都发生在同一个线程中，在动画中（有时候很耗时）的计算操作将会导致App卡顿，降低用户体验。</p>
<p>幸运的是, <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/OffscreenCanvas">OffscreenCanvas</a> 离屏Canvas可以非常棒的解决这个麻烦！</p>
<p>到目前为止，Canvas的绘制功能都与<code>&lt;canvas&gt;</code>标签绑定在一起，这意味着Canvas API和DOM是耦合的。而OffscreenCanvas，正如它的名字一样，通过将Canvas移出屏幕来解耦了DOM和Canvas API。</p>
<p>由于这种解耦，OffscreenCanvas的渲染与DOM完全分离了开来，并且比普通Canvas速度提升了一些，而这只是因为两者（Canvas和DOM）之间没有同步。但更重要的是，将两者分离后，Canvas将可以在Web Worker中使用，即使在Web Worker中没有DOM。这给Canvas提供了更多的可能性。</p>
<h3 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h3><p>这是一个实验中的功能<br>此功能某些浏览器尚在开发中，请参考浏览器兼容性表格以得到在不同浏览器中适合使用的前缀。由于该功能对应的标准文档可能被重新修订，所以在未来版本的浏览器中该功能的语法和行为可能随之改变。</p>
<p>支持浏览器如下图所示：</p>
<p><img src="https://user-images.githubusercontent.com/8088864/126027990-d476b78e-e6c9-4438-998d-7ccc4ae79f8b.png" alt="OffscreenCanvas兼容性"></p>
<h3 id="在Worker中使用OffscreenCanvas"><a href="#在Worker中使用OffscreenCanvas" class="headerlink" title="在Worker中使用OffscreenCanvas"></a>在Worker中使用OffscreenCanvas</h3><p>它在窗口环境和web worker环境均有效。</p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API">Workers</a> 是一个Web版的线程——它允许你在幕后运行你的代码。将你的一部分代码放到Worker中可以给你的主线程更多的空闲时间，这可以提高你的用户体验度。就像其没有DOM一样，直到现在，在Worker中都没有Canvas API。</p>
<p>而OffscreenCanvas并不依赖DOM，所以在Worker中Canvas API可以被某种方法来代替。下面是我在Worker中用OffscreenCanvas来计算渐变颜色的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: worker.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getGradientColor</span>(<span class="params">percent</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> canvas = <span class="keyword">new</span> <span class="title class_">OffscreenCanvas</span>(<span class="number">100</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> gradient = ctx.<span class="title function_">createLinearGradient</span>(<span class="number">0</span>, <span class="number">0</span>, canvas.<span class="property">width</span>, <span class="number">0</span>);</span><br><span class="line">    gradient.<span class="title function_">addColorStop</span>(<span class="number">0</span>, <span class="string">&#x27;red&#x27;</span>);</span><br><span class="line">    gradient.<span class="title function_">addColorStop</span>(<span class="number">1</span>, <span class="string">&#x27;blue&#x27;</span>);</span><br><span class="line">    ctx.<span class="property">fillStyle</span> = gradient;</span><br><span class="line">    ctx.<span class="title function_">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, ctx.<span class="property">canvas</span>.<span class="property">width</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> imgd = ctx.<span class="title function_">getImageData</span>(<span class="number">0</span>, <span class="number">0</span>, ctx.<span class="property">canvas</span>.<span class="property">width</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> colors = imgd.<span class="property">data</span>.<span class="title function_">slice</span>(percent * <span class="number">4</span>, percent * <span class="number">4</span> + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`rgba(<span class="subst">$&#123;colors[<span class="number">0</span>]&#125;</span>, <span class="subst">$&#123;colors[<span class="number">1</span>]&#125;</span>, <span class="subst">$&#123;colors[<span class="number">2</span>]&#125;</span>, <span class="subst">$&#123;colors[<span class="number">3</span>]&#125;</span>)`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getGradientColor</span>(<span class="number">40</span>);  <span class="comment">// rgba(152, 0, 104, 255)</span></span><br></pre></td></tr></table></figure>

<h3 id="不要阻塞主线程"><a href="#不要阻塞主线程" class="headerlink" title="不要阻塞主线程"></a>不要阻塞主线程</h3><p>当我们将大量的计算移到Worker中运行时，可以释放主线程上的资源，这很有意思。我们可以使用transferControlToOffscreen 方法将常规的Canvas映射到OffscreenCanvas实例上。之后所有应用于OffscreenCanvas的操作将自动呈现在在源Canvas上。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;myCanvas&quot;</span> <span class="attr">width</span>=<span class="string">&quot;600&quot;</span> <span class="attr">height</span>=<span class="string">&quot;500&quot;</span> <span class="attr">style</span>=<span class="string">&quot;border:1px solid #d3d3d3;&quot;</span>&gt;</span></span><br><span class="line">  Your browser does not support the HTML5 canvas tag.</span><br><span class="line"><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myCanvas&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// var context = canvas.getContext(&quot;2d&quot;);</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 画线</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.moveTo(100, 100);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(300, 100);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(300, 200);</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 画第二条线</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 画第二条线</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.moveTo(100, 300);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(300, 300);</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 最后要描边才会出效果</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.stroke();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 创建一张新的玻璃纸</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.beginPath();</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 画第三条线</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.moveTo(400, 100);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(400, 300);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(500, 300);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(500, 200);</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 只要执行stroke，都会玻璃纸上的图形重复印刷一次</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.stroke();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 填充</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.fill();</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.fillStyle = &quot;gray&quot;;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 设置描边色</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.strokeStyle = &quot;red&quot;; // 颜色的写法和css写法是一样的</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.stroke();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //填充</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //设置填充色</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.fillStyle = &quot;yellowgreen&quot;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.fill();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //把路径闭合</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.closePath();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //设置线条的粗细， 不需要加px</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineWidth = 15;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //线条的头部的设置</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineCap = &quot;round&quot;; //默认是butt， 记住round</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 注: 如果将canvas转化成离屏canvas时，就不能使用原canvas的cantext来绘制图案，否则会报错，已经绘制了的canvas不同通过transferControlToOffscreen转换成OffscreenCanvas</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// Uncaught DOMException: Failed to execute &#x27;transferControlToOffscreen&#x27; on &#x27;HTMLCanvasElement&#x27;: Cannot transfer control from a canvas that has a rendering context.</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> offscreen = canvas.<span class="title function_">transferControlToOffscreen</span>();</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;worker.js&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">worker.<span class="title function_">postMessage</span>(&#123; <span class="attr">canvas</span>: offscreen &#125;, [offscreen]);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>OffscreenCanvas 是可转移的，除了将其指定为传递信息中的字段之一以外，还需要将其作为postMessage（传递信息给Worker的方法）中的第二个参数传递出去，以便可以在Worker线程的context（上下文）中使用它。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// worker.js</span></span><br><span class="line"></span><br><span class="line">self.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取传送过来的离屏Canvas(OffscreenCanvas)</span></span><br><span class="line">  <span class="keyword">var</span> canvas = event.<span class="property">data</span>.<span class="property">canvas</span>;</span><br><span class="line">  <span class="keyword">var</span> context = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 画一个曲径球体</span></span><br><span class="line">  <span class="keyword">var</span> c1 = &#123;<span class="attr">x</span>: <span class="number">240</span>, <span class="attr">y</span>: <span class="number">160</span>, <span class="attr">r</span>: <span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">var</span> c2 = &#123;<span class="attr">x</span>: <span class="number">300</span>, <span class="attr">y</span>: <span class="number">200</span>, <span class="attr">r</span>: <span class="number">120</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> gradient = context.<span class="title function_">createRadialGradient</span>(c1.<span class="property">x</span>, c1.<span class="property">y</span>, c1.<span class="property">r</span>, c2.<span class="property">x</span>, c2.<span class="property">y</span>, c2.<span class="property">r</span>);</span><br><span class="line">  gradient.<span class="title function_">addColorStop</span>(<span class="number">1</span>, <span class="string">&quot;gray&quot;</span>);</span><br><span class="line">  gradient.<span class="title function_">addColorStop</span>(<span class="number">0</span>, <span class="string">&quot;lightgray&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//2. 将渐变对象设为填充色</span></span><br><span class="line">  context.<span class="property">fillStyle</span> = gradient;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//3. 画圆并填充</span></span><br><span class="line">  context.<span class="title function_">arc</span>(c2.<span class="property">x</span>, c2.<span class="property">y</span>, c2.<span class="property">r</span>, <span class="number">0</span>, <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>);</span><br><span class="line">  context.<span class="title function_">fill</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下所示:</p>
<p><img src="https://user-images.githubusercontent.com/8088864/126027866-d78a65fc-8f0f-4a7e-9adf-7eb09a03b956.png" alt="WebWorker中OffscreenCanvas绘制径向渐变画球"></p>
<p>任务繁忙的主线程也不会影响在Worker上运行的动画。所以即使主线程非常繁忙，你也可以通过此功能来避免掉帧并保证流畅的动画</p>
<h3 id="WebRTC的YUV媒体流数据的离屏渲染"><a href="#WebRTC的YUV媒体流数据的离屏渲染" class="headerlink" title="WebRTC的YUV媒体流数据的离屏渲染"></a>WebRTC的YUV媒体流数据的离屏渲染</h3><p>从 WebRTC 中拿到的是 YUV 的原始视频流，将原始的 YUV 视频帧直接转发过来，通过第三方库直接在 Cavans 上渲染。</p>
<p>可以使用<a href="https://github.com/brion/yuv-canvas">yuv-canvas</a>和<a href="https://github.com/brion/yuv-buffer">yuv-buffer</a>第三方库来渲染YUV的原始视频流。</p>
<h4 id="主进程render-js"><a href="#主进程render-js" class="headerlink" title="主进程render.js"></a>主进程render.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">__esModule</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">var</span> isEqual = <span class="built_in">require</span>(<span class="string">&#x27;lodash.isequal&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">YUVBuffer</span> = <span class="built_in">require</span>(<span class="string">&#x27;yuv-buffer&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">YUVCanvas</span> = <span class="built_in">require</span>(<span class="string">&#x27;yuv-canvas&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Renderer</span> = <span class="comment">/** <span class="doctag">@class</span> */</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">Renderer</span>(<span class="params">workSource</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_sendCanvas</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            _this.<span class="property">canvasSent</span> = <span class="literal">true</span>;</span><br><span class="line">            _this.<span class="property">worker</span> &amp;&amp; _this.<span class="property">worker</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;constructor&#x27;</span>,</span><br><span class="line">                <span class="attr">data</span>: &#123;</span><br><span class="line">                    <span class="attr">canvas</span>: _this.<span class="property">offCanvas</span>,</span><br><span class="line">                    <span class="attr">id</span>: (_this.<span class="property">element</span> &amp;&amp; _this.<span class="property">element</span>.<span class="property">id</span>) || (<span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">slice</span>(<span class="number">2</span>) + <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">slice</span>(<span class="number">2</span>))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, [_this.<span class="property">offCanvas</span>]);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 判断使用渲染的方式</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_checkRendererWay</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">workerReady</span> &amp;&amp; _this.<span class="property">worker</span> &amp;&amp; _this.<span class="property">offCanvas</span> &amp;&amp; _this.<span class="property">enableWorker</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;worker&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;software&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// workerCanvas渲染</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_workDrawFrame</span> = <span class="keyword">function</span> (<span class="params">width, height, yUint8Array, uUint8Array, vUint8Array</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">canvasWrapper</span> &amp;&amp; _this.<span class="property">canvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> !== <span class="string">&#x27;none&#x27;</span>) &#123;</span><br><span class="line">                _this.<span class="property">canvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">workerCanvasWrapper</span> &amp;&amp; _this.<span class="property">workerCanvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> === <span class="string">&#x27;none&#x27;</span>) &#123;</span><br><span class="line">                _this.<span class="property">workerCanvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            _this.<span class="property">worker</span> &amp;&amp; _this.<span class="property">worker</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;drawFrame&#x27;</span>,</span><br><span class="line">                <span class="attr">data</span>: &#123;</span><br><span class="line">                    <span class="attr">width</span>: width,</span><br><span class="line">                    <span class="attr">height</span>: height,</span><br><span class="line">                    <span class="attr">yUint8Array</span>: yUint8Array,</span><br><span class="line">                    <span class="attr">uUint8Array</span>: uUint8Array,</span><br><span class="line">                    <span class="attr">vUint8Array</span>: vUint8Array</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, [yUint8Array, uUint8Array, vUint8Array]);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 实际渲染Canvas</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_softwareDrawFrame</span> = <span class="keyword">function</span> (<span class="params">width, height, yUint8Array, uUint8Array, vUint8Array</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">workerCanvasWrapper</span> &amp;&amp; _this.<span class="property">workerCanvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> !== <span class="string">&#x27;none&#x27;</span>) &#123;</span><br><span class="line">                _this.<span class="property">workerCanvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">canvasWrapper</span> &amp;&amp; _this.<span class="property">canvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> === <span class="string">&#x27;none&#x27;</span>) &#123;</span><br><span class="line">                _this.<span class="property">canvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> format = <span class="title class_">YUVBuffer</span>.<span class="title function_">format</span>(&#123;</span><br><span class="line">                <span class="attr">width</span>: width,</span><br><span class="line">                <span class="attr">height</span>: height,</span><br><span class="line">                <span class="attr">chromaWidth</span>: width / <span class="number">2</span>,</span><br><span class="line">                <span class="attr">chromaHeight</span>: height / <span class="number">2</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">var</span> y = <span class="title class_">YUVBuffer</span>.<span class="title function_">lumaPlane</span>(format, yUint8Array);</span><br><span class="line">            <span class="keyword">var</span> u = <span class="title class_">YUVBuffer</span>.<span class="title function_">chromaPlane</span>(format, uUint8Array);</span><br><span class="line">            <span class="keyword">var</span> v = <span class="title class_">YUVBuffer</span>.<span class="title function_">chromaPlane</span>(format, vUint8Array);</span><br><span class="line">            <span class="keyword">var</span> frame = <span class="title class_">YUVBuffer</span>.<span class="title function_">frame</span>(format, y, u, v);</span><br><span class="line">            _this.<span class="property">yuv</span>.<span class="title function_">drawFrame</span>(frame);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheCanvasOpts</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">yuv</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ready</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contentMode</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">offCanvas</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">enableWorker</span> = !!workSource;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">enableWorker</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">worker</span> = <span class="keyword">new</span> <span class="title class_">Worker</span>(workSource);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerReady</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvasSent</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">worker</span>.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;[WorkerRenderer]: the renderer worker catch error: &#x27;</span>, evt);</span><br><span class="line">                _this.<span class="property">workerReady</span> = <span class="literal">false</span>;</span><br><span class="line">                _this.<span class="property">enableWorker</span> = <span class="literal">false</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">worker</span>.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> data = evt.<span class="property">data</span>;</span><br><span class="line">                <span class="keyword">switch</span> (data.<span class="property">type</span>) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;ready&#x27;</span>: &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[WorkerRenderer]: the renderer worker was ready&#x27;</span>);</span><br><span class="line">                        _this.<span class="property">workerReady</span> = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">if</span> (_this.<span class="property">offCanvas</span>) &#123;</span><br><span class="line">                            _this.<span class="title function_">_sendCanvas</span>();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;exited&#x27;</span>: &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[WorkerRenderer]: the renderer worker was exited&#x27;</span>);</span><br><span class="line">                        _this.<span class="property">workerReady</span> = <span class="literal">false</span>;</span><br><span class="line">                        _this.<span class="property">enableWorker</span> = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_calcZoom</span> = <span class="keyword">function</span> (<span class="params">vertical, contentMode, width, height, clientWidth, clientHeight</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vertical === <span class="keyword">void</span> <span class="number">0</span>) &#123; vertical = <span class="literal">false</span>; &#125;</span><br><span class="line">        <span class="keyword">if</span> (contentMode === <span class="keyword">void</span> <span class="number">0</span>) &#123; contentMode = <span class="number">0</span>; &#125;</span><br><span class="line">        <span class="keyword">var</span> localRatio = clientWidth / clientHeight;</span><br><span class="line">        <span class="keyword">var</span> tempRatio = width / height;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isNaN</span>(localRatio) || <span class="built_in">isNaN</span>(tempRatio)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!contentMode) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vertical) &#123;</span><br><span class="line">                <span class="keyword">return</span> localRatio &gt; tempRatio ?</span><br><span class="line">                    clientHeight / height : clientWidth / width;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> localRatio &lt; tempRatio ?</span><br><span class="line">                    clientHeight / height : clientWidth / width;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (vertical) &#123;</span><br><span class="line">                <span class="keyword">return</span> localRatio &lt; tempRatio ?</span><br><span class="line">                    clientHeight / height : clientWidth / width;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> localRatio &gt; tempRatio ?</span><br><span class="line">                    clientHeight / height : clientWidth / width;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getBindingElement</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">element</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">bind</span> = <span class="keyword">function</span> (<span class="params">element</span>) &#123;</span><br><span class="line">        <span class="comment">// record element</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> = element;</span><br><span class="line">        <span class="comment">// create container</span></span><br><span class="line">        <span class="keyword">var</span> container = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        container.<span class="property">className</span> += <span class="string">&#x27; video-canvas-container&#x27;</span>;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">assign</span>(container.<span class="property">style</span>, &#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">display</span>: <span class="string">&#x27;flex&#x27;</span>,</span><br><span class="line">            <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">position</span>: <span class="string">&#x27;relative&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> = container;</span><br><span class="line">        element &amp;&amp; element.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">container</span>);</span><br><span class="line">        <span class="comment">// 创建两个canvas，一个在主线程中渲染，如果web worker中的离屏canvas渲染进程出错了，还可以切换到主进程的canvas进行渲染</span></span><br><span class="line">        <span class="keyword">var</span> canvasWrapper = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        canvasWrapper.<span class="property">className</span> += <span class="string">&#x27; video-canvas-wrapper canvas-renderer&#x27;</span>;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">assign</span>(canvasWrapper.<span class="property">style</span>, &#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">position</span>: <span class="string">&#x27;absolute&#x27;</span>,</span><br><span class="line">            <span class="attr">left</span>: <span class="string">&#x27;0px&#x27;</span>,</span><br><span class="line">            <span class="attr">right</span>: <span class="string">&#x27;0px&#x27;</span>,</span><br><span class="line">            <span class="attr">display</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span> = canvasWrapper;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">canvasWrapper</span>);</span><br><span class="line">        <span class="keyword">var</span> workerCanvasWrapper = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        workerCanvasWrapper.<span class="property">className</span> += <span class="string">&#x27; video-canvas-wrapper webworker-renderer&#x27;</span>;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">assign</span>(workerCanvasWrapper.<span class="property">style</span>, &#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">position</span>: <span class="string">&#x27;absolute&#x27;</span>,</span><br><span class="line">            <span class="attr">left</span>: <span class="string">&#x27;0px&#x27;</span>,</span><br><span class="line">            <span class="attr">right</span>: <span class="string">&#x27;0px&#x27;</span>,</span><br><span class="line">            <span class="attr">display</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span> = workerCanvasWrapper;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span>);</span><br><span class="line">        <span class="comment">// create canvas</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvas</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">workerCanvas</span>);</span><br><span class="line">        <span class="comment">// 创建 OffscreenCanvas 对象</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">offCanvas</span> = <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="title function_">transferControlToOffscreen</span>();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">canvasSent</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">offCanvas</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">worker</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">workerReady</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">_sendCanvas</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">yuv</span> = <span class="title class_">YUVCanvas</span>.<span class="title function_">attach</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, &#123; <span class="attr">webGL</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">unbind</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">canvasWrapper</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">workerCanvas</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">canvasWrapper</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">element</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">container</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">worker</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">worker</span>.<span class="title function_">terminate</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerReady</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasSent</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">yuv</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvas</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">offCanvas</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">worker</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">refreshCanvas</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// Not implemented for software renderer</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">updateCanvas</span> = <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (options === <span class="keyword">void</span> <span class="number">0</span>) &#123; options = &#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">rotation</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">mirrorView</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">contentMode</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">clientWidth</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">clientHeight</span>: <span class="number">0</span></span><br><span class="line">        &#125;; &#125;</span><br><span class="line">        <span class="comment">// check if display options changed</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isEqual</span>(<span class="variable language_">this</span>.<span class="property">cacheCanvasOpts</span>, options)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheCanvasOpts</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, options);</span><br><span class="line">        <span class="comment">// check for rotation</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">rotation</span> === <span class="number">0</span> || options.<span class="property">rotation</span> === <span class="number">180</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span> = options.<span class="property">width</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span> = options.<span class="property">height</span>;</span><br><span class="line">            <span class="comment">// canvas 调用 transferControlToOffscreen 方法后无法修改canvas的宽度和高度，只允许修改canvas的style属性</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">width</span> = options.<span class="property">width</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">height</span> = options.<span class="property">height</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">rotation</span> === <span class="number">90</span> || options.<span class="property">rotation</span> === <span class="number">270</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span> = options.<span class="property">width</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span> = options.<span class="property">height</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">height</span> = options.<span class="property">width</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">width</span> = options.<span class="property">height</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Invalid value for rotation. Only support 0, 90, 180, 270&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> transformItems = [];</span><br><span class="line">        transformItems.<span class="title function_">push</span>(<span class="string">&quot;rotateZ(&quot;</span> + options.<span class="property">rotation</span> + <span class="string">&quot;deg)&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> scale = <span class="variable language_">this</span>.<span class="title function_">_calcZoom</span>(options.<span class="property">rotation</span> === <span class="number">90</span> || options.<span class="property">rotation</span> === <span class="number">270</span>, options.<span class="property">contentMode</span>, options.<span class="property">width</span>, options.<span class="property">height</span>, options.<span class="property">clientWidth</span>, options.<span class="property">clientHeight</span>);</span><br><span class="line">        <span class="comment">// transformItems.push(`scale($&#123;scale&#125;)`)</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">zoom</span> = scale;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">zoom</span> = scale;</span><br><span class="line">        <span class="comment">// check for mirror</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">mirrorView</span>) &#123;</span><br><span class="line">            <span class="comment">// this.canvas.style.transform = &#x27;rotateY(180deg)&#x27;;</span></span><br><span class="line">            transformItems.<span class="title function_">push</span>(<span class="string">&#x27;rotateY(180deg)&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (transformItems.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> transform = <span class="string">&quot;&quot;</span> + transformItems.<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">transform</span> = transform;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">transform</span> = transform;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">drawFrame</span> = <span class="keyword">function</span> (<span class="params">imageData</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">ready</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ready</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(imageData.<span class="property">header</span>);</span><br><span class="line">        <span class="comment">// let format = dv.getUint8(0);</span></span><br><span class="line">        <span class="keyword">var</span> mirror = dv.<span class="title function_">getUint8</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> contentWidth = dv.<span class="title function_">getUint16</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> contentHeight = dv.<span class="title function_">getUint16</span>(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">var</span> left = dv.<span class="title function_">getUint16</span>(<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">var</span> top = dv.<span class="title function_">getUint16</span>(<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">var</span> right = dv.<span class="title function_">getUint16</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">var</span> bottom = dv.<span class="title function_">getUint16</span>(<span class="number">12</span>);</span><br><span class="line">        <span class="keyword">var</span> rotation = dv.<span class="title function_">getUint16</span>(<span class="number">14</span>);</span><br><span class="line">        <span class="comment">// let ts = dv.getUint32(16);</span></span><br><span class="line">        <span class="keyword">var</span> width = contentWidth + left + right;</span><br><span class="line">        <span class="keyword">var</span> height = contentHeight + top + bottom;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateCanvas</span>(&#123;</span><br><span class="line">            <span class="attr">width</span>: width, <span class="attr">height</span>: height, <span class="attr">rotation</span>: rotation,</span><br><span class="line">            <span class="attr">mirrorView</span>: !!mirror,</span><br><span class="line">            <span class="attr">contentMode</span>: <span class="variable language_">this</span>.<span class="property">contentMode</span>,</span><br><span class="line">            <span class="attr">clientWidth</span>: <span class="variable language_">this</span>.<span class="property">container</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">clientWidth</span>,</span><br><span class="line">            <span class="attr">clientHeight</span>: <span class="variable language_">this</span>.<span class="property">container</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">clientHeight</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">_checkRendererWay</span>() === <span class="string">&#x27;software&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 实际渲染canvas</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">_softwareDrawFrame</span>(width, height, imageData.<span class="property">yUint8Array</span>, imageData.<span class="property">uUint8Array</span>, imageData.<span class="property">vUint8Array</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">_workDrawFrame</span>(width, height, imageData.<span class="property">yUint8Array</span>, imageData.<span class="property">uUint8Array</span>, imageData.<span class="property">vUint8Array</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空整个Canvas面板</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@memberof</span> <span class="variable">Renderer</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">clearFrame</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">_checkRendererWay</span>() === <span class="string">&#x27;software&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">yuv</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">yuv</span>.<span class="title function_">clear</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">worker</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">worker</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;clearFrame&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setContentMode</span> = <span class="keyword">function</span> (<span class="params">mode</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="keyword">void</span> <span class="number">0</span>) &#123; mode = <span class="number">0</span>; &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contentMode</span> = mode;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Renderer</span>;</span><br><span class="line">&#125;());</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = <span class="title class_">Renderer</span>;</span><br></pre></td></tr></table></figure>

<h4 id="渲染-WebWorker"><a href="#渲染-WebWorker" class="headerlink" title="渲染 WebWorker"></a>渲染 WebWorker</h4><p>具体代码如下所示:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// render worker</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dateFormat = <span class="keyword">function</span>(<span class="params">date, formatter = <span class="string">&#x27;YYYY-MM-DD hh:mm:ss SSS&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!date) &#123;</span><br><span class="line">      <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      time = <span class="keyword">new</span> <span class="title class_">Date</span>(date);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> oDate = &#123;</span><br><span class="line">      <span class="attr">Y</span>: time.<span class="title function_">getFullYear</span>(),</span><br><span class="line">      <span class="attr">M</span>: time.<span class="title function_">getMonth</span>() + <span class="number">1</span>,</span><br><span class="line">      <span class="attr">D</span>: time.<span class="title function_">getDate</span>(),</span><br><span class="line">      <span class="attr">h</span>: time.<span class="title function_">getHours</span>(),</span><br><span class="line">      <span class="attr">m</span>: time.<span class="title function_">getMinutes</span>(),</span><br><span class="line">      <span class="attr">s</span>: time.<span class="title function_">getSeconds</span>(),</span><br><span class="line">      <span class="attr">S</span>: time.<span class="title function_">getMilliseconds</span>()</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> formatter.<span class="title function_">replace</span>(<span class="regexp">/(Y|M|D|h|m|s|S)+/g</span>, <span class="function">(<span class="params">res, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> len = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (res.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">          len = res.<span class="title function_">slice</span>(<span class="number">1</span>, <span class="number">0</span>) === <span class="string">&#x27;Y&#x27;</span> ? <span class="number">4</span> : <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          len = <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          len = <span class="number">3</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">          len = <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          len = <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> (<span class="string">`0<span class="subst">$&#123;oDate[key]&#125;</span>`</span>).<span class="title function_">slice</span>(-len);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> yuv;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-buffer/yuv-buffer.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/shaders.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/depower.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/YCbCr.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/FrameSink.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/SoftwareFrameSink.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/WebGLFrameSink.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/yuv-canvas.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> data = e.<span class="property">data</span>;</span><br><span class="line">      <span class="keyword">switch</span> (data.<span class="property">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;constructor&#x27;</span>:</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;dateFormat(<span class="keyword">new</span> <span class="built_in">Date</span>())&#125;</span> RENDER_WORKER [INFO]: received canvas: `</span>, data.<span class="property">data</span>.<span class="property">canvas</span>, data.<span class="property">data</span>.<span class="property">id</span>);</span><br><span class="line">          yuv = <span class="title class_">YUVCanvas</span>.<span class="title function_">attach</span>(data.<span class="property">data</span>.<span class="property">canvas</span>, &#123; <span class="attr">webGL</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;drawFrame&#x27;</span>:</span><br><span class="line">          <span class="comment">// 考虑是否使用requestAnimationFrame进行渲染，控制每一帧显示的频率</span></span><br><span class="line">          <span class="keyword">const</span> width = data.<span class="property">data</span>.<span class="property">width</span>;</span><br><span class="line">          <span class="keyword">const</span> height = data.<span class="property">data</span>.<span class="property">height</span>;</span><br><span class="line">          <span class="keyword">const</span> yUint8Array = data.<span class="property">data</span>.<span class="property">yUint8Array</span>;</span><br><span class="line">          <span class="keyword">const</span> uUint8Array = data.<span class="property">data</span>.<span class="property">uUint8Array</span>;</span><br><span class="line">          <span class="keyword">const</span> vUint8Array = data.<span class="property">data</span>.<span class="property">vUint8Array</span>;</span><br><span class="line">          <span class="keyword">const</span> format = <span class="title class_">YUVBuffer</span>.<span class="title function_">format</span>(&#123;</span><br><span class="line">            <span class="attr">width</span>: width,</span><br><span class="line">            <span class="attr">height</span>: height,</span><br><span class="line">            <span class="attr">chromaWidth</span>: width / <span class="number">2</span>,</span><br><span class="line">            <span class="attr">chromaHeight</span>: height / <span class="number">2</span></span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">const</span> y = <span class="title class_">YUVBuffer</span>.<span class="title function_">lumaPlane</span>(format, yUint8Array);</span><br><span class="line">          <span class="keyword">const</span> u = <span class="title class_">YUVBuffer</span>.<span class="title function_">chromaPlane</span>(format, uUint8Array);</span><br><span class="line">          <span class="keyword">const</span> v = <span class="title class_">YUVBuffer</span>.<span class="title function_">chromaPlane</span>(format, vUint8Array);</span><br><span class="line">          <span class="keyword">const</span> frame = <span class="title class_">YUVBuffer</span>.<span class="title function_">frame</span>(format, y, u, v);</span><br><span class="line">          yuv &amp;&amp; yuv.<span class="title function_">drawFrame</span>(frame);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;clearFrame&#x27;</span>: &#123;</span><br><span class="line">          yuv &amp;&amp; yuv.<span class="title function_">clear</span>(frame);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;dateFormat(<span class="keyword">new</span> <span class="built_in">Date</span>())&#125;</span> RENDER_WORKER [INFO]: [RendererWorker]: Unknown message: `</span>, data);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    self.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;ready&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    self.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;exited&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;dateFormat(<span class="keyword">new</span> <span class="built_in">Date</span>())&#125;</span> RENDER_WORKER [INFO]: [RendererWorker]: catch error`</span>, error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>如果你对图像绘画使用得非常多，OffscreenCanvas可以有效的提高你APP的性能。它使得Worker可以处理canvas的渲染绘制，让你的APP更好地利用了多核系统。</p>
<p>OffscreenCanvas在Chrome 69中已经不需要开启flag（实验性功能）就可以使用了。它也正在被 Firefox 实现。由于其API与普通canvas元素非常相似，所以你可以轻松地对其进行特征检测并循序渐进地使用它，而不会破坏现有的APP或库的运行逻辑。OffscreenCanvas在任何涉及到图形计算以及动画表现且与DOM关系并不密切（即依赖DOM API不多）的情况下，它都具有性能优势。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/canvas/" rel="tag">canvas</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/html/" rel="tag">html</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webworker/" rel="tag">webworker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/yuv/" rel="tag">yuv</a></li></ul>

        <a data-url="https://hankliu62.github.io/2022/12/08/offscreen-canvas/" data-id="cluz1as9l000tqnq9768aaoiw" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-webwork-postmessage" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2022/07/20/webwork-postmessage/" class="article-date">
  <time datetime="2022-07-20T12:12:26.000Z" itemprop="datePublished">2022-07-20</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/07/20/webwork-postmessage/">WebWorker 和 postMessage 使用指南</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="WebWorker-和-postMessage-使用指南"><a href="#WebWorker-和-postMessage-使用指南" class="headerlink" title="WebWorker 和 postMessage 使用指南"></a>WebWorker 和 postMessage 使用指南</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>在网页开发中，我们通常使用 <code>JavaScript</code> 来处理和响应用户的各种操作。然而，随着网页变得越来越复杂，我们需要执行的任务也变得越来越繁重。这些任务可能包括大量的计算、数据处理、文件读取等。如果我们直接在主线程中执行这些任务，可能会导致页面卡顿、响应变慢，甚至阻塞用户的其他操作。为了解决这个问题，<code>Web Worker</code> 应运而生。</p>
<p><code>JavaScript</code> 语言采用的是单线程模型，也就是说，所有任务只能在一个线程上完成，一次只能做一件事。前面的任务没做完，后面的任务只能等着。随着电脑计算能力的增强，尤其是多核 <code>CPU</code> 的出现，单线程带来很大的不便，无法充分发挥计算机的计算能力。</p>
<p><code>Web Worker</code> 的作用，就是为 <code>JavaScript</code> 创造多线程环境，允许主线程创建 <code>Worker</code> 线程，将一些任务分配给后者运行。在主线程运行的同时，<code>Worker</code> 线程在后台运行，两者互不干扰。等到 <code>Worker</code> 线程完成计算任务，再把结果返回给主线程。这样的好处是，一些计算密集型或高延迟的任务，被 <code>Worker</code> 线程负担了，主线程（通常负责 <code>UI</code> 交互）就会很流畅，不会被阻塞或拖慢。</p>
<p><code>Web Worker</code> 是一种在浏览器后台运行的 <code>JavaScript</code> 线程,<code>Worker</code> 线程一旦新建成功，就会始终运行，它独立于主线程运行，不会阻塞页面的渲染和用户交互，不会被主线程上的活动（比如用户点击按钮、提交表单）打断。这样有利于随时响应主线程的通信。但是，这也造成了 <code>Worker</code> 比较耗费资源，不应该过度使用，而且一旦使用完毕，就应该关闭。</p>
<p><code>Web Worker</code> 有以下几个使用注意点。</p>
<h4 id="（1）同源限制"><a href="#（1）同源限制" class="headerlink" title="（1）同源限制"></a>（1）同源限制</h4><p>分配给 <code>Worker</code> 线程运行的脚本文件，必须与主线程的脚本文件同源。</p>
<h4 id="（2）DOM-限制"><a href="#（2）DOM-限制" class="headerlink" title="（2）DOM 限制"></a>（2）DOM 限制</h4><p><code>Worker</code> 线程所在的全局对象，与主线程不一样，无法读取主线程所在网页的 <code>DOM</code> 对象，也无法使用<code>document</code>、<code>window</code>、<code>parent</code>这些对象。但是，<code>Worker</code> 线程可以<code>navigator</code>对象和<code>location</code>对象。</p>
<h4 id="（3）通信联系"><a href="#（3）通信联系" class="headerlink" title="（3）通信联系"></a>（3）通信联系</h4><p><code>Worker</code> 线程和主线程不在同一个上下文环境，它们不能直接通信，必须通过消息完成。<code>(postMessage)</code></p>
<h4 id="（4）脚本限制"><a href="#（4）脚本限制" class="headerlink" title="（4）脚本限制"></a>（4）脚本限制</h4><p><code>Worker</code> 线程不能执行<code>alert()</code>方法和<code>confirm()</code>方法，但可以使用 <code>XMLHttpRequest</code> 对象发出 AJAX 请求。</p>
<h4 id="（5）文件限制"><a href="#（5）文件限制" class="headerlink" title="（5）文件限制"></a>（5）文件限制</h4><p><code>Worker</code> 线程无法读取本地文件，即不能打开本机的文件系统<code>（file://）</code>，它所加载的脚本，必须来自网络。</p>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><h4 id="主线程"><a href="#主线程" class="headerlink" title="主线程"></a>主线程</h4><p>主线程采用<code>new</code>命令，调用<code>Worker()</code>构造函数，新建一个 <code>Worker</code> 线程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;work.js&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><code>Worker()</code>构造函数的参数是一个脚本文件，该文件就是 <code>Worker</code> 线程所要执行的任务。由于 <code>Worker</code> 不能读取本地文件，所以这个脚本必须来自网络。如果下载没有成功（比如404错误），<code>Worker</code> 就会默默地失败。</p>
<p>然后，主线程调用<code>worker.postMessage()</code>方法，向 <code>Worker</code> 发消息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">worker.<span class="title function_">postMessage</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line">worker.<span class="title function_">postMessage</span>(&#123;<span class="attr">method</span>: <span class="string">&#x27;echo&#x27;</span>, <span class="attr">args</span>: [<span class="string">&#x27;Work&#x27;</span>]&#125;);</span><br><span class="line"><span class="comment">// worker.postMessage() 方法的参数，就是主线程传给 Worker 的数据。它可以是各种数据类型，包括二进制数据。</span></span><br></pre></td></tr></table></figure>

<p>接着，主线程通过<code>worker.onmessage</code>指定监听函数，接收子线程发回来的消息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">worker.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Received message &#x27;</span> + event.<span class="property">data</span>);</span><br><span class="line">  <span class="title function_">doSomething</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doSomething</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 执行任务</span></span><br><span class="line">  worker.<span class="title function_">postMessage</span>(<span class="string">&#x27;Work done!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中，事件对象的data属性可以获取 <code>Worker</code> 发来的数据。</p>
<p><code>Worker</code> 完成任务以后，主线程就可以把它关掉。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker.<span class="title function_">terminate</span>();</span><br></pre></td></tr></table></figure>

<h4 id="Worker-线程"><a href="#Worker-线程" class="headerlink" title="Worker 线程"></a>Worker 线程</h4><p><code>Worker</code> 线程内部需要有一个监听函数，监听<code>message</code>事件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  self.<span class="title function_">postMessage</span>(<span class="string">&#x27;You said: &#x27;</span> + e.<span class="property">data</span>);</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>上面代码中，<code>self</code>代表子线程自身，即子线程的全局对象。因此，等同于下面两种写法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写法一</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">postMessage</span>(<span class="string">&#x27;You said: &#x27;</span> + e.<span class="property">data</span>);</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写法二</span></span><br><span class="line"><span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="title function_">postMessage</span>(<span class="string">&#x27;You said: &#x27;</span> + e.<span class="property">data</span>);</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>除了使用<code>self.addEventListener()</code>指定监听函数，也可以使用<code>self.onmessage</code>指定。监听函数的参数是一个事件对象，它的data属性包含主线程发来的数据。<code>self.postMessage()</code>方法用来向主线程发送消息。</p>
<p>根据主线程发来的数据，<code>Worker</code> 线程可以调用不同的方法，下面是一个例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> data = e.<span class="property">data</span>;</span><br><span class="line">  <span class="keyword">switch</span> (data.<span class="property">cmd</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;start&#x27;</span>:</span><br><span class="line">      self.<span class="title function_">postMessage</span>(<span class="string">&#x27;WORKER STARTED: &#x27;</span> + data.<span class="property">msg</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;stop&#x27;</span>:</span><br><span class="line">      self.<span class="title function_">postMessage</span>(<span class="string">&#x27;WORKER STOPPED: &#x27;</span> + data.<span class="property">msg</span>);</span><br><span class="line">      self.<span class="title function_">close</span>(); <span class="comment">// Terminates the worker.</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      self.<span class="title function_">postMessage</span>(<span class="string">&#x27;Unknown command: &#x27;</span> + data.<span class="property">msg</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>上面代码中，<code>self.close()</code>用于在 <code>Worker</code> 内部关闭自身。</p>
<h4 id="Worker-加载脚本"><a href="#Worker-加载脚本" class="headerlink" title="Worker 加载脚本"></a>Worker 加载脚本</h4><p><code>Worker</code> 内部如果要加载其他脚本，有一个专门的方法<code>importScripts()</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">importScripts(<span class="string">&#x27;script1.js&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>该方法可以同时加载多个脚本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">importScripts(<span class="string">&#x27;script1.js&#x27;</span>, <span class="string">&#x27;script2.js&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Worker-错误处理"><a href="#Worker-错误处理" class="headerlink" title="Worker 错误处理"></a>Worker 错误处理</h4><p>主线程可以监听 <code>Worker</code> 是否发生错误。如果发生错误，<code>Worker</code> 会触发主线程的error事件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">worker.<span class="title function_">onerror</span>(<span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>([</span><br><span class="line">    <span class="string">&#x27;ERROR: Line &#x27;</span>, e.<span class="property">lineno</span>, <span class="string">&#x27; in &#x27;</span>, e.<span class="property">filename</span>, <span class="string">&#x27;: &#x27;</span>, e.<span class="property">message</span></span><br><span class="line">  ].<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">worker.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>Worker</code> 内部也可以监听error事件。</p>
<h4 id="关闭-Worker"><a href="#关闭-Worker" class="headerlink" title="关闭 Worker"></a>关闭 Worker</h4><p>使用完毕，为了节省系统资源，必须关闭 <code>Worker</code> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主线程</span></span><br><span class="line">worker.<span class="title function_">terminate</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Worker 线程</span></span><br><span class="line">self.<span class="title function_">close</span>();</span><br></pre></td></tr></table></figure>

<h3 id="数据通信"><a href="#数据通信" class="headerlink" title="数据通信"></a>数据通信</h3><p>前面说过，主线程与 <code>Worker</code> 之间的通信内容，可以是文本，也可以是对象。需要注意的是，这种通信是拷贝关系，即是传值而不是传址，<code>Worker</code> 对通信内容的修改，不会影响到主线程。事实上，浏览器内部的运行机制是，先将通信内容串行化，然后把串行化后的字符串发给 <code>Worker</code>，后者再将它还原。</p>
<p>主线程与 <code>Worker</code> 之间也可以交换二进制数据，比如 <code>File</code>、<code>Blob</code>、<code>ArrayBuffer</code> 等类型，也可以在线程之间发送。下面是一个例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主线程</span></span><br><span class="line"><span class="keyword">var</span> uInt8Array = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; uInt8Array.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">  uInt8Array[i] = i * <span class="number">2</span>; <span class="comment">// [0, 2, 4, 6, 8,...]</span></span><br><span class="line">&#125;</span><br><span class="line">worker.<span class="title function_">postMessage</span>(uInt8Array);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Worker 线程</span></span><br><span class="line">self.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> uInt8Array = e.<span class="property">data</span>;</span><br><span class="line">  <span class="title function_">postMessage</span>(<span class="string">&#x27;Inside worker.js: uInt8Array.toString() = &#x27;</span> + uInt8Array.<span class="title function_">toString</span>());</span><br><span class="line">  <span class="title function_">postMessage</span>(<span class="string">&#x27;Inside worker.js: uInt8Array.byteLength = &#x27;</span> + uInt8Array.<span class="property">byteLength</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但是，拷贝方式发送二进制数据，会造成性能问题。比如，主线程向 <code>Worker</code> 发送一个 <code>500MB</code> 文件，默认情况下浏览器会生成一个原文件的拷贝。为了解决这个问题，<code>JavaScript</code> 允许主线程把二进制数据直接转移给子线程，但是一旦转移，主线程就无法再使用这些二进制数据了，这是为了防止出现多个线程同时修改数据的麻烦局面。这种转移数据的方法，叫做<code>Transferable Objects</code>。这使得主线程可以快速把数据交给 <code>Worker</code>，对于影像处理、声音处理、<code>3D</code> 运算等就非常方便了，不会产生性能负担。</p>
<p>如果要直接转移数据的控制权，就要使用下面的写法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Transferable Objects 格式</span></span><br><span class="line">worker.<span class="title function_">postMessage</span>(arrayBuffer, [arrayBuffer]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例子</span></span><br><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">1</span>);</span><br><span class="line">worker.<span class="title function_">postMessage</span>(ab, [ab]);</span><br></pre></td></tr></table></figure>

<h3 id="同页面的-Web-Worker"><a href="#同页面的-Web-Worker" class="headerlink" title="同页面的 Web Worker"></a>同页面的 Web Worker</h3><p>通常情况下，<code>Worker</code> 载入的是一个单独的 <code>JavaScript</code> 脚本文件，但是也可以载入与主线程在同一个网页的代码。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">&quot;worker&quot;</span> <span class="attr">type</span>=<span class="string">&quot;app/worker&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">postMessage</span>(<span class="string">&#x27;some message&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      &#125;, <span class="literal">false</span>);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面是一段嵌入网页的脚本，注意必须指定<code>&lt;script&gt;</code>标签的type属性是一个浏览器不认识的值，上例是<code>app/worker</code>。</p>
<p>然后，读取这一段嵌入页面的脚本，用 <code>Worker</code> 来处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#worker&#x27;</span>).<span class="property">textContent</span>]);</span><br><span class="line"><span class="keyword">var</span> url = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line"><span class="keyword">var</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(url);</span><br><span class="line"></span><br><span class="line">worker.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="comment">// e.data === &#x27;some message&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上面代码中，先将嵌入网页的脚本代码，转成一个二进制对象，然后为这个二进制对象生成 <code>URL</code>，再让 <code>Worker</code> 加载这个 <code>URL</code>。这样就做到了，主线程和 <code>Worker</code> 的代码都在同一个网页上面。</p>
<h3 id="Worker-线程完成轮询"><a href="#Worker-线程完成轮询" class="headerlink" title="Worker 线程完成轮询"></a>Worker 线程完成轮询</h3><p>有时，浏览器需要轮询服务器状态，以便第一时间得知状态改变。这个工作可以放在 <code>Worker</code> 里面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createWorker</span>(<span class="params">f</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="string">&#x27;(&#x27;</span> + f.<span class="title function_">toString</span>() +<span class="string">&#x27;)()&#x27;</span>]);</span><br><span class="line">  <span class="keyword">var</span> url = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">  <span class="keyword">var</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(url);</span><br><span class="line">  <span class="keyword">return</span> worker;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pollingWorker = <span class="title function_">createWorker</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> cache;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">compare</span>(<span class="params"><span class="keyword">new</span>, old</span>) &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setInterval</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;/my-api-endpoint&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> data = res.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_">compare</span>(data, cache)) &#123;</span><br><span class="line">        cache = data;</span><br><span class="line">        self.<span class="title function_">postMessage</span>(data);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">pollingWorker.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// render data</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pollingWorker.<span class="title function_">postMessage</span>(<span class="string">&#x27;init&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>上面代码中，<code>Worker</code> 每秒钟轮询一次数据，然后跟缓存做比较。如果不一致，就说明服务端有了新的变化，因此就要通知主线程。</p>
<h3 id="Worker-新建-Worker"><a href="#Worker-新建-Worker" class="headerlink" title="Worker 新建 Worker"></a>Worker 新建 Worker</h3><p><code>Worker</code> 线程内部还能再新建 <code>Worker</code> 线程（目前只有 <code>Firefox</code> 浏览器支持）。下面的例子是将一个计算密集的任务，分配到10个 <code>Worker</code>。</p>
<p>主线程代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;worker.js&#x27;</span>);</span><br><span class="line">worker.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;result&#x27;</span>).<span class="property">textContent</span> = event.<span class="property">data</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>Worker</code> 线程代码如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// worker.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// settings</span></span><br><span class="line"><span class="keyword">var</span> num_workers = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">var</span> items_per_worker = <span class="number">1000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// start the workers</span></span><br><span class="line"><span class="keyword">var</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> pending_workers = num_workers;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; num_workers; i += <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;core.js&#x27;</span>);</span><br><span class="line">  worker.<span class="title function_">postMessage</span>(i * items_per_worker);</span><br><span class="line">  worker.<span class="title function_">postMessage</span>((i + <span class="number">1</span>) * items_per_worker);</span><br><span class="line">  worker.<span class="property">onmessage</span> = storeResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// handle the results</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">storeResult</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  result += event.<span class="property">data</span>;</span><br><span class="line">  pending_workers -= <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (pending_workers &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="title function_">postMessage</span>(result); <span class="comment">// finished!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中，<code>Worker</code> 线程内部新建了10个 <code>Worker</code> 线程，并且依次向这10个 <code>Worker</code> 发送消息，告知了计算的起点和终点。计算任务脚本的代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core.js</span></span><br><span class="line"><span class="keyword">var</span> start;</span><br><span class="line">onmessage = getStart;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getStart</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  start = event.<span class="property">data</span>;</span><br><span class="line">  onmessage = getEnd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> end;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getEnd</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  end = event.<span class="property">data</span>;</span><br><span class="line">  onmessage = <span class="literal">null</span>;</span><br><span class="line">  <span class="title function_">work</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">work</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = start; i &lt; end; i += <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// perform some complex calculation here</span></span><br><span class="line">    result += <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">postMessage</span>(result);</span><br><span class="line">  <span class="title function_">close</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><h4 id="主线程-1"><a href="#主线程-1" class="headerlink" title="主线程"></a>主线程</h4><p>浏览器原生提供<code>Worker()</code>构造函数，用来供主线程生成 <code>Worker</code> 线程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myWorker = <span class="keyword">new</span> <span class="title class_">Worker</span>(jsUrl, options);</span><br></pre></td></tr></table></figure>

<p><code>Worker()</code>构造函数，可以接受两个参数。第一个参数是脚本的网址（必须遵守同源政策），该参数是必需的，且只能加载 <code>JS</code> 脚本，否则会报错。第二个参数是配置对象，该对象可选。它的一个作用就是指定 <code>Worker</code> 的名称，用来区分多个 <code>Worker</code> 线程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主线程</span></span><br><span class="line"><span class="keyword">var</span> myWorker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;worker.js&#x27;</span>, &#123; name : <span class="string">&#x27;myWorker&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Worker 线程</span></span><br><span class="line">self.<span class="property">name</span> <span class="comment">// myWorker</span></span><br></pre></td></tr></table></figure>

<p><code>Worker()</code>构造函数返回一个 <code>Worker</code> 线程对象，用来供主线程操作 <code>Worker</code>。<code>Worker</code> 线程对象的属性和方法如下。</p>
<ul>
<li><strong>Worker.onerror：</strong>指定 <code>error</code> 事件的监听函数。</li>
<li><strong>Worker.onmessage：</strong>指定 <code>message</code> 事件的监听函数，发送过来的数据在<code>Event.data</code>属性中。</li>
<li><strong>Worker.onmessageerror：</strong>指定 <code>messageerror</code> 事件的监听函数。发送的数据无法序列化成字符串时，会触发这个事件。</li>
<li><strong>Worker.postMessage()：</strong>向 <code>Worker</code> 线程发送消息。</li>
<li><strong>Worker.terminate()：</strong>立即终止 <code>Worker</code> 线程。</li>
</ul>
<h4 id="Worker-线程-1"><a href="#Worker-线程-1" class="headerlink" title="Worker 线程"></a>Worker 线程</h4><p><code>Web Worker</code> 有自己的全局对象，不是主线程的<code>window</code>，而是一个专门为 <code>Worker</code> 定制的全局对象。因此定义在<code>window</code>上面的对象和方法不是全部都可以使用。</p>
<p><code>Worker</code> 线程有一些自己的全局属性和方法。</p>
<ul>
<li><strong>self.name：</strong><code>Worker</code> 的名字。该属性只读，由构造函数指定。</li>
<li><strong>self.onmessage：</strong>指定 <code>message</code> 事件的监听函数。</li>
<li><strong>self.onmessageerror：</strong>指定 <code>messageerror</code> 事件的监听函数。发送的数据无法序列化成字符串时，会触发这个事件。</li>
<li><strong>self.close()：</strong>关闭 <code>Worker</code> 线程。</li>
<li><strong>self.postMessage()：</strong>向产生这个 <code>Worker</code> 线程发送消息。</li>
<li><strong>self.importScripts()：</strong>加载 <code>JS</code> 脚本。</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>Web Workers适用于以下场景：</p>
<ol>
<li><strong>大量数据处理：</strong>如表格、图表等需要处理大量数据的场景，可以将数据处理任务放在 <code>Web Workers</code> 中执行，避免阻塞主线程。</li>
<li><strong>复杂计算：</strong>如图像处理、机器学习等需要执行复杂计算的场景，可以利用 <code>Web Workers</code> 实现并行计算，提高性能。</li>
<li><strong>文件读写：</strong>如读取大文件、处理文件数据等场景，可以使用 <code>Web Workers</code> 在后台进行文件读写操作，避免阻塞主线程。</li>
</ol>
<p>总之，<code>Web Workers</code> 为网页开发提供了一种有效的手段来优化性能和用户体验。通过合理利用 <code>Web Workers</code>，我们可以实现真正的并行处理，使网页更加流畅、响应更快。</p>
<p>来源： <a href="https://www.ruanyifeng.com/blog/2018/07/web-worker.html">https://www.ruanyifeng.com/blog/2018/07/web-worker.html</a></p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/html/" rel="tag">html</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webworker/" rel="tag">webworker</a></li></ul>

        <a data-url="https://hankliu62.github.io/2022/07/20/webwork-postmessage/" data-id="cluz1asah004cqnq9hv146kft" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-nginx-commonly-config" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2022/04/08/nginx-commonly-config/" class="article-date">
  <time datetime="2022-04-08T12:15:26.000Z" itemprop="datePublished">2022-04-08</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/08/nginx-commonly-config/">Nginx常用基础配置详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="Nginx常用基础配置详解"><a href="#Nginx常用基础配置详解" class="headerlink" title="Nginx常用基础配置详解"></a>Nginx常用基础配置详解</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Nginx 是一个高性能的开源 Web 服务器，它不仅可以作为 HTTP 服务器使用，还可以用作反向代理服务器、负载均衡器、缓存服务器等。在实际应用中，正确配置 Nginx 是确保网站稳定性和性能的重要步骤。本文将详细介绍一些常用的 Nginx 基础配置，包括虚拟主机配置、HTTP 重定向、反向代理等内容，并提供详细的示例说明。</p>
<h3 id="虚拟主机配置"><a href="#虚拟主机配置" class="headerlink" title="虚拟主机配置"></a>虚拟主机配置</h3><p>虚拟主机是 Nginx 中非常重要的概念，它允许您在一台服务器上托管多个网站。下面是一个简单的虚拟主机配置示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> example.com www.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span> /var/www/example;</span><br><span class="line">    <span class="attribute">index</span> index.html index.htm;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>**<code>listen 80;</code>**：指定 <code>Nginx</code> 监听的端口号。</li>
<li>**<code>server_name example.com www.example.com;</code>**：指定虚拟主机的域名。</li>
<li>**<code>root /var/www/example;</code>**：指定网站的根目录。</li>
<li>**<code>index index.html index.htm;</code>**：指定默认的索引文件。</li>
<li>**<code>location /</code>**：配置请求的 <code>URL</code> 路径。</li>
<li>**<code>try_files $uri $uri/ /index.html;</code>**：尝试寻找与请求 <code>URI</code> 匹配的文件，如果找不到则返回 <code>index.html</code>。</li>
</ul>
<h3 id="HTTP-重定向"><a href="#HTTP-重定向" class="headerlink" title="HTTP 重定向"></a>HTTP 重定向</h3><p>HTTP 重定向是将一个 URL 请求重定向到另一个 URL 的过程。下面是一个简单的 HTTP 重定向配置示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> http://example.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个配置会将所有访问 <code>www.example.com</code> 的请求重定向到 <code>example.com</code>，保证网站的访问统一性。</p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p><code>Nginx</code> 反向代理是将客户端的请求转发给后端服务器的过程，常用于负载均衡和隐藏后端服务器。下面是一个简单的反向代理配置示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> www.example.com;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://backend_server;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>**<code>proxy_pass http://backend_server;</code>**：指定后端服务器的地址。</li>
<li>**<code>proxy_set_header</code>**：设置代理请求的头部信息，如 <code>Host</code>、<code>X-Real-IP</code>、<code>X-Forwarded-For</code> 等。</li>
</ul>
<h3 id="SSL-TLS-配置"><a href="#SSL-TLS-配置" class="headerlink" title="SSL&#x2F;TLS 配置"></a>SSL&#x2F;TLS 配置</h3><p><code>SSL/TLS</code> 是保护网站安全的重要手段，<code>Nginx</code> 提供了丰富的 <code>SSL/TLS</code> 配置选项。下面是一个简单的 <code>SSL/TLS</code> 配置示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span>                      <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span>                 www.example.com;</span><br><span class="line">  <span class="comment"># 将 http 重定向转移到 https</span></span><br><span class="line">  <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span>                      <span class="number">443</span> ssl;</span><br><span class="line">  <span class="attribute">server_name</span>                 www.example.com;</span><br><span class="line">  <span class="attribute">ssl_certificate</span>             /etc/nginx/ssl/www.example.com.pem;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span>         /etc/nginx/ssl/www.example.com.key;</span><br><span class="line">  <span class="attribute">ssl_session_timeout</span>         <span class="number">10m</span>;</span><br><span class="line">  <span class="attribute">ssl_ciphers</span>                 ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">  <span class="attribute">ssl_protocols</span>               TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">  <span class="attribute">ssl_prefer_server_ciphers</span>   <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span>                    /var/nginx/html;</span><br><span class="line">    <span class="attribute">index</span>                   index.html index.htm index.md;</span><br><span class="line">    <span class="attribute">try_files</span>               <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>**<code>listen 443 ssl;</code>**：指定监听的端口号，并开启 SSL。</li>
<li>**<code>ssl_certificate 和 ssl_certificate_key</code>**：指定 SSL 证书和私钥的路径。</li>
<li>**<code>ssl_protocols</code>**：指定允许的 SSL&#x2F;TLS 协议版本。</li>
<li>**<code>ssl_prefer_server_ciphers on;</code>**：优先使用服务器端的加密算法。</li>
<li>**<code>ssl_ciphers</code>**：指定允许的加密算法。</li>
</ul>
<h3 id="隐藏-Nginx-版本信息"><a href="#隐藏-Nginx-版本信息" class="headerlink" title="隐藏 Nginx 版本信息"></a>隐藏 Nginx 版本信息</h3><p>要隐藏 <code>Nginx</code> 版本信息，您可以通过在配置文件中进行相应的设置来实现。具体来说，您需要修改 <code>nginx.conf</code> 文件，使用 <code>server_tokens off;</code> 指令来关闭 <code>Nginx</code> 的版本号显示。以下是如何进行配置的示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将上述配置添加到 <code>nginx.conf</code> 文件的 <code>http</code> 块中即可禁用 <code>Nginx</code> 版本号显示。</p>
<h3 id="禁止-ip-直接访问-80-端口"><a href="#禁止-ip-直接访问-80-端口" class="headerlink" title="禁止 ip 直接访问 80 端口"></a>禁止 ip 直接访问 80 端口</h3><p>要禁止直接通过 <code>IP</code> 地址访问 <code>80</code> 端口，您可以通过 <code>Nginx</code> 配置文件进行相应的设置。具体来说，您可以配置一个默认的 <code>server</code> 块，用于捕获所有请求，并返回一个错误页面或者重定向到其他地址。以下是一个示例配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">  <span class="attribute">server_name</span> _;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">return</span> <span class="number">444</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个配置中：</p>
<ul>
<li>**<code>listen 80 default_server;</code>**：指定 <code>Nginx</code> 监听默认的 <code>HTTP</code> 端口，并将此 <code>server</code> 块标记为默认服务器。</li>
<li>**<code>server_name _;</code>**： 表示该 <code>server</code> 块将匹配所有请求。</li>
<li>**<code>return 444;</code>**： 是一个特殊的 <code>Nginx</code> 返回指令，它会立即关闭客户端连接，相当于不做任何响应。</li>
</ul>
<p>通过这样的配置，当有请求通过 <code>IP</code> 地址直接访问 <code>80</code> 端口时，<code>Nginx</code> 将返回一个 <code>444</code> 错误，不会提供任何内容，从而实现了禁止直接访问 <code>80</code> 端口的目的。</p>
<h3 id="启动-web-服务-react-项目为例"><a href="#启动-web-服务-react-项目为例" class="headerlink" title="启动 web 服务 (react 项目为例)"></a>启动 web 服务 (react 项目为例)</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="comment"># 项目启动端口</span></span><br><span class="line">  <span class="attribute">listen</span>            <span class="number">80</span>;</span><br><span class="line">  <span class="comment"># 域名（localhost）</span></span><br><span class="line">  <span class="attribute">server_name</span>       _;</span><br><span class="line">  <span class="comment"># 禁止 iframe 嵌套</span></span><br><span class="line">  <span class="attribute">add_header</span>        X-Frame-Options SAMEORIGIN;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 访问地址 根路径配置</span></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="comment"># 项目目录</span></span><br><span class="line">    <span class="attribute">root</span>            /var/nginx/html;</span><br><span class="line">    <span class="comment"># 默认读取文件</span></span><br><span class="line">    <span class="attribute">index</span>           index.html;</span><br><span class="line">    <span class="comment"># 配置 history 模式的刷新空白</span></span><br><span class="line">    <span class="attribute">try_files</span>       <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 后缀匹配，解决静态资源找不到问题</span></span><br><span class="line">  <span class="section">location</span> <span class="regexp">~* \.(gif|jpg|jpeg|png|css|js|ico)$</span> &#123;</span><br><span class="line">    <span class="attribute">root</span>            /var/nginx/html/static/;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 图片防盗链</span></span><br><span class="line">  <span class="section">location</span> ~/static/.*\.(jpg|jpeg|png|gif|webp)$ &#123;</span><br><span class="line">    <span class="attribute">root</span>              /var/nginx/html;</span><br><span class="line">    <span class="attribute">valid_referers</span>    <span class="regexp">*.example.com</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">      <span class="attribute">return</span>          <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 访问限制</span></span><br><span class="line">  <span class="section">location</span> /static &#123;</span><br><span class="line">    <span class="attribute">root</span>               /var/nginx/html;</span><br><span class="line">    <span class="comment"># allow 允许</span></span><br><span class="line">    <span class="attribute">allow</span>              <span class="number">39</span>.xxx.xxx.xxx;</span><br><span class="line">    <span class="comment"># deny  拒绝</span></span><br><span class="line">    <span class="attribute">deny</span>               all;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个配置中：</p>
<ul>
<li>**<code>listen 80;</code>**： 指定 Nginx 监听的端口号。</li>
<li>**<code>server_name _;</code>**： 表示该 <code>server</code> 块将匹配所有请求。</li>
<li>**<code>location /</code>**： 配置请求的 · 路径，尝试寻找与请求 <code>URI</code> 匹配的文件，如果找不到则返回 <code>index.html</code>。</li>
<li>**<code>add_header X-Frame-Options SAMEORIGIN;</code>**：设置响应的头部信息 <code>X-Frame-Options</code>，不允许我们的页面嵌套到第三方网页里面。</li>
<li>**<code>root /var/nginx/html;</code>**： 指定网站的根目录，这里是 <code>React</code> 项目构建后的静态文件目录。</li>
<li>**<code>index index.html;</code>**： 指定默认的索引文件。</li>
<li>**<code>try_files $uri $uri/ /index.html;</code>**：尝试寻找与请求 <code>URI</code> 匹配的文件，如果找不到则返回 <code>index.html</code>。</li>
</ul>
<h3 id="一个web服务，配置多个项目-location-匹配路由区别"><a href="#一个web服务，配置多个项目-location-匹配路由区别" class="headerlink" title="一个web服务，配置多个项目 (location 匹配路由区别)"></a>一个web服务，配置多个项目 (location 匹配路由区别)</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span>                <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span>           _;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 主应用</span></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span>                /var/nginx/html/main;</span><br><span class="line">    <span class="attribute">index</span>               index.html;</span><br><span class="line">    <span class="attribute">try_files</span>           <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 子应用一</span></span><br><span class="line">  <span class="section">location</span><span class="regexp"> ^~</span> /user/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span>          http://localhost:8001;</span><br><span class="line">    <span class="attribute">proxy_redirect</span>      <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>    Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>    X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>    X-Forwarded-For</span><br><span class="line">    proxy_set_header    X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 子应用二</span></span><br><span class="line">  <span class="section">location</span><span class="regexp"> ^~</span> /product/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span>          http://localhost:8002;</span><br><span class="line">    <span class="attribute">proxy_redirect</span>      <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>    Host <span class="variable">$host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>    X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>    X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 静态资源读取不到问题处理</span></span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^/api/profile/(.*)$</span> /(替换成正确路径的文件的上一层目录)/<span class="variable">$1</span> <span class="literal">last</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子应用一服务</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span>                <span class="number">8001</span>;</span><br><span class="line">  <span class="attribute">server_name</span>           _;</span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span>                /var/nginx/html/user;</span><br><span class="line">    <span class="attribute">index</span>               index.html;</span><br><span class="line">    <span class="attribute">try_files</span>           <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span><span class="regexp"> ^~</span> /user/ &#123;</span><br><span class="line">    <span class="attribute">alias</span>               /var/nginx/html/user/;</span><br><span class="line">    <span class="attribute">index</span>               index.html index.htm;</span><br><span class="line">    <span class="attribute">try_files</span>           <span class="variable">$uri</span> /user/index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 接口代理</span></span><br><span class="line">  <span class="section">location</span>  /api &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span>          http://localhost:3001;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子应用二服务</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span>                <span class="number">8002</span>;</span><br><span class="line">  <span class="attribute">server_name</span>           _;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span>                /var/nginx/html/product;</span><br><span class="line">    <span class="attribute">index</span>               index.html;</span><br><span class="line">    <span class="attribute">try_files</span>           <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span><span class="regexp"> ^~</span> /product/ &#123;</span><br><span class="line">    <span class="attribute">alias</span>               /var/nginx/html/product/;</span><br><span class="line">    <span class="attribute">index</span>               index.html index.htm;</span><br><span class="line">    <span class="attribute">try_files</span>           <span class="variable">$uri</span> /product/index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 接口代理</span></span><br><span class="line">  <span class="section">location</span>  /api &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span>          http://localhost:3002;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述配置中</p>
<ul>
<li>**<code>location ^~ /user/</code>**：使用 <code>^~</code> 修饰的 <code>location</code> 块，匹配以 <code>/user/</code> 开头的 <code>URI</code>。如果请求的 <code>URI</code> 以 <code>/user/</code> 开头，则 <code>Nginx</code> 将立即停止搜索其他 <code>location</code> 块，而是使用这个 <code>location</code> 块进行处理，<code>location</code> 块里面使用反向代理，指向服务器 <code>http://localhost:8001</code> 的地址。</li>
<li>**<code>location ^~ /product/</code>**：同上，匹配以 <code>/product/</code> 开头的 <code>URI</code>。</li>
</ul>
<h3 id="PC端和移动端使用不同的项目文件映射"><a href="#PC端和移动端使用不同的项目文件映射" class="headerlink" title="PC端和移动端使用不同的项目文件映射"></a>PC端和移动端使用不同的项目文件映射</h3><p>要在 <code>Nginx</code> 中根据用户设备类型（例如PC端和移动端）使用不同的项目文件映射，您可以使用 <code>map</code> 指令创建一个变量，根据用户的 <code>User-Agent</code> 头部信息来判断设备类型，并使用if语句根据变量的值来选择不同的文件映射。以下是一个示例配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$http_user_agent</span> <span class="variable">$is_mobile</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> <span class="number">0</span>;</span><br><span class="line">  ~*<span class="attribute">iphone</span> <span class="number">1</span>;</span><br><span class="line">  ~*<span class="attribute">android</span> <span class="number">1</span>;</span><br><span class="line">  ~*<span class="attribute">mobile</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> example.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">root</span> /var/www;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$is_mobile</span>) &#123;</span><br><span class="line">      <span class="attribute">alias</span> /var/www/mobile/;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">alias</span> /var/www/desktop/;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /var/www/desktop;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$http_user_agent</span> <span class="regexp">~* &#x27;(mobile|android|iphone|ipad|phone)&#x27;)</span> &#123;</span><br><span class="line">      <span class="attribute">root</span> /var/www/mobile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">index</span> index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个配置中：</p>
<ul>
<li>**<code>map $http_user_agent $is_mobile</code>**：创建一个变量 <code>$is_mobile</code>，根据 <code>$http_user_agent</code> 中的 <code>User-Agent</code> 头部信息判断设备类型。如果 <code>User-Agent</code> 中包含 <code>iphone</code>、<code>android</code>、<code>mobile</code> 等关键词，则将 <code>$is_mobile</code> 设置为 <code>1</code>，否则设置为 <code>0</code>。</li>
<li>**<code>location /</code>**：对所有请求进行匹配。</li>
<li>**<code>if ($is_mobile)</code>**：使用 <code>if</code> 语句根据 <code>$is_mobile</code> 的值判断设备类型。如果是移动设备，则将请求映射到 <code>/var/www/mobile/</code> 目录；否则映射到 <code>/var/www/desktop/</code> 目录。</li>
<li>**<code>try_files $uri $uri/ /index.html;</code>**：尝试寻找与请求 <code>URI</code> 匹配的文件，如果找不到则返回 <code>/index.html</code>。</li>
</ul>
<p>需要注意的是，尽管 <code>if</code> 语句在 <code>Nginx</code> 中是有效的，但它可能会导致性能问题，并且在某些情况下可能不起作用。如果您担心性能问题，可以考虑使用更高效的方法，如根据不同的 <code>User-Agent</code> 头部信息设置不同的变量，并使用 <code>map</code> 指令匹配。</p>
<h3 id="配置负载均衡"><a href="#配置负载均衡" class="headerlink" title="配置负载均衡"></a>配置负载均衡</h3><p>要在 <code>Nginx</code> 中配置负载均衡，您可以使用 <code>upstream</code> 块定义一组后端服务器，并在 <code>server</code> 块中使用 <code>proxy_pass</code> 指令将请求代理到这组后端服务器。以下是一个示例配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend3.example.com;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">      <span class="attribute">proxy_pass</span>          http://backend;</span><br><span class="line">      <span class="attribute">proxy_set_header</span>    Host <span class="variable">$proxy_host</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span>    X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span>    X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个配置中：</p>
<ul>
<li>**<code>upstream backend</code>**：定义了一个名为 <code>backend</code> 的负载均衡组，其中包含了三个后端服务器：<code>backend1.example.com</code>、<code>backend2.example.com</code> 和 <code>backend3.example.com</code>。</li>
<li>**<code>server块中的location /</code>**：匹配所有请求。</li>
<li>**<code>proxy_pass http://backend;</code>**：将请求代理到名为 <code>backend</code> 的负载均衡组中的服务器。<code>Nginx</code> 会自动根据默认的负载均衡算法（轮询）将请求分发到这组后端服务器中的一个。</li>
<li>**<code>proxy_set_header</code>**：设置代理请求的头部信息，如真实 <code>IP</code> 地址、转发者 <code>IP</code> 地址和主机地址。</li>
</ul>
<p>您还可以根据需要添加其他负载均衡配置选项，例如设置负载均衡算法、调整权重等。以下是一个更复杂的负载均衡配置示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="section">upstream</span> backend &#123;</span><br><span class="line">    least_conn; <span class="comment"># 使用最少连接数算法</span></span><br><span class="line">    <span class="attribute">server</span> backend1.example.com weight=<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend3.example.com;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> example.com;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">      <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个配置中：</p>
<ul>
<li>**<code>least_conn</code>**：使用最少连接数算法进行负载均衡。</li>
<li>**<code>server backend1.example.com weight=3;</code>**：设置 <code>backend1.example.com</code> 的权重为 <code>3</code>，比其他后端服务器更具优先级。</li>
<li>**<code>proxy_set_header</code>**：设置代理请求的头部信息，如真实 <code>IP</code> 地址、转发者 <code>IP</code> 地址和主机地址。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文介绍了一些常用的 <code>Nginx</code> 基础配置，包括虚拟主机配置、<code>HTTP</code> 重定向、反向代理、<code>SSL/TLS</code> 配置等内容，并提供了详细的示例说明。正确配置 <code>Nginx</code> 不仅可以提高网站的性能和安全性，还能提升用户体验和搜索引擎排名。希望本文能够帮助您更好地理解和应用 <code>Nginx</code>，在实际项目中发挥其作用。</p>
<p><strong>注意：</strong></p>
<p>配置完成后，保存并关闭文件，然后重新加载Nginx以使配置生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload nginx</span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li></ul>

        <a data-url="https://hankliu62.github.io/2022/04/08/nginx-commonly-config/" data-id="cluz1as9l000sqnq9frk8csm8" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-security-anti-reptile" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2021/12/20/security-anti-reptile/" class="article-date">
  <time datetime="2021-12-20T10:40:20.000Z" itemprop="datePublished">2021-12-20</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/20/security-anti-reptile/">Web安全之静态内容防爬虫</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="Web安全之静态内容防爬虫"><a href="#Web安全之静态内容防爬虫" class="headerlink" title="Web安全之静态内容防爬虫"></a>Web安全之静态内容防爬虫</h2><p>随着互联网的快速发展，网络安全问题日益突出。对于静态内容网站来说，防止恶意爬取网站内容成为了一项重要的任务。恶意爬取不仅会导致网站内容被盗用，还可能引发一系列安全问题，如数据泄露、恶意攻击等。因此，本文将探讨静态内容网站如何防范恶意爬取，提高网络安全。</p>
<h3 id="静态内容网站的特点"><a href="#静态内容网站的特点" class="headerlink" title="静态内容网站的特点"></a>静态内容网站的特点</h3><p>静态内容网站主要是指那些网页内容固定不变或变化较少的网站。这类网站通常以 <code>HTML</code> 、 <code>CSS</code> 和 <code>JavaScript</code> 等静态文件形式存在，不依赖后端数据库或复杂的应用程序。由于其结构简单、加载速度快，静态网站在新闻发布、产品展示、个人博客等领域得到广泛应用。</p>
<h3 id="恶意爬取的威胁"><a href="#恶意爬取的威胁" class="headerlink" title="恶意爬取的威胁"></a>恶意爬取的威胁</h3><p>恶意爬取是指未经授权，通过自动化手段（如爬虫程序）大规模抓取网站内容的行为。这种行为通常具有以下特点：</p>
<ol>
<li><strong>大规模：</strong>恶意爬取往往涉及大量的请求，给服务器带来沉重负担。</li>
<li><strong>未经授权：</strong>爬取行为未经网站所有者许可，违反了版权和隐私政策。</li>
<li><strong>恶意目的：</strong>恶意爬取可能导致内容被盗用、数据泄露、恶意攻击等后果。</li>
</ol>
<h3 id="防恶意爬取策略"><a href="#防恶意爬取策略" class="headerlink" title="防恶意爬取策略"></a>防恶意爬取策略</h3><p>为了防范恶意爬取，静态内容网站可以采取以下措施：</p>
<h4 id="设置robots-txt文件"><a href="#设置robots-txt文件" class="headerlink" title="设置robots.txt文件"></a>设置robots.txt文件</h4><p><code>robots.txt</code> 文件是一个用于告知搜索引擎爬虫哪些页面可以爬取、哪些页面不能爬取的文本文件。通过设置 <code>robots.txt</code> 文件，可以限制恶意爬虫的访问。</p>
<p>下面是一个 robots.txt 文件的例子，展示了如何设置一些基本的规则。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /</span><br><span class="line"></span><br><span class="line"># 禁止所有爬虫访问网站的所有页面</span><br><span class="line"></span><br><span class="line">User-agent: Googlebot</span><br><span class="line">Disallow:</span><br><span class="line"></span><br><span class="line"># 允许 Googlebot 访问网站的所有页面</span><br><span class="line"></span><br><span class="line">User-agent: Bingbot</span><br><span class="line">Disallow: /private/</span><br><span class="line"></span><br><span class="line"># 禁止 Bingbot 访问 /private/ 目录下的所有页面</span><br><span class="line"></span><br><span class="line">User-agent: Yahoo! Slurp</span><br><span class="line">Disallow: /admin/</span><br><span class="line"></span><br><span class="line"># 禁止 Yahoo! Slurp 访问 /admin/ 目录下的所有页面</span><br><span class="line"></span><br><span class="line">User-agent: *</span><br><span class="line">Disallow: /cgi-bin/</span><br><span class="line"></span><br><span class="line"># 禁止所有其他爬虫访问 /cgi-bin/ 目录下的所有页面</span><br><span class="line"></span><br><span class="line"># 允许特定爬虫访问特定页面</span><br><span class="line">User-agent: SpecificBot</span><br><span class="line">Allow: /special-page/</span><br><span class="line">Disallow: /</span><br><span class="line"></span><br><span class="line"># 对于名为 SpecificBot 的爬虫，只允许访问 /special-page/ 页面，其他页面都不允许访问</span><br></pre></td></tr></table></figure>

<p>在上面的例子中：</p>
<ul>
<li><strong>User-agent: *</strong> 表示该规则适用于所有爬虫。</li>
<li><strong>Disallow: &#x2F;</strong> 表示禁止爬虫访问网站的根目录及其所有子目录和文件。</li>
<li><strong>Allow: &#x2F;special-page&#x2F;</strong> 表示允许特定爬虫访问 <code>/special-page/</code> 页面。<code>Allow</code> 指令必须在 <code>Disallow</code> 指令之前，否则将无效。</li>
<li><strong>User-agent: SpecificBot</strong> 表示该规则仅适用于名为 <code>SpecificBot</code> 的爬虫。</li>
</ul>
<p>请注意， <code>robots.txt</code> 文件必须放置在网站的根目录下（通常是 <code>http://www.example.com/robots.txt</code>），以便爬虫能够找到它。同时，虽然大多数负责任的爬虫都会遵守 <code>robots.txt</code> 的规则，但并非所有爬虫都会遵守，因此它不能作为一种安全机制来防止数据被爬取。</p>
<h4 id="使用验证码技术"><a href="#使用验证码技术" class="headerlink" title="使用验证码技术"></a>使用验证码技术</h4><p>对于关键页面或敏感内容，可以引入验证码技术。用户在访问这些页面时需要输入正确的验证码才能继续浏览，从而有效阻止恶意爬虫的访问。</p>
<p>验证码技术的案例有很多，以下列举几个常见的案例：</p>
<ol>
<li><strong>网站注册和登录验证码：</strong>这是最常见的验证码技术案例。用户在注册或登录网站时，系统会显示一组随机生成的字符或图片，并要求用户输入或选择正确的字符或图片来完成验证。这种技术可以有效防止自动化程序恶意攻击网站，如进行暴力破解密码、刷票等行为。</li>
<li><strong>图片验证码：</strong>图片验证码是一种将随机生成的字符或数字嵌入到图片中，并要求用户识别并输入正确字符或数字的验证码技术。这种技术可以有效防止自动化程序识别并输入验证码，提高网站的安全性。</li>
<li><strong>滑动验证码：</strong>滑动验证码是一种要求用户通过滑动解锁来完成验证的技术。用户需要按照指定的方向或轨迹滑动滑块，才能完成验证。这种技术可以有效防止自动化程序模拟用户操作，提高网站的安全性。</li>
<li><strong>音频验证码：</strong>音频验证码是一种将随机生成的字符或数字转换为语音，并要求用户听取并输入正确字符或数字的验证码技术。这种技术适用于视觉障碍用户或无法通过图片验证码验证的情况。</li>
<li><strong>逻辑验证码：</strong>逻辑验证码是一种要求用户解决一个简单数学问题或逻辑问题来完成验证的技术。例如，系统可能会显示一个加法或减法问题，并要求用户输入正确答案。这种技术可以有效防止自动化程序识别并输入验证码，提高网站的安全性。</li>
</ol>
<h4 id="限制访问频率"><a href="#限制访问频率" class="headerlink" title="限制访问频率"></a>限制访问频率</h4><p>通过设置合理的访问频率限制，可以防止恶意爬虫大量请求服务器资源。例如，可以设置每个IP地址在单位时间内的最大请求次数。</p>
<p>限制访问频率的 <code>Node.js</code> 例子可以使用 <code>Redis</code> 来实现。下面是一个简单的示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Redis</span> = <span class="built_in">require</span>(<span class="string">&#x27;ioredis&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> redis = <span class="keyword">new</span> <span class="title class_">Redis</span>(&#123;</span><br><span class="line">  <span class="attr">port</span>: <span class="number">6379</span>, <span class="comment">// Redis 端口</span></span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>, <span class="comment">// Redis 主机地址</span></span><br><span class="line">  <span class="attr">password</span>: <span class="string">&#x27;your_redis_password&#x27;</span>, <span class="comment">// Redis 密码</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ACCESS_FREQUENCY</span> = <span class="number">5</span>; <span class="comment">// 设定访问频率限制，例如每分钟最多访问 5 次</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">EXPIRE_TIME</span> = <span class="number">60</span>; <span class="comment">// 设定过期时间，例如每分钟过期</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/protected-route&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> ip = req.<span class="property">ip</span>; <span class="comment">// 获取请求 IP</span></span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">`access-frequency:<span class="subst">$&#123;ip&#125;</span>`</span>; <span class="comment">// 构建 Redis 键名</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> count = <span class="keyword">await</span> redis.<span class="title function_">get</span>(key); <span class="comment">// 获取当前 IP 的访问次数</span></span><br><span class="line">    <span class="keyword">if</span> (count &amp;&amp; <span class="built_in">parseInt</span>(count) &gt;= <span class="variable constant_">ACCESS_FREQUENCY</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">429</span>).<span class="title function_">send</span>(<span class="string">&#x27;Too Many Requests&#x27;</span>); <span class="comment">// 超过访问频率限制，返回 429 状态码</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newCount = count ? <span class="built_in">parseInt</span>(count) + <span class="number">1</span> : <span class="number">1</span>; <span class="comment">// 更新访问次数</span></span><br><span class="line">    <span class="keyword">await</span> redis.<span class="title function_">set</span>(key, newCount, <span class="string">&#x27;EX&#x27;</span>, <span class="variable constant_">EXPIRE_TIME</span>); <span class="comment">// 设置新的访问次数，并设置过期时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理正常请求逻辑...</span></span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;Success&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Internal Server Error&#x27;</span>); <span class="comment">// 发生错误时返回 500 状态码</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们使用 <code>Redis</code> 来存储每个 <code>IP</code> 的访问次数，并设定了一个访问频率限制（例如每分钟最多访问 <code>5</code> 次）。当一个请求到达时，我们首先获取当前 <code>IP</code> 的访问次数，如果超过了限制，则返回 <code>429</code> 状态码表示请求过多。否则，我们更新访问次数，并设置过期时间，以便在下一分钟内重置访问次数。最后，我们处理正常的请求逻辑并返回成功响应。</p>
<p>请注意，这只是一个简单的示例代码，实际应用中可能需要更多的逻辑和安全性考虑，例如使用分布式锁来防止并发访问问题，以及使用更复杂的算法来计算访问频率等。</p>
<h4 id="数据混淆"><a href="#数据混淆" class="headerlink" title="数据混淆"></a>数据混淆</h4><p>数据混淆是指通过改变数据的表示方式或结构，使得爬虫无法直接解析出真实数据的方法。</p>
<p>假设你有一个包含敏感信息的API接口，返回的数据是JSON格式的。为了防止爬虫直接获取到这些数据，你可以对返回的数据进行混淆处理。</p>
<p>原始数据:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan@example.com&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>混淆后的数据:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;n1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Z3Nj&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;a2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MzAi&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;e3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;emFuc2FuQGV4YW1wbGUuY29t&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在这个例子中，你可以使用一种简单的混淆算法（如Base64编码）对原始数据进行编码，然后在前端使用相应的解码算法进行解码，以显示真实的数据。这样，爬虫获取到的只是混淆后的数据，无法直接解析出真实的信息。</p>
<h4 id="加密传输"><a href="#加密传输" class="headerlink" title="加密传输"></a>加密传输</h4><p>使用HTTPS协议对网站内容进行加密传输，可以防止恶意爬虫在传输过程中窃取数据。此外，HTTPS协议还能提高网站的安全性，保护用户隐私。</p>
<h4 id="使用反爬虫技术"><a href="#使用反爬虫技术" class="headerlink" title="使用反爬虫技术"></a>使用反爬虫技术</h4><p>反爬虫技术是一种主动防御手段，通过识别并阻止恶意爬虫的访问。例如，可以通过分析请求头、请求频率、用户代理等信息来判断是否为恶意爬虫，并采取相应的防御措施。</p>
<p>下面是一个简单的 <code>express</code> 示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> rateLimit = <span class="built_in">require</span>(<span class="string">&#x27;express-rate-limit&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置访问频率限制</span></span><br><span class="line"><span class="keyword">const</span> limiter = <span class="title function_">rateLimit</span>(&#123;</span><br><span class="line">    <span class="attr">windowMs</span>: <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000</span>, <span class="comment">// 15分钟</span></span><br><span class="line">    <span class="attr">max</span>: <span class="number">100</span>, <span class="comment">// 在时间窗口内的最大请求数</span></span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;Too many requests from this IP, please try again later.&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/protected-route&#x27;</span>, limiter);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/protected-route&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> userAgent = req.<span class="property">headers</span>[<span class="string">&#x27;user-agent&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查User-Agent是否像是浏览器的</span></span><br><span class="line">    <span class="keyword">if</span> (!userAgent || !userAgent.<span class="title function_">includes</span>(<span class="string">&#x27;Mozilla&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">send</span>(<span class="string">&#x27;Forbidden&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 假设这是从数据库或API获取敏感数据的函数</span></span><br><span class="line">    <span class="title function_">fetchSensitiveData</span>().<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(data);</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Internal Server Error&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server is running on port 3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchSensitiveData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 这里模拟从数据库或API获取数据的过程</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">resolve</span>(&#123; <span class="attr">sensitiveInformation</span>: <span class="string">&#x27;This is sensitive data&#x27;</span> &#125;);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们使用了 <code>express-rate-limit</code> 中间件来限制来自同一 <code>IP</code> 的请求频率，并检查了 <code>User-Agent</code> 头来识别非浏览器请求。</p>
<h4 id="定期更新内容"><a href="#定期更新内容" class="headerlink" title="定期更新内容"></a>定期更新内容</h4><p>定期更新网站内容可以降低恶意爬虫的兴趣。同时，通过不断更新网站结构和内容，可以增加恶意爬虫爬取的难度。</p>
<h4 id="建立安全监测机制"><a href="#建立安全监测机制" class="headerlink" title="建立安全监测机制"></a>建立安全监测机制</h4><p>建立安全监测机制，及时发现并应对恶意爬取行为。通过监控网站访问日志、流量异常等信息，可以及时发现恶意爬虫并采取相应的措施。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>网络安全是互联网发展的基石，而静态内容网站的防爬虫工作是其中的重要一环。防范恶意爬取对于静态内容网站来说至关重要。通过了解恶意爬取的特点和采取相应的防范措施，可以有效提高网站的安全性，维护网站所有者的权益，同时提升用户体验。同时，网站所有者还应持续关注网络安全动态，不断更新和完善防范措施，确保网站内容的安全与稳定。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">network</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reptile/" rel="tag">reptile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/security/" rel="tag">security</a></li></ul>

        <a data-url="https://hankliu62.github.io/2021/12/20/security-anti-reptile/" data-id="cluz1as9n000xqnq9hl8ydybt" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-security-sql-injection" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2021/09/26/security-sql-injection/" class="article-date">
  <time datetime="2021-09-26T18:20:26.000Z" itemprop="datePublished">2021-09-26</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/26/security-sql-injection/">Web安全之 SQL 注入</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="Web安全之-SQL-注入"><a href="#Web安全之-SQL-注入" class="headerlink" title="Web安全之 SQL 注入"></a>Web安全之 SQL 注入</h2><p>随着互联网的快速发展，网络安全问题日益受到人们的关注。 <code>SQL</code> 注入是一种常见的网络安全攻击方式，严重威胁着数据库的安全。本文将从 <code>SQL</code> 注入的概念、原理、危害以及防范措施等方面，对网络安全中的 <code>SQL</code> 注入进行深入探讨。</p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p><code>SQL</code> 注入（<code>SQL Injection</code>）是指攻击者在用户输入的数据中注入恶意的 <code>SQL</code> 语句，从而在未经授权的情况下实现对数据库的非法操作。当应用程序没有对用户输入的数据进行有效的验证和过滤时，攻击者可以利用这一漏洞，篡改原始的 <code>SQL</code> 语句，进而窃取、篡改或删除数据库中的数据。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><code>SQL</code> 注入的原理主要基于应用程序对用户输入数据的处理不当。攻击者通过在用户输入的数据中插入恶意的 <code>SQL</code> 语句，使得应用程序在构建 <code>SQL</code> 查询时，将恶意语句作为查询的一部分发送给数据库执行。这样，攻击者就可以绕过应用程序的验证，直接对数据库进行操作。</p>
<h3 id="危害"><a href="#危害" class="headerlink" title="危害"></a>危害</h3><ol>
<li><strong>数据泄露：</strong>攻击者可以通过 <code>SQL</code> 注入获取数据库中的敏感信息，如用户密码、身份信息、银行账户等，从而导致数据泄露和用户隐私泄露。</li>
<li><strong>数据篡改：</strong>攻击者可以利用 <code>SQL</code> 注入修改数据库中的数据，破坏数据的完整性和准确性。</li>
<li><strong>数据删除：</strong>攻击者可以通过 <code>SQL</code> 注入删除数据库中的数据，导致数据丢失和业务受损。</li>
<li><strong>服务器被控制：</strong>攻击者还可以通过 <code>SQL</code> 注入获取数据库的完全控制权限，进一步对服务器进行攻击和控制。</li>
</ol>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>下面是一个简单的 <code>Node.js</code> 和 <code>Express</code> 框架中的 <code>SQL</code> 注入案例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建数据库连接</span></span><br><span class="line"><span class="keyword">const</span> connection = mysql.<span class="title function_">createConnection</span>(&#123;</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">user</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">  <span class="attr">password</span>: <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">  <span class="attr">database</span>: <span class="string">&#x27;test&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">connection.<span class="title function_">connect</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个简单的路由处理函数，存在 SQL 注入漏洞</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/users&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = req.<span class="property">query</span>.<span class="property">username</span>; <span class="comment">// 从查询字符串获取用户名</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 直接将用户名插入 SQL 查询中，没有进行任何过滤或转义</span></span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`SELECT * FROM users WHERE username = &#x27;<span class="subst">$&#123;username&#125;</span>&#x27;`</span>;</span><br><span class="line"></span><br><span class="line">  connection.<span class="title function_">query</span>(query, <span class="function">(<span class="params">error, results, fields</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">    res.<span class="title function_">send</span>(results);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;App listening on port 3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在上述代码中，我们定义了一个简单的 <code>Express</code> 应用，它监听 <code>/users</code> 路由，并从查询字符串中获取 <code>username</code> 参数。然后，我们直接将 <code>username</code> 插入 <code>SQL</code> 查询语句中。由于没有对 <code>username</code> 进行任何形式的过滤或转义，攻击者可以通过在查询字符串中插入恶意的 <code>SQL</code> 代码来操纵查询结果，甚至执行任意的 <code>SQL</code> 语句。</p>
<p>例如，攻击者可以通过以下 <code>URL</code> 尝试注入攻击：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/users?username=&#x27;; DROP TABLE users; --</span><br></pre></td></tr></table></figure>

<p>这个 <code>URL</code> 会导致 <code>SQL</code> 查询变成：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>; <span class="keyword">DROP</span> <span class="keyword">TABLE</span> users; <span class="comment">--&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果应用执行了这条查询，它会删除 <code>users</code> 表中的所有数据。</p>
<h3 id="防范措施"><a href="#防范措施" class="headerlink" title="防范措施"></a>防范措施</h3><p>为了防止 <code>SQL</code> 注入攻击，你应该：</p>
<h4 id="使用参数化查询"><a href="#使用参数化查询" class="headerlink" title="使用参数化查询"></a>使用参数化查询</h4><p>参数化查询可以确保用户输入被当作数据而不是 <code>SQL</code> 代码来处理。在 <code>Node.js</code> 中，可以使用像 <code>mysql</code> 包中的 <code>query</code> 方法的参数化版本，或者使用 <code>ORM</code>（对象关系映射）库如 <code>Sequelize</code> 或者 <code>TypeORM</code>。</p>
<p>在上述的 <code>Node.js</code> 例子中，你可以使用 <code>mysql</code> 包来执行参数化查询。以下是一个使用 <code>mysql</code> 包和参数化查询来预防 <code>SQL</code> 注入的示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/users&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = req.<span class="property">query</span>.<span class="property">username</span>; <span class="comment">// 从查询字符串获取用户名</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 SQL 语句</span></span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`SELECT * FROM users WHERE username = &#x27;?&#x27;`</span>;</span><br><span class="line"></span><br><span class="line">  connection.<span class="title function_">query</span>(query, [username], <span class="function">(<span class="params">error, results, fields</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">    res.<span class="title function_">send</span>(results);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>在这个例子中，<code>? </code>是一个参数占位符，代表我们要查询的 <code>username</code>。我们将 <code>username</code> 作为数组 <code>[username]</code> 的元素传递给 <code>query</code> 方法的第二个参数。这样，<code>MySQL</code> 驱动程序就会知道 <code>?</code> 应该被 <code>username</code> 的值替换。</p>
<p>由于参数化查询确保了用户输入被当作数据处理，而不是作为 <code>SQL</code> 代码的一部分，因此即使 <code>username</code> 包含恶意的 <code>SQL</code> 代码，它也不会被执行。这是预防 <code>SQL</code> 注入攻击的一种有效方式。</p>
<h4 id="使用预编译语句"><a href="#使用预编译语句" class="headerlink" title="使用预编译语句"></a>使用预编译语句</h4><p>预编译语句是一种将 <code>SQL</code> 语句和参数分开处理的方式，数据库管理系统会对 <code>SQL</code> 语句进行解析、优化和编译，然后存储起来。每次执行时，只需传递参数，避免了 <code>SQL</code> 注入的风险。</p>
<p>在上述的 <code>Node.js</code> 例子中，你可以使用 <code>mysql</code> 包来执行预编译语句。以下是一个使用 <code>mysql</code> 包和预编译语句来预防 <code>SQL</code> 注入的示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/users&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = req.<span class="property">query</span>.<span class="property">username</span>; <span class="comment">// 从查询字符串获取用户名</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 准备预编译语句</span></span><br><span class="line">  <span class="keyword">const</span> prepareQuery = <span class="string">`PREPARE stmt FROM &quot;SELECT * FROM users WHERE username = &#x27;?&#x27;&quot;`</span>;</span><br><span class="line">  connection.<span class="title function_">query</span>(prepareQuery, <span class="function">(<span class="params">error, results, fields</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置参数并执行预编译语句</span></span><br><span class="line">    <span class="keyword">const</span> executeQuery = <span class="string">&#x27;EXECUTE stmt USING ?&#x27;</span>;</span><br><span class="line">    connection.<span class="title function_">query</span>(executeQuery, [username], <span class="function">(<span class="params">error, results, fields</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(results);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 释放预编译语句</span></span><br><span class="line">      connection.<span class="title function_">query</span>(<span class="string">&#x27;DEALLOCATE PREPARE stmt&#x27;</span>, <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">        connection.<span class="title function_">end</span>();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个预编译语句的例子中，我们首先准备一个预编译语句，其中包含一个占位符 <code>?</code>。然后，我们使用 <code>PREPARE</code> 语句将其发送到数据库进行编译。之后，我们使用 <code>EXECUTE</code> 语句并传递参数 <code>[username]</code> 来执行预编译的语句。最后，我们使用 <code>DEALLOCATE PREPARE</code> 语句释放预编译语句的资源。</p>
<p>使用预编译语句的好处是，即使参数中包含恶意的 <code>SQL</code> 代码，它也不会被数据库执行。这是因为预编译语句将参数和 <code>SQL</code> 语句分开处理，数据库只会执行预编译的 <code>SQL</code> 语句，并将参数作为数据来处理。</p>
<h4 id="转义用户输入"><a href="#转义用户输入" class="headerlink" title="转义用户输入"></a>转义用户输入</h4><p>转义用户输入是另一种防止 <code>SQL</code> 注入攻击的方法。转义用户输入意味着将用户提供的值中的特殊字符（如单引号、双引号等）替换为它们的转义版本，这样在 <code>SQL</code> 语句中它们就会被当作普通文本处理，而不是 <code>SQL</code> 代码的一部分。</p>
<p>虽然参数化查询是首选的方法，因为它提供了更高级别的安全性，但在某些情况下，你可能需要手动转义用户输入。在 <code>Node.js</code> 中，你可以使用 <code>MySQL</code> 驱动程序的 <code>escape</code> 方法来转义用户输入。</p>
<p>以下是一个使用 <code>Node.js</code> 和 <code>mysql</code> 驱动程序手动转义用户输入的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/users&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 从查询字符串获取用户名</span></span><br><span class="line">  <span class="keyword">const</span> username = req.<span class="property">query</span>.<span class="property">username</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 escape 方法转义用户输入</span></span><br><span class="line">  <span class="keyword">const</span> safeUsername = mysql.<span class="built_in">escape</span>(username);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 SQL 语句</span></span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`SELECT * FROM users WHERE username = &#x27;<span class="subst">$&#123;safeUsername&#125;</span>&#x27;`</span>;</span><br><span class="line"></span><br><span class="line">  connection.<span class="title function_">query</span>(query, <span class="function">(<span class="params">error, results, fields</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">    res.<span class="title function_">send</span>(results);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们使用了 <code>mysql.escape</code> 方法来转义 <code>username</code> 中的特殊字符。这样，即使 <code>username</code> 包含特殊字符，它也不会被误解为 <code>SQL</code> 语句的一部分。</p>
<p>然而，尽管手动转义用户输入可以提供一定程度的保护，但它仍然不是最安全的做法。原因之一是它可能会导致程序逻辑变得复杂且容易出错，尤其是在构建复杂的 <code>SQL</code> 语句时。因此，推荐使用参数化查询或预编译语句，因为它们提供了更强的安全性保证，并且更容易正确使用。</p>
<h4 id="最小权限原则"><a href="#最小权限原则" class="headerlink" title="最小权限原则"></a>最小权限原则</h4><p>确保数据库账户只有执行必要操作的最小权限。例如，如果应用程序只需要从数据库中读取数据，那么就不应该赋予它写入权限。</p>
<p>在 <code>MySQL</code> 中设置只读权限，你需要登录到MySQL数据库，然后为用户创建一个新的角色并授予只读权限。你可以使用GRANT语句来实现这一点。具体如下所示:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 登录到MySQL</span></span><br><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建新角色</span></span><br><span class="line"><span class="keyword">CREATE</span> ROLE <span class="string">&#x27;readonlyuser&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予只读权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> your_database.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;readonlyuser&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新权限</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 退出MySQL</span></span><br><span class="line">EXIT;</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，<code>your_database</code> 是你想要让用户具有只读权限的数据库名。<code>&#39;readonlyuser&#39;@&#39;localhost&#39;</code> 表示用户名为 <code>readonlyuser</code> ，并且该用户只能从本地主机连接到数据库。如果你希望用户可以从任何主机连接，你可以将 <code>localhost</code> 替换为 <code>&#39;%&#39;</code>。</p>
<h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><p>不要将详细的数据库错误信息直接返回给用户。这可以防止攻击者利用这些信息进行更复杂的攻击。</p>
<h4 id="安全审计和测试"><a href="#安全审计和测试" class="headerlink" title="安全审计和测试"></a>安全审计和测试</h4><p>使用工具如 <code>SQLMap</code>、<code>OWASP Zap</code> 等进行安全审计和测试，确保应用程序不会受到 <code>SQL</code> 注入攻击。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>总之， <code>SQL</code> 注入是一种常见的网络安全攻击方式，对数据库的安全构成严重威胁。为了防范 <code>SQL</code> 注入攻击，我们需要加强用户输入验证、使用参数化查询、存储过程等安全措施，并定期更新和修补数据库管理系统和应用程序。只有这样，我们才能确保数据库的安全，保护用户的数据隐私和业务安全。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">network</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/security/" rel="tag">security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/" rel="tag">sql</a></li></ul>

        <a data-url="https://hankliu62.github.io/2021/09/26/security-sql-injection/" data-id="cluz1as9o0012qnq976ns1b0n" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-security-x-content-types-options" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2021/03/12/security-x-content-types-options/" class="article-date">
  <time datetime="2021-03-12T09:09:12.000Z" itemprop="datePublished">2021-03-12</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/12/security-x-content-types-options/">Web安全之使用 X-Content-Type-Options 首部字段</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="Web安全之使用-X-Content-Type-Options-首部字段"><a href="#Web安全之使用-X-Content-Type-Options-首部字段" class="headerlink" title="Web安全之使用 X-Content-Type-Options 首部字段"></a>Web安全之使用 X-Content-Type-Options 首部字段</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>X-Content-Type-Options</code> 是一个 <code>HTTP</code> 响应头，用于防止浏览器对响应内容的 <code>MIME</code> 类型进行嗅探或猜测。当设置为 <code>nosniff</code> 时，它告诉浏览器应该严格按照响应头中 <code>Content-Type</code> 字段所指定的类型来处理资源，而不应该根据文件扩展名、文件内容或其他因素来尝试重新确定资源的类型。</p>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>使用 <code>X-Content-Type-Options</code> 可以提高网站的安全性，因为它可以防止某些类型的攻击，例如 <code>MIME</code> 类型混淆攻击。这种攻击通常涉及将恶意内容伪装成合法的资源类型（如 <code>JavaScript</code> 文件），然后利用浏览器对 <code>MIME</code> 类型的错误处理来执行恶意代码，能够有效的预防 <code>XSS</code> 攻击。</p>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>要在你的 <code>web</code> 服务器上设置 <code>X-Content-Type-Options</code> 响应头，你需要根据你的服务器软件（如 <code>Apache、Nginx、IIS</code> 等）进行配置。下面是一些常见的服务器配置示例：</p>
<h4 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h4><p>在 Apache 中，你可以使用 mod_headers 模块来设置响应头。在你的网站配置文件中添加以下行：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Header</span> set X-Content-Type-Options <span class="string">&quot;nosniff&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h4><p>在 Nginx 中，你可以在 http、server 或 location 块中添加 add_header 指令来设置响应头：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> X-Content-Type-Options <span class="string">&quot;nosniff&quot;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h4><p>在 IIS 中，你可以使用 web.config 文件来设置响应头。在 &lt;system.webServer&gt; 部分添加以下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">httpProtocol</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">customHeaders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;X-Content-Type-Options&quot;</span> <span class="attr">value</span>=<span class="string">&quot;nosniff&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">customHeaders</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">httpProtocol</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Node-js-使用-Express"><a href="#Node-js-使用-Express" class="headerlink" title="Node.js (使用 Express)"></a>Node.js (使用 Express)</h4><p>如果你使用 <code>Node.js</code> 和 <code>Express</code> 框架，你可以在应用程序中添加中间件来设置响应头：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;X-Content-Type-Options&#x27;</span>, <span class="string">&#x27;nosniff&#x27;</span>);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>请确保你的服务器配置正确，并且 <code>X-Content-Type-Options</code> 头部已正确设置。这样，浏览器在接收响应时就会遵守该头部的指示，从而提高应用程序的安全性。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">network</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/security/" rel="tag">security</a></li></ul>

        <a data-url="https://hankliu62.github.io/2021/03/12/security-x-content-types-options/" data-id="cluz1as9p0013qnq96dsp2lx5" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/04/14/fontend-optimize-indicators/">Web前端最新优化指标：从FP到FPS的全面解析</a>
          </li>
        
          <li>
            <a href="/2024/04/12/abort-controller/">使用 AbortController 实现异步操作控制</a>
          </li>
        
          <li>
            <a href="/2024/04/10/optimize-miniprogram/">小程序性能优化实践指南</a>
          </li>
        
          <li>
            <a href="/2024/04/08/github-action-docker/">使用 GitHub Actions 自动化部署 Nuxt3 应用到 Docker 容器中</a>
          </li>
        
          <li>
            <a href="/2024/04/06/github-action-publish-package/">使用 GitHub Action 实现自动化发布 npm 包</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/" rel="tag">canvas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csrf/" rel="tag">csrf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debugging/" rel="tag">debugging</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github-pages/" rel="tag">github pages</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/homebrew/" rel="tag">homebrew</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html/" rel="tag">html</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html5/" rel="tag">html5</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/loader/" rel="tag">loader</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/miniprogram/" rel="tag">miniprogram</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mobile/" rel="tag">mobile</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">network</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/optimize/" rel="tag">optimize</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reptile/" rel="tag">reptile</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/service-worker/" rel="tag">service worker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/translate/" rel="tag">translate</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vitepress/" rel="tag">vitepress</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webworker/" rel="tag">webworker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weinre/" rel="tag">weinre</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yuv/" rel="tag">yuv</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">四月 2024</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 HankLiu, Inc. All rights reserved.<br>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">文章</a>
  
    <a href="/toolkit" class="mobile-nav-link">小工具</a>
  
    <a href="/resume" class="mobile-nav-link">小简介</a>
  
    <a href="/about" class="mobile-nav-link">小关于</a>
  
  <a href="#search" class="mobile-nav-link st-search-show-outputs">Search</a>
</nav>
  

<!-- totop start -->
<div id="totop">
	<a title="To Top"></a>
</div>
<!-- totop end -->

<!-- swiftype search start -->

<!-- swiftype search end -->



<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/lrsjng.jquery-qrcode/0.12.0/jquery.qrcode.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


</div>
</body>
</html>
