
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  
  <title>HankLiu的博客小屋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="努力去听风的声音，不必在意风的方向。">
<meta property="og:type" content="website">
<meta property="og:title" content="HankLiu的博客小屋">
<meta property="og:url" content="https://hankliu62.github.io/index.html">
<meta property="og:site_name" content="HankLiu的博客小屋">
<meta property="og:description" content="努力去听风的声音，不必在意风的方向。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="HankLiu">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/img/favicon.ico" sizes="16x16">
  
  <link rel="stylesheet" href="/css/style.css?t=1">
  
    <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
  

<meta name="generator" content="Hexo 7.1.1"></head>

<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner">
    <div id="banner-mask"></div>
  </div>
  <div id="header-outer" class="outer">
    <nav id="upper-nav" class="inner">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <div class="sub-nav">
        
        
          <a id="nav-github" class="nav-icon" href="https://github.com/hankliu62"></a>
        
      </div>
    </nav>
    <div id="header-title">
      
        <h1 id="blog-title-wrap">
          <a href="/" id="blog-title">HankLiu的博客小屋</a>
        </h1>
      
      
        <h5 class="blog-subtitle-wrap">努力去听风的声音，不必在意风的方向。</h5>
      
    </div>
    <div id="contenedor">
      <ul class="cube">
        <li class="cara"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="100" width="100" viewBox="-50 -50 200 200">
          <circle cx="50" cy="50" r="45" stroke-width="5" stroke="black" stroke-opacity="0.5" fill-opacity="0"></circle>
          <rect id="clockwise" x="47.5" y="27.5" width="5" height="25" rx="2.5" ry="2.5" fill="black" fill-opacity="0.5" transform="rotate(330 50 50)"></rect>
          <rect id="minute" x="48.5" y="16.5" width="3" height="35" rx="1.5" ry="1.5" fill="black" fill-opacity="0.5"></rect>
        </svg></li>
        <li class="cara">P</li>
        <li class="cara">X</li>
        <li class="cara">L</li>
        <li class="cara">C</li>
        <li class="cara">Y</li>
      </ul>
    </div>
    <nav id="main-nav">
      
        <a class="main-nav-link" href="/">主页</a>
      
        <a class="main-nav-link" href="/archives">文章</a>
      
        <a class="main-nav-link" href="/toolkit">小工具</a>
      
        <a class="main-nav-link" href="/resume">小简介</a>
      
        <a class="main-nav-link" href="/about">小关于</a>
      
    </nav>
  </div>
</header>

    <div class="outer">
      <section id="main">
  
    <article id="post-node-ffmpeg" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/06/20/node-ffmpeg/" class="article-date">
  <time datetime="2024-06-20T18:20:12.000Z" itemprop="datePublished">2024-06-20</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/06/20/node-ffmpeg/">使用 Node.js 和 FFmpeg 构建视频服务器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="使用-Node-js-和-FFmpeg-构建视频服务器"><a href="#使用-Node-js-和-FFmpeg-构建视频服务器" class="headerlink" title="使用 Node.js 和 FFmpeg 构建视频服务器"></a>使用 Node.js 和 FFmpeg 构建视频服务器</h2><p>构建一个视频服务器可以为视频处理、转码和流媒体提供强大的功能支持。在本篇文章中，我们将详细介绍如何使用 Node.js 和 FFmpeg 搭建一个视频服务器，涵盖从环境搭建、基本视频处理、视频上传与存储到视频流媒体播放等多个方面的内容。</p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>在开始之前，请确保您的系统上已经安装了以下软件：</p>
<ol>
<li><strong>Node.js</strong>：JavaScript 运行时，用于服务器端开发。</li>
<li><strong>FFmpeg</strong>：一个强大的多媒体处理工具，可以处理音视频数据。</li>
</ol>
<h4 id="安装-Node-js"><a href="#安装-Node-js" class="headerlink" title="安装 Node.js"></a>安装 Node.js</h4><p>请访问 <a href="https://nodejs.org/">Node.js 官网</a> 下载并安装最新版本的 Node.js。安装完成后，您可以使用以下命令验证安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>

<h4 id="安装-FFmpeg"><a href="#安装-FFmpeg" class="headerlink" title="安装 FFmpeg"></a>安装 FFmpeg</h4><h5 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h5><p>可以使用 Homebrew 安装 FFmpeg：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install ffmpeg</span><br></pre></td></tr></table></figure>

<h5 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h5><p>可以使用 apt-get 安装 FFmpeg：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ffmpeg</span><br></pre></td></tr></table></figure>

<h5 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h5><p>请访问 <a href="https://ffmpeg.org/download.html">FFmpeg 官网</a> 下载适用于 Windows 的预编译二进制文件，并按照说明进行安装。</p>
<p>安装完成后，您可以使用以下命令验证安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -version</span><br></pre></td></tr></table></figure>

<h3 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h3><h4 id="创建项目目录"><a href="#创建项目目录" class="headerlink" title="创建项目目录"></a>创建项目目录</h4><p>首先，创建一个新的项目目录并初始化一个新的 Node.js 项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> video-server</span><br><span class="line"><span class="built_in">cd</span> video-server</span><br><span class="line">npm init -y</span><br></pre></td></tr></table></figure>

<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><p>我们将使用以下 Node.js 包：</p>
<ul>
<li><strong>express</strong>：Web 框架，用于处理 HTTP 请求。</li>
<li><strong>multer</strong>：中间件，用于处理文件上传。</li>
<li><strong>fluent-ffmpeg</strong>：Node.js 对 FFmpeg 的简单封装，用于处理视频文件。</li>
</ul>
<p>安装上述依赖包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express multer fluent-ffmpeg</span><br></pre></td></tr></table></figure>

<h3 id="基本服务器设置"><a href="#基本服务器设置" class="headerlink" title="基本服务器设置"></a>基本服务器设置</h3><h4 id="创建服务器"><a href="#创建服务器" class="headerlink" title="创建服务器"></a>创建服务器</h4><p>在项目根目录下创建一个 <code>server.js</code> 文件，配置基本的服务器设置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&#x27;multer&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ffmpeg = <span class="built_in">require</span>(<span class="string">&#x27;fluent-ffmpeg&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置静态文件目录</span></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;public&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置文件上传存储位置</span></span><br><span class="line"><span class="keyword">const</span> storage = multer.<span class="title function_">diskStorage</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">cb</span>(<span class="literal">null</span>, <span class="string">&#x27;uploads/&#x27;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">filename</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">cb</span>(<span class="literal">null</span>, <span class="title class_">Date</span>.<span class="title function_">now</span>() + path.<span class="title function_">extname</span>(file.<span class="property">originalname</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> upload = <span class="title function_">multer</span>(&#123; storage &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视频上传处理</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;video&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filePath = req.<span class="property">file</span>.<span class="property">path</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 视频处理逻辑</span></span><br><span class="line">  <span class="title function_">ffmpeg</span>(filePath)</span><br><span class="line">    .<span class="title function_">output</span>(<span class="string">&#x27;output.mp4&#x27;</span>)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&#x27;Video processed successfully&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Video processing failed&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">run</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server is running on http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="创建目录结构"><a href="#创建目录结构" class="headerlink" title="创建目录结构"></a>创建目录结构</h4><p>为了管理上传和处理的视频文件，我们需要创建 <code>uploads</code> 目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> uploads</span><br></pre></td></tr></table></figure>

<h3 id="视频处理"><a href="#视频处理" class="headerlink" title="视频处理"></a>视频处理</h3><p>使用 FFmpeg 可以进行多种视频处理操作，包括转码、剪辑、加水印等。接下来，我们将介绍几种常见的视频处理操作。</p>
<h4 id="视频转码"><a href="#视频转码" class="headerlink" title="视频转码"></a>视频转码</h4><p>视频转码是将视频文件从一种格式转换为另一种格式。以下示例展示了如何将上传的视频文件转码为 MP4 格式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;video&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filePath = req.<span class="property">file</span>.<span class="property">path</span>;</span><br><span class="line">  <span class="keyword">const</span> outputFilePath = <span class="string">&#x27;uploads/&#x27;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="string">&#x27;.mp4&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ffmpeg</span>(filePath)</span><br><span class="line">    .<span class="title function_">output</span>(outputFilePath)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&#x27;Video transcoded successfully: &#x27;</span> + outputFilePath);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Video transcoding failed&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">run</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="视频剪辑"><a href="#视频剪辑" class="headerlink" title="视频剪辑"></a>视频剪辑</h4><p>视频剪辑是从视频文件中提取特定的片段。以下示例展示了如何从上传的视频文件中剪辑出前10秒的片段：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;video&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filePath = req.<span class="property">file</span>.<span class="property">path</span>;</span><br><span class="line">  <span class="keyword">const</span> outputFilePath = <span class="string">&#x27;uploads/&#x27;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="string">&#x27;_clip.mp4&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ffmpeg</span>(filePath)</span><br><span class="line">    .<span class="title function_">setStartTime</span>(<span class="string">&#x27;00:00:00&#x27;</span>)</span><br><span class="line">    .<span class="title function_">setDuration</span>(<span class="number">10</span>)</span><br><span class="line">    .<span class="title function_">output</span>(outputFilePath)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&#x27;Video clipped successfully: &#x27;</span> + outputFilePath);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Video clipping failed&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">run</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="添加水印"><a href="#添加水印" class="headerlink" title="添加水印"></a>添加水印</h4><p>添加水印是将图像或文本叠加到视频上。以下示例展示了如何在视频上添加一个水印图像：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;video&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filePath = req.<span class="property">file</span>.<span class="property">path</span>;</span><br><span class="line">  <span class="keyword">const</span> outputFilePath = <span class="string">&#x27;uploads/&#x27;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="string">&#x27;_watermarked.mp4&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> watermarkPath = <span class="string">&#x27;public/watermark.png&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ffmpeg</span>(filePath)</span><br><span class="line">    .<span class="title function_">outputOptions</span>(<span class="string">&#x27;-vf&#x27;</span>, <span class="string">`movie=<span class="subst">$&#123;watermarkPath&#125;</span> [watermark]; [in][watermark] overlay=10:10 [out]`</span>)</span><br><span class="line">    .<span class="title function_">output</span>(outputFilePath)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&#x27;Watermark added successfully: &#x27;</span> + outputFilePath);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Adding watermark failed&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">run</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="视频上传与存储"><a href="#视频上传与存储" class="headerlink" title="视频上传与存储"></a>视频上传与存储</h3><p>处理视频文件上传和存储是构建视频服务器的重要组成部分。接下来，我们将介绍如何使用 <code>multer</code> 中间件处理视频文件的上传，并将其存储在服务器上。</p>
<h4 id="配置文件上传中间件"><a href="#配置文件上传中间件" class="headerlink" title="配置文件上传中间件"></a>配置文件上传中间件</h4><p>我们已经在 <code>server.js</code> 中配置了 <code>multer</code>，用于处理文件上传。可以根据需要进一步配置存储设置，如限制文件大小和文件类型：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> upload = <span class="title function_">multer</span>(&#123;</span><br><span class="line">  storage,</span><br><span class="line">  <span class="attr">limits</span>: &#123; <span class="attr">fileSize</span>: <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span> &#125;, <span class="comment">// 限制文件大小为 100MB</span></span><br><span class="line">  <span class="attr">fileFilter</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> filetypes = <span class="regexp">/mp4|mkv|avi/</span>;</span><br><span class="line">    <span class="keyword">const</span> mimetype = filetypes.<span class="title function_">test</span>(file.<span class="property">mimetype</span>);</span><br><span class="line">    <span class="keyword">const</span> extname = filetypes.<span class="title function_">test</span>(path.<span class="title function_">extname</span>(file.<span class="property">originalname</span>).<span class="title function_">toLowerCase</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mimetype &amp;&amp; extname) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">cb</span>(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">cb</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;File type not supported&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="处理文件上传请求"><a href="#处理文件上传请求" class="headerlink" title="处理文件上传请求"></a>处理文件上传请求</h4><p>我们已经在 <code>/upload</code> 路由中处理了文件上传请求，并使用 <code>ffmpeg</code> 进行视频处理。可以根据需要添加更多路由来处理不同的视频操作。</p>
<h3 id="视频流媒体播放"><a href="#视频流媒体播放" class="headerlink" title="视频流媒体播放"></a>视频流媒体播放</h3><p>为了提供流媒体播放功能，我们需要将视频文件流式传输给客户端。以下示例展示了如何实现视频流媒体播放：</p>
<h4 id="配置视频流路由"><a href="#配置视频流路由" class="headerlink" title="配置视频流路由"></a>配置视频流路由</h4><p>在 <code>server.js</code> 中添加一个新的路由，用于处理视频流请求：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/video/:filename&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filePath = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;uploads&#x27;</span>, req.<span class="property">params</span>.<span class="property">filename</span>);</span><br><span class="line"></span><br><span class="line">  fs.<span class="title function_">stat</span>(filePath, <span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;File not found&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; range &#125; = req.<span class="property">headers</span>;</span><br><span class="line">    <span class="keyword">if</span> (!range) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">416</span>).<span class="title function_">send</span>(<span class="string">&#x27;Range not found&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> positions = range.<span class="title function_">replace</span>(<span class="regexp">/bytes=/</span>, <span class="string">&#x27;&#x27;</span>).<span class="title function_">split</span>(<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> start = <span class="built_in">parseInt</span>(positions[<span class="number">0</span>], <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">const</span> total = stats.<span class="property">size</span>;</span><br><span class="line">    <span class="keyword">const</span> end = positions[<span class="number">1</span>] ? <span class="built_in">parseInt</span>(positions[<span class="number">1</span>], <span class="number">10</span>) : total - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> chunksize = end - start + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">writeHead</span>(<span class="number">206</span>, &#123;</span><br><span class="line">      <span class="string">&#x27;Content-Range&#x27;</span>: <span class="string">`bytes <span class="subst">$&#123;start&#125;</span>-<span class="subst">$&#123;end&#125;</span>/<span class="subst">$&#123;total&#125;</span>`</span>,</span><br><span class="line">      <span class="string">&#x27;Accept-Ranges&#x27;</span>: <span class="string">&#x27;bytes&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Content-Length&#x27;</span>: chunksize,</span><br><span class="line">      <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;video/mp4&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> stream = fs.<span class="title function_">createReadStream</span>(filePath, &#123; start, end &#125;)</span><br><span class="line">      .<span class="title function_">on</span>(<span class="string">&#x27;open&#x27;</span>, <span class="function">() =&gt;</span> stream.<span class="title function_">pipe</span>(res))</span><br><span class="line">      .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> res.<span class="title function_">end</span>(err));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="客户端播放视频"><a href="#客户端播放视频" class="headerlink" title="客户端播放视频"></a>客户端播放视频</h4><p>在 <code>public</code></p>
<p>目录下创建一个 <code>index.html</code> 文件，用于客户端播放视频：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Video Player<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;videoPlayer&quot;</span> <span class="attr">controls</span> <span class="attr">width</span>=<span class="string">&quot;600&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">&quot;/video/sample.mp4&quot;</span> <span class="attr">type</span>=<span class="string">&quot;video/mp4&quot;</span>&gt;</span></span><br><span class="line">    Your browser does not support the video tag.</span><br><span class="line">  <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完整代码示例"><a href="#完整代码示例" class="headerlink" title="完整代码示例"></a>完整代码示例</h3><p>整合上述所有代码，我们的 <code>server.js</code> 文件如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&#x27;multer&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ffmpeg = <span class="built_in">require</span>(<span class="string">&#x27;fluent-ffmpeg&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置静态文件目录</span></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;public&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置文件上传存储位置</span></span><br><span class="line"><span class="keyword">const</span> storage = multer.<span class="title function_">diskStorage</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">cb</span>(<span class="literal">null</span>, <span class="string">&#x27;uploads/&#x27;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">filename</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">cb</span>(<span class="literal">null</span>, <span class="title class_">Date</span>.<span class="title function_">now</span>() + path.<span class="title function_">extname</span>(file.<span class="property">originalname</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> upload = <span class="title function_">multer</span>(&#123;</span><br><span class="line">  storage,</span><br><span class="line">  <span class="attr">limits</span>: &#123; <span class="attr">fileSize</span>: <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span> &#125;, <span class="comment">// 限制文件大小为 100MB</span></span><br><span class="line">  <span class="attr">fileFilter</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> filetypes = <span class="regexp">/mp4|mkv|avi/</span>;</span><br><span class="line">    <span class="keyword">const</span> mimetype = filetypes.<span class="title function_">test</span>(file.<span class="property">mimetype</span>);</span><br><span class="line">    <span class="keyword">const</span> extname = filetypes.<span class="title function_">test</span>(path.<span class="title function_">extname</span>(file.<span class="property">originalname</span>).<span class="title function_">toLowerCase</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mimetype &amp;&amp; extname) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">cb</span>(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">cb</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;File type not supported&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视频上传处理</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;video&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filePath = req.<span class="property">file</span>.<span class="property">path</span>;</span><br><span class="line">  <span class="keyword">const</span> outputFilePath = <span class="string">&#x27;uploads/&#x27;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="string">&#x27;_watermarked.mp4&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> watermarkPath = <span class="string">&#x27;public/watermark.png&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ffmpeg</span>(filePath)</span><br><span class="line">    .<span class="title function_">outputOptions</span>(<span class="string">&#x27;-vf&#x27;</span>, <span class="string">`movie=<span class="subst">$&#123;watermarkPath&#125;</span> [watermark]; [in][watermark] overlay=10:10 [out]`</span>)</span><br><span class="line">    .<span class="title function_">output</span>(outputFilePath)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&#x27;Watermark added successfully: &#x27;</span> + outputFilePath);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Adding watermark failed&#x27;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">run</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视频流媒体播放</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/video/:filename&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> filePath = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;uploads&#x27;</span>, req.<span class="property">params</span>.<span class="property">filename</span>);</span><br><span class="line"></span><br><span class="line">  fs.<span class="title function_">stat</span>(filePath, <span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;File not found&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; range &#125; = req.<span class="property">headers</span>;</span><br><span class="line">    <span class="keyword">if</span> (!range) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">416</span>).<span class="title function_">send</span>(<span class="string">&#x27;Range not found&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> positions = range.<span class="title function_">replace</span>(<span class="regexp">/bytes=/</span>, <span class="string">&#x27;&#x27;</span>).<span class="title function_">split</span>(<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> start = <span class="built_in">parseInt</span>(positions[<span class="number">0</span>], <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">const</span> total = stats.<span class="property">size</span>;</span><br><span class="line">    <span class="keyword">const</span> end = positions[<span class="number">1</span>] ? <span class="built_in">parseInt</span>(positions[<span class="number">1</span>], <span class="number">10</span>) : total - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> chunksize = end - start + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">writeHead</span>(<span class="number">206</span>, &#123;</span><br><span class="line">      <span class="string">&#x27;Content-Range&#x27;</span>: <span class="string">`bytes <span class="subst">$&#123;start&#125;</span>-<span class="subst">$&#123;end&#125;</span>/<span class="subst">$&#123;total&#125;</span>`</span>,</span><br><span class="line">      <span class="string">&#x27;Accept-Ranges&#x27;</span>: <span class="string">&#x27;bytes&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Content-Length&#x27;</span>: chunksize,</span><br><span class="line">      <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;video/mp4&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> stream = fs.<span class="title function_">createReadStream</span>(filePath, &#123; start, end &#125;)</span><br><span class="line">      .<span class="title function_">on</span>(<span class="string">&#x27;open&#x27;</span>, <span class="function">() =&gt;</span> stream.<span class="title function_">pipe</span>(res))</span><br><span class="line">      .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> res.<span class="title function_">end</span>(err));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server is running on http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="完整的目录结构"><a href="#完整的目录结构" class="headerlink" title="完整的目录结构"></a>完整的目录结构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">video-server/</span><br><span class="line">├── node_modules/</span><br><span class="line">├── public/</span><br><span class="line">│   ├── index.html</span><br><span class="line">│   └── watermark.png</span><br><span class="line">├── uploads/</span><br><span class="line">├── package.json</span><br><span class="line">├── package-lock.json</span><br><span class="line">└── server.js</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在本篇文章中，我们详细介绍了如何使用 Node.js 和 FFmpeg 搭建一个功能强大的视频服务器。从环境搭建、项目初始化、视频处理、文件上传与存储到视频流媒体播放，我们一步步实现了一个完整的解决方案。</p>
<p>通过学习本文，您应该对以下内容有了更深入的了解：</p>
<ul>
<li>Node.js 与 FFmpeg 的基本使用</li>
<li>使用 <code>express</code> 创建 Web 服务器</li>
<li>使用 <code>multer</code> 处理文件上传</li>
<li>使用 <code>fluent-ffmpeg</code> 进行视频处理</li>
<li>实现视频流媒体播放</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nestjs/" rel="tag">nestjs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nextjs/" rel="tag">nextjs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nuxtjs/" rel="tag">nuxtjs</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/06/20/node-ffmpeg/" data-id="cly0yww960017q5qhgjtx2kz9" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-rspack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/06/12/rspack/" class="article-date">
  <time datetime="2024-06-12T15:12:10.000Z" itemprop="datePublished">2024-06-12</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/06/12/rspack/">Rspack：下一代前端编译工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="Rspack：下一代前端编译工具"><a href="#Rspack：下一代前端编译工具" class="headerlink" title="Rspack：下一代前端编译工具"></a>Rspack：下一代前端编译工具</h2><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在前端开发中，编译工具（如Webpack和Vite）扮演着至关重要的角色。它们不仅仅用于打包JavaScript文件，还负责处理CSS、图片等各种资源。随着前端项目的日益复杂，对编译工具的性能和效率的要求也越来越高。Rspack作为一款新兴的前端编译工具，以其高效的性能和灵活的配置正在引起广泛关注。</p>
<p>本文将深入探讨Rspack，比较其与Webpack和Vite在速度和生成文件体积上的差异，提供详细的案例分析，并探讨各编译工具的适用场景。</p>
<h3 id="一、什么是Rspack？"><a href="#一、什么是Rspack？" class="headerlink" title="一、什么是Rspack？"></a>一、什么是Rspack？</h3><p>Rspack是一款由ByteDance开发的高性能前端编译工具。它旨在解决现有编译工具在大型项目中的性能瓶颈，提供更快的编译速度和更小的生成文件体积。Rspack的设计灵感来源于Webpack，但在内部实现上进行了大量优化，特别是针对多核处理器的并行编译能力。</p>
<h4 id="Rspack的特点"><a href="#Rspack的特点" class="headerlink" title="Rspack的特点"></a>Rspack的特点</h4><ul>
<li><strong>高性能</strong>：通过并行编译和优化算法，Rspack能显著提高编译速度。</li>
<li><strong>易用性</strong>：保留了Webpack的配置风格，使开发者可以轻松上手。</li>
<li><strong>灵活性</strong>：支持多种插件和Loader，适用于各种前端技术栈。</li>
</ul>
<h3 id="二、Webpack：经典的前端编译工具"><a href="#二、Webpack：经典的前端编译工具" class="headerlink" title="二、Webpack：经典的前端编译工具"></a>二、Webpack：经典的前端编译工具</h3><p>Webpack作为最广泛使用的前端编译工具之一，其强大的功能和灵活的配置赢得了大量开发者的青睐。Webpack的生态系统非常丰富，几乎可以处理所有类型的前端资源和需求。</p>
<h4 id="Webpack的特点"><a href="#Webpack的特点" class="headerlink" title="Webpack的特点"></a>Webpack的特点</h4><ul>
<li><strong>功能强大</strong>：支持代码拆分、按需加载等高级功能。</li>
<li><strong>生态系统丰富</strong>：拥有大量的插件和Loader，几乎可以处理所有前端资源。</li>
<li><strong>灵活配置</strong>：通过配置文件可以实现高度自定义的打包策略。</li>
</ul>
<h3 id="三、Vite：下一代前端开发与构建工具"><a href="#三、Vite：下一代前端开发与构建工具" class="headerlink" title="三、Vite：下一代前端开发与构建工具"></a>三、Vite：下一代前端开发与构建工具</h3><p>Vite是由Vue.js的作者尤雨溪开发的一款前端构建工具，旨在提供极速的开发体验。Vite使用了现代浏览器支持的ES模块（ESM）和即时编译（HMR）技术，极大地提升了开发时的速度。</p>
<h4 id="Vite的特点"><a href="#Vite的特点" class="headerlink" title="Vite的特点"></a>Vite的特点</h4><ul>
<li><strong>极速启动</strong>：利用ES模块实现快速冷启动。</li>
<li><strong>即时编译</strong>：支持高效的热模块替换（HMR）。</li>
<li><strong>现代化设计</strong>：默认支持TypeScript、Vue、React等现代前端框架。</li>
</ul>
<h3 id="四、性能对比：Rspack-vs-Webpack-vs-Vite"><a href="#四、性能对比：Rspack-vs-Webpack-vs-Vite" class="headerlink" title="四、性能对比：Rspack vs Webpack vs Vite"></a>四、性能对比：Rspack vs Webpack vs Vite</h3><p>为了全面了解Rspack的性能，我们将通过一个实际项目对比Rspack、Webpack和Vite的编译速度和生成文件体积。</p>
<h4 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h4><ul>
<li>硬件：8核16线程CPU，32GB内存</li>
<li>软件：Node.js 16.x，Windows 10</li>
<li>项目：一个包含React、TypeScript、CSS、图片等资源的中型前端项目</li>
</ul>
<h4 id="编译速度测试"><a href="#编译速度测试" class="headerlink" title="编译速度测试"></a>编译速度测试</h4><p>我们分别使用Rspack、Webpack和Vite对项目进行开发构建和生产构建，并记录每次构建所需的时间。</p>
<h5 id="开发构建速度"><a href="#开发构建速度" class="headerlink" title="开发构建速度"></a>开发构建速度</h5><ol>
<li><strong>Rspack</strong>：冷启动时间约为3秒，热更新时间约为500毫秒。</li>
<li><strong>Webpack</strong>：冷启动时间约为10秒，热更新时间约为2秒。</li>
<li><strong>Vite</strong>：冷启动时间约为1秒，热更新时间约为200毫秒。</li>
</ol>
<h5 id="生产构建速度"><a href="#生产构建速度" class="headerlink" title="生产构建速度"></a>生产构建速度</h5><ol>
<li><strong>Rspack</strong>：构建时间约为20秒。</li>
<li><strong>Webpack</strong>：构建时间约为60秒。</li>
<li><strong>Vite</strong>：构建时间约为30秒。</li>
</ol>
<h4 id="生成文件体积"><a href="#生成文件体积" class="headerlink" title="生成文件体积"></a>生成文件体积</h4><p>我们对生成的文件进行分析，比较它们的体积大小。</p>
<ol>
<li><strong>Rspack</strong>：总大小约为1.5MB。</li>
<li><strong>Webpack</strong>：总大小约为2.0MB。</li>
<li><strong>Vite</strong>：总大小约为1.8MB。</li>
</ol>
<h4 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h4><p>从测试结果可以看出，Rspack在编译速度和生成文件体积方面都有显著优势。在开发构建中，Rspack的冷启动时间和热更新时间都明显快于Webpack，但略慢于Vite。在生产构建中，Rspack的速度则远超Webpack，与Vite相近。此外，Rspack生成的文件体积最小，这对于优化网络传输和加载速度非常有利。</p>
<h3 id="五、详细案例分析：使用Rspack的项目"><a href="#五、详细案例分析：使用Rspack的项目" class="headerlink" title="五、详细案例分析：使用Rspack的项目"></a>五、详细案例分析：使用Rspack的项目</h3><p>接下来，我们通过一个实际项目展示如何使用Rspack，并详细讲解其配置和优化策略。</p>
<h4 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h4><p>我们将使用一个React + TypeScript项目作为示例。项目包含以下主要部分：</p>
<ul>
<li><strong>React组件</strong>：用于构建用户界面。</li>
<li><strong>TypeScript</strong>：用于类型检查和代码提示。</li>
<li><strong>CSS</strong>：用于样式管理。</li>
<li><strong>图片</strong>：用于展示图像资源。</li>
</ul>
<h4 id="安装和配置Rspack"><a href="#安装和配置Rspack" class="headerlink" title="安装和配置Rspack"></a>安装和配置Rspack</h4><p>首先，我们需要安装Rspack和相关依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install rspack rspack-cli --save-dev</span><br></pre></td></tr></table></figure>

<p>接着，在项目根目录下创建一个<code>rspack.config.js</code>文件，配置Rspack：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index.tsx&#x27;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;bundle.js&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.tsx?$/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&#x27;ts-loader&#x27;</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|jpg|gif)$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;file-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;[name].[hash].[ext]&#x27;</span>,</span><br><span class="line">              <span class="attr">outputPath</span>: <span class="string">&#x27;images&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">extensions</span>: [<span class="string">&#x27;.tsx&#x27;</span>, <span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.js&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="优化Rspack配置"><a href="#优化Rspack配置" class="headerlink" title="优化Rspack配置"></a>优化Rspack配置</h4><p>为进一步优化编译速度和生成文件体积，我们可以采取以下措施：</p>
<h5 id="使用thread-loader进行多线程编译"><a href="#使用thread-loader进行多线程编译" class="headerlink" title="使用thread-loader进行多线程编译"></a>使用<code>thread-loader</code>进行多线程编译</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// ... 其他配置</span></span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.tsx?$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="string">&#x27;thread-loader&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;ts-loader&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// ... 其他规则</span></span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="启用生产环境优化"><a href="#启用生产环境优化" class="headerlink" title="启用生产环境优化"></a>启用生产环境优化</h5><p>在生产环境中，我们可以启用代码压缩和Tree Shaking等优化策略：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">TerserPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;terser-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// ... 其他配置</span></span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimize</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">minimizer</span>: [<span class="keyword">new</span> <span class="title class_">TerserPlugin</span>()],</span><br><span class="line">    <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">      <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用Rspack进行开发和构建"><a href="#使用Rspack进行开发和构建" class="headerlink" title="使用Rspack进行开发和构建"></a>使用Rspack进行开发和构建</h4><p>安装完成并配置好Rspack后，我们可以通过以下命令进行开发和生产构建：</p>
<h5 id="开发模式"><a href="#开发模式" class="headerlink" title="开发模式"></a>开发模式</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx rspack serve</span><br></pre></td></tr></table></figure>

<h5 id="生产模式"><a href="#生产模式" class="headerlink" title="生产模式"></a>生产模式</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx rspack build</span><br></pre></td></tr></table></figure>

<h3 id="六、各编译工具的适用场景"><a href="#六、各编译工具的适用场景" class="headerlink" title="六、各编译工具的适用场景"></a>六、各编译工具的适用场景</h3><p>尽管Rspack在性能上具有明显优势，但不同的项目和团队可能有不同的需求，因此我们也需要了解Webpack和Vite的适用场景。</p>
<h4 id="Webpack的适用场景"><a href="#Webpack的适用场景" class="headerlink" title="Webpack的适用场景"></a>Webpack的适用场景</h4><ul>
<li><strong>大型项目</strong>：Webpack的插件和Loader生态系统非常丰富，适合处理复杂的大型项目。</li>
<li><strong>多种资源类型</strong>：Webpack可以处理各种类型的资源，包括JavaScript、CSS、图片、字体等。</li>
<li><strong>高级功能需求</strong>：Webpack支持代码拆分、按需加载等高级功能，适用于需要这些功能的项目。</li>
</ul>
<h4 id="Vite的适用场景"><a href="#Vite的适用场景" class="headerlink" title="Vite的适用场景"></a>Vite的适用场景</h4><ul>
<li><strong>快速开发</strong>：Vite的快速冷启动和即时编译功能，使其非常适合快速迭代开发。</li>
<li><strong>现代框架</strong>：Vite默认支持Vue、React等现代前端框架，适合使用这些框架的项目。</li>
<li><strong>轻量级项目</strong>：Vite适合处理相对轻量的项目，尤其是在开发阶段。</li>
</ul>
<h4 id="Rspack的适用场景"><a href="#Rspack的适用场景" class="headerlink" title="Rspack的适用场景"></a>Rspack的适用场景</h4><ul>
<li><strong>高性能需求</strong>：Rspack在编译速度和生成文件体积上的优势使其非常适合需要高性能的项目。</li>
<li><strong>大型项目</strong>：Rspack的并行编译和优化能力，使其适合处理大型复杂项目。</li>
<li><strong>灵活配置</strong>：Rspack保留了Webpack的配置风格，适合需要灵活配置的项目。</li>
</ul>
<h3 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h3><p>Rspack作为一款新兴的前端编译工具，以其卓越的性能和灵活的配置正在快速崛起。通过与Webpack和Vite的对比，我们可以看到Rspack在编译速度和生成文件体积方面的优势。虽然各编译工具有各自的</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rspack/" rel="tag">rspack</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/06/12/rspack/" data-id="cly0yww99001hq5qhhh3u81wv" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-nextjs-nuxtjs-nestjs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/06/08/nextjs-nuxtjs-nestjs/" class="article-date">
  <time datetime="2024-06-08T18:20:12.000Z" itemprop="datePublished">2024-06-08</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/06/08/nextjs-nuxtjs-nestjs/">Next.js、Nuxt.js 和 NestJS 的全面介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="Next-js、Nuxt-js-和-NestJS-的全面介绍"><a href="#Next-js、Nuxt-js-和-NestJS-的全面介绍" class="headerlink" title="Next.js、Nuxt.js 和 NestJS 的全面介绍"></a>Next.js、Nuxt.js 和 NestJS 的全面介绍</h2><p>在现代Web开发中，选择合适的框架是构建高效、可维护和可扩展应用程序的关键。Next.js、NestJS 和 Nuxt.js 是当前流行的三个JavaScript框架，它们各自有独特的特点和应用场景。本文将详细介绍这三个框架的基本概念、核心功能、使用示例及其各自的优缺点，帮助开发者更好地理解并选择合适的框架。</p>
<h3 id="Next-js-介绍"><a href="#Next-js-介绍" class="headerlink" title="Next.js 介绍"></a>Next.js 介绍</h3><p>Next.js 是一个用于构建服务端渲染 (SSR) 和静态网站生成 (SSG) 的React框架，由Vercel开发和维护。Next.js 提供了许多开箱即用的功能，使得开发者能够轻松构建高性能的Web应用。</p>
<h4 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h4><ul>
<li>**服务端渲染 (SSR)**：Next.js 默认支持服务端渲染，可以显著提高页面的初始加载速度和SEO性能。</li>
<li>**静态网站生成 (SSG)**：Next.js 支持静态网站生成，能够在构建时生成所有页面的HTML文件，进一步提升性能。</li>
<li><strong>API 路由</strong>：Next.js 提供内置的API路由功能，可以在同一个项目中创建API端点，而无需单独的后端服务器。</li>
<li><strong>文件系统路由</strong>：Next.js 使用基于文件系统的路由机制，开发者只需在 <code>pages</code> 目录中创建文件即可定义页面。</li>
<li><strong>CSS-in-JS</strong>：Next.js 支持多种CSS-in-JS解决方案，如styled-components和emotion，允许开发者将样式直接写在JavaScript中。</li>
</ul>
<h4 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h4><h5 id="创建一个简单的-Next-js-应用"><a href="#创建一个简单的-Next-js-应用" class="headerlink" title="创建一个简单的 Next.js 应用"></a>创建一个简单的 Next.js 应用</h5><p>首先，安装Next.js：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx create-next-app my-next-app</span><br><span class="line"><span class="built_in">cd</span> my-next-app</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>接下来，创建一个简单的页面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Head</span> <span class="keyword">from</span> <span class="string">&#x27;next/head&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>My Next.js App<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to Next.js!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="添加服务端渲染-SSR"><a href="#添加服务端渲染-SSR" class="headerlink" title="添加服务端渲染 (SSR)"></a>添加服务端渲染 (SSR)</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Head</span> <span class="keyword">from</span> <span class="string">&#x27;next/head&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params">&#123; message &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>My Next.js App<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;message&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getServerSideProps</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 这里可以进行数据获取操作</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;This is SSR!&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><p><strong>优点</strong>：</p>
<ul>
<li>简单易用，开箱即用。</li>
<li>强大的SSR和SSG支持，提升性能和SEO。</li>
<li>丰富的插件和社区支持。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>与传统的React开发相比，学习曲线稍陡。</li>
<li>一些高级功能需要深入理解和配置。</li>
</ul>
<h3 id="Nuxt-js-介绍"><a href="#Nuxt-js-介绍" class="headerlink" title="Nuxt.js 介绍"></a>Nuxt.js 介绍</h3><p>Nuxt.js 是一个基于Vue.js的框架，用于构建服务端渲染 (SSR) 和静态网站生成 (SSG) 的应用。Nuxt.js 提供了许多开箱即用的功能，使得开发者能够轻松构建高性能的Vue应用。</p>
<h4 id="核心功能-1"><a href="#核心功能-1" class="headerlink" title="核心功能"></a>核心功能</h4><ul>
<li>**服务端渲染 (SSR)**：Nuxt.js 默认支持服务端渲染，提升页面的初始加载速度和SEO性能。</li>
<li>**静态网站生成 (SSG)**：Nuxt.js 支持静态网站生成，能够在构建时生成所有页面的HTML文件。</li>
<li><strong>自动化路由</strong>：Nuxt.js 使用文件系统自动生成路由，无需手动配置。</li>
<li><strong>模块系统</strong>：Nuxt.js 提供强大的模块系统，允许开发者通过插件和模块扩展功能。</li>
<li><strong>Vuex 状态管理</strong>：Nuxt.js 内置对Vuex的支持，便于状态管理。</li>
</ul>
<h4 id="使用示例-1"><a href="#使用示例-1" class="headerlink" title="使用示例"></a>使用示例</h4><h5 id="创建一个简单的-Nuxt-js-应用"><a href="#创建一个简单的-Nuxt-js-应用" class="headerlink" title="创建一个简单的 Nuxt.js 应用"></a>创建一个简单的 Nuxt.js 应用</h5><p>首先，安装Nuxt.js：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx create-nuxt-app my-nuxt-app</span><br><span class="line"><span class="built_in">cd</span> my-nuxt-app</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p>创建一个简单的页面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pages/index.vue --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to Nuxt.js!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="添加服务端渲染-SSR-1"><a href="#添加服务端渲染-SSR-1" class="headerlink" title="添加服务端渲染 (SSR)"></a>添加服务端渲染 (SSR)</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pages/index.vue --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">async</span> <span class="title function_">asyncData</span>(<span class="params">&#123; $axios &#125;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> message = <span class="keyword">await</span> $axios.$get(<span class="string">&#x27;https://api.example.com/message&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123; message &#125;;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h4><p><strong>优点</strong>：</p>
<ul>
<li>强大的SSR和SSG支持，提升性能和SEO。</li>
<li>自动化路由和模块系统，简化开发流程。</li>
<li>与Vue.js生态系统无缝集成，支持Vuex和Vue Router。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>与传统的Vue.js开发相比，学习曲线稍陡。</li>
<li>一些高级功能需要深入理解和配置。</li>
</ul>
<h3 id="NestJS-介绍"><a href="#NestJS-介绍" class="headerlink" title="NestJS 介绍"></a>NestJS 介绍</h3><p>NestJS 是一个用于构建高效、可扩展的服务端应用的Node.js框架，受Angular启发，采用了现代JavaScript和TypeScript。NestJS 提供了强类型支持、模块化结构和依赖注入等功能，非常适合构建企业级应用。</p>
<h4 id="核心功能-2"><a href="#核心功能-2" class="headerlink" title="核心功能"></a>核心功能</h4><ul>
<li><strong>模块化架构</strong>：NestJS 使用模块化结构，使得应用程序易于维护和扩展。</li>
<li><strong>依赖注入</strong>：NestJS 内置依赖注入机制，简化了组件间的依赖管理。</li>
<li><strong>装饰器</strong>：NestJS 使用装饰器定义控制器、服务、模块等，代码清晰易读。</li>
<li><strong>中间件和拦截器</strong>：NestJS 提供中间件和拦截器功能，便于处理请求和响应。</li>
<li><strong>与多种数据库和ORM集成</strong>：NestJS 支持与TypeORM、Sequelize、Mongoose等多种数据库和ORM集成。</li>
</ul>
<h4 id="使用示例-2"><a href="#使用示例-2" class="headerlink" title="使用示例"></a>使用示例</h4><h5 id="创建一个简单的-NestJS-应用"><a href="#创建一个简单的-NestJS-应用" class="headerlink" title="创建一个简单的 NestJS 应用"></a>创建一个简单的 NestJS 应用</h5><p>首先，安装NestJS CLI：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm i -g @nestjs/cli</span><br><span class="line">nest new my-nest-app</span><br><span class="line"><span class="built_in">cd</span> my-nest-app</span><br><span class="line">npm run start</span><br></pre></td></tr></table></figure>

<p>创建一个简单的控制器：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/app.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, NestJS!&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="使用依赖注入"><a href="#使用依赖注入" class="headerlink" title="使用依赖注入"></a>使用依赖注入</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/app.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppService</span> &#123;</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, NestJS with DI!&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/app.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> appService: AppService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">appService</span>.<span class="title function_">getHello</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="优缺点"></a>优缺点</h4><p><strong>优点</strong>：</p>
<ul>
<li>强大的模块化和依赖注入机制。</li>
<li>代码清晰、易于维护和扩展。</li>
<li>丰富的装饰器和内置功能，提升开发效率。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>与传统的Node.js开发相比，学习曲线较陡。</li>
<li>对于小型项目，可能显得过于复杂。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><h4 id="Next-js"><a href="#Next-js" class="headerlink" title="Next.js"></a>Next.js</h4><p>Next.js 是一个基于React的框架，提供了SSR和SSG支持，使得开发者能够轻松构建高性能的Web应用。它的核心功能包括服务端渲染、静态网站生成、API路由和CSS-in-JS。Next.js 的优点是简单易用、开箱即用，适合各种规模的项目。然而，它的学习曲线稍陡，一些高级功能需要深入理解和配置。</p>
<h4 id="NestJS"><a href="#NestJS" class="headerlink" title="NestJS"></a>NestJS</h4><p>NestJS 是一个用于构建高效、可扩展的服务端应用的Node.js框架，采用了现代JavaScript和TypeScript。NestJS 提供了模块化架构、依赖注入、装饰器、中间件和拦截器等功能，非常适合构建企业级应用。它的优点是强大的模块化和依赖注入机制，代码清晰易于维护。然而，与传统的Node.js开发相比，学习曲线较陡，对于小型项目可能显得过于复杂。</p>
<h4 id="Nuxt-js"><a href="#Nuxt-js" class="headerlink" title="Nuxt.js"></a>Nuxt.js</h4><p>Nuxt.js 是一个基于Vue.js的框架，用于构建SSR和SSG的应用。Nuxt.js 提供了服务端渲染、静态网站生成、自动化路由</p>
<p>和模块系统等功能，支持Vuex状态管理。它的优点是强大的SSR和SSG支持，提升性能和SEO，自动化路由和模块系统简化开发流程。然而，与传统的Vue.js开发相比，学习曲线稍陡，一些高级功能需要深入理解和配置。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nestjs/" rel="tag">nestjs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nextjs/" rel="tag">nextjs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nuxtjs/" rel="tag">nuxtjs</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/06/08/nextjs-nuxtjs-nestjs/" data-id="cly0yww930012q5qhdo95bnz9" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-burial-point-sdk" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/06/01/burial-point-sdk/" class="article-date">
  <time datetime="2024-06-01T16:20:12.000Z" itemprop="datePublished">2024-06-01</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/06/01/burial-point-sdk/">前端异常监控与埋点收集SDK</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="前端异常监控与埋点收集SDK"><a href="#前端异常监控与埋点收集SDK" class="headerlink" title="前端异常监控与埋点收集SDK"></a>前端异常监控与埋点收集SDK</h2><p>在现代Web应用开发中，异常监控和埋点收集是优化用户体验、提高产品质量的重要手段。它们能够帮助开发者及时发现和解决问题，了解用户行为和需求，从而不断改进产品。本文将详细讲解如何设计和实现一个前端异常监控与埋点收集SDK，包括核心功能、设计思路和实际代码示例。</p>
<h3 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h3><h4 id="异常监控"><a href="#异常监控" class="headerlink" title="异常监控"></a>异常监控</h4><h5 id="什么是异常监控？"><a href="#什么是异常监控？" class="headerlink" title="什么是异常监控？"></a>什么是异常监控？</h5><p>异常监控是指通过监测前端应用在运行过程中产生的错误和异常，及时捕获并上报给开发者，以便他们快速定位并修复问题的过程。异常可能包括 JavaScript 运行时错误、网络请求失败、资源加载异常等。</p>
<h5 id="异常监控的重要性"><a href="#异常监控的重要性" class="headerlink" title="异常监控的重要性"></a>异常监控的重要性</h5><ul>
<li><strong>保障用户体验</strong>：异常会导致页面崩溃、功能失效，影响用户体验，及时发现并处理异常可以提高用户满意度。</li>
<li><strong>提升产品质量</strong>：持续监控异常可以帮助开发团队发现并修复潜在的问题，提升产品的稳定性和可靠性。</li>
<li><strong>降低维护成本</strong>：及时发现并修复异常可以减少后期维护成本，避免因问题逐渐积累而导致的复杂性增加。</li>
</ul>
<h5 id="异常监控实现方法"><a href="#异常监控实现方法" class="headerlink" title="异常监控实现方法"></a>异常监控实现方法</h5><p>异常监控的实现方法通常包括以下几个步骤：</p>
<ol>
<li><strong>捕获异常信息</strong>：通过 <code>window.onerror</code>、<code>try...catch</code> 等机制捕获 JavaScript 运行时错误。</li>
<li><strong>监听资源加载错误</strong>：通过 <code>window.addEventListener(&#39;error&#39;, handler)</code> 监听资源加载失败事件。</li>
<li><strong>收集并上报异常信息</strong>：将捕获到的异常信息发送到后台服务，以便开发者分析和处理。</li>
</ol>
<h4 id="埋点收集"><a href="#埋点收集" class="headerlink" title="埋点收集"></a>埋点收集</h4><h5 id="什么是埋点收集？"><a href="#什么是埋点收集？" class="headerlink" title="什么是埋点收集？"></a>什么是埋点收集？</h5><p>埋点收集是指在应用中通过埋点的方式记录用户的操作行为和使用情况，将这些数据上报到后台进行分析。埋点可以是页面访问、按钮点击、表单提交等用户行为。</p>
<h5 id="埋点收集的重要性"><a href="#埋点收集的重要性" class="headerlink" title="埋点收集的重要性"></a>埋点收集的重要性</h5><ul>
<li><strong>了解用户行为</strong>：通过收集用户的操作行为，开发者可以深入了解用户的喜好、习惯，为产品改进提供数据支持。</li>
<li><strong>优化产品体验</strong>：通过分析用户行为，发现和解决产品存在的问题，优化用户体验，提升产品价值。</li>
<li><strong>支持决策</strong>：埋点收集提供的数据可以帮助产品经理和运营团队制定更有针对性的决策和策略。</li>
</ul>
<h5 id="埋点收集实现方法"><a href="#埋点收集实现方法" class="headerlink" title="埋点收集实现方法"></a>埋点收集实现方法</h5><p>埋点收集的实现方法通常包括以下几个步骤：</p>
<ol>
<li><strong>标识需要收集的事件</strong>：确定需要收集的用户行为，如点击、浏览、提交等。</li>
<li><strong>添加埋点代码</strong>：在相关操作的触发事件中添加埋点代码，记录用户行为和相关信息。</li>
<li><strong>上报数据</strong>：将收集到的数据上报到后台服务，以便后续分析和处理。</li>
</ol>
<h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>在设计埋点收集SDK之前，我们需要明确以下需求：</p>
<ol>
<li><strong>事件收集</strong>：能够捕获和收集用户的各种操作行为，如页面访问、点击、表单提交等。</li>
<li><strong>数据上报</strong>：将收集到的数据发送到后台服务器进行存储和分析。</li>
<li><strong>灵活配置</strong>：支持灵活的配置和扩展，能够适应不同项目的需求。</li>
<li><strong>性能优化</strong>：保证埋点收集过程不会影响页面性能和用户体验。</li>
</ol>
<h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><p>我们的埋点收集SDK将包括以下几个核心模块：</p>
<ol>
<li><strong>初始化模块</strong>：初始化SDK，设置基本配置和参数。</li>
<li><strong>事件收集模块</strong>：提供API供开发者调用，收集各种用户操作行为。</li>
<li><strong>数据上报模块</strong>：将收集到的数据按需上报到后台服务器。</li>
<li><strong>工具函数模块</strong>：提供一些常用的工具函数，如生成唯一标识、格式化时间等。</li>
</ol>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><h4 id="初始化模块"><a href="#初始化模块" class="headerlink" title="初始化模块"></a>初始化模块</h4><p>首先，我们定义一个SDK的初始化模块，用于配置基本参数和设置全局变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Analytics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serverUrl</span> = options.<span class="property">serverUrl</span>; <span class="comment">// 数据上报的服务器地址</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">appId</span> = options.<span class="property">appId</span>; <span class="comment">// 应用标识</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userId</span> = <span class="variable language_">this</span>.<span class="title function_">getUserId</span>(); <span class="comment">// 获取用户标识</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span> = []; <span class="comment">// 事件队列</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getUserId</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> userId = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;userId&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!userId) &#123;</span><br><span class="line">      userId = <span class="string">&#x27;user-&#x27;</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substr</span>(<span class="number">2</span>, <span class="number">9</span>);</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;userId&#x27;</span>, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userId;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> analytics = <span class="keyword">new</span> <span class="title class_">Analytics</span>(&#123;</span><br><span class="line">  <span class="attr">serverUrl</span>: <span class="string">&#x27;https://your-server-url.com&#x27;</span>,</span><br><span class="line">  <span class="attr">appId</span>: <span class="string">&#x27;your-app-id&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="事件收集模块"><a href="#事件收集模块" class="headerlink" title="事件收集模块"></a>事件收集模块</h4><p>事件收集模块提供API供开发者调用，记录用户的各种操作行为。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Analytics</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">track</span>(<span class="params">event, properties</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> eventData = &#123;</span><br><span class="line">      event,</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        ...properties,</span><br><span class="line">        <span class="attr">appId</span>: <span class="variable language_">this</span>.<span class="property">appId</span>,</span><br><span class="line">        <span class="attr">userId</span>: <span class="variable language_">this</span>.<span class="property">userId</span>,</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>(eventData);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">sendData</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">sendData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (navigator.<span class="property">sendBeacon</span>) &#123;</span><br><span class="line">      navigator.<span class="title function_">sendBeacon</span>(<span class="variable language_">this</span>.<span class="property">serverUrl</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">queue</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">fetch</span>(<span class="variable language_">this</span>.<span class="property">serverUrl</span>, &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">queue</span>)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="数据上报模块"><a href="#数据上报模块" class="headerlink" title="数据上报模块"></a>数据上报模块</h4><p>数据上报模块负责将收集到的事件数据发送到后台服务器。为了提高性能和数据可靠性，我们可以使用 <code>navigator.sendBeacon</code> 或 <code>fetch</code> 进行数据上报。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Analytics</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">sendData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (navigator.<span class="property">sendBeacon</span>) &#123;</span><br><span class="line">      navigator.<span class="title function_">sendBeacon</span>(<span class="variable language_">this</span>.<span class="property">serverUrl</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">queue</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">fetch</span>(<span class="variable language_">this</span>.<span class="property">serverUrl</span>, &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">queue</span>)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="工具函数模块"><a href="#工具函数模块" class="headerlink" title="工具函数模块"></a>工具函数模块</h4><p>工具函数模块提供一些常用的工具函数，如生成唯一标识、格式化时间等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">generateUniqueId</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;id-&#x27;</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substr</span>(<span class="number">2</span>, <span class="number">9</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">formatTime</span>(<span class="params">date</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> date.<span class="title function_">toISOString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h4><p>结合以上模块，我们实现一个完整的前端埋点收集SDK：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">generateUniqueId</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;id-&#x27;</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substr</span>(<span class="number">2</span>, <span class="number">9</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">formatTime</span>(<span class="params">date</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> date.<span class="title function_">toISOString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Analytics</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serverUrl</span> = options.<span class="property">serverUrl</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">appId</span> = options.<span class="property">appId</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userId</span> = <span class="variable language_">this</span>.<span class="title function_">getUserId</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getUserId</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> userId = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;userId&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!userId) &#123;</span><br><span class="line">      userId = <span class="string">&#x27;user-&#x27;</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substr</span>(<span class="number">2</span>, <span class="number">9</span>);</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;userId&#x27;</span>, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">track</span>(<span class="params">event, properties = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> eventData = &#123;</span><br><span class="line">      event,</span><br><span class="line">      <span class="attr">properties</span>: &#123;</span><br><span class="line">        ...properties,</span><br><span class="line">        <span class="attr">appId</span>: <span class="variable language_">this</span>.<span class="property">appId</span>,</span><br><span class="line">        <span class="attr">userId</span>: <span class="variable language_">this</span>.<span class="property">userId</span>,</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="title class_">Utils</span>.<span class="title function_">formatTime</span>(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>(eventData);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">sendData</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">sendData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (navigator.<span class="property">sendBeacon</span>) &#123;</span><br><span class="line">      navigator.<span class="title function_">sendBeacon</span>(<span class="variable language_">this</span>.<span class="property">serverUrl</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">queue</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">fetch</span>(<span class="variable language_">this</span>.<span class="property">serverUrl</span>, &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">queue</span>)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span> = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 SDK</span></span><br><span class="line"><span class="keyword">const</span> analytics = <span class="keyword">new</span> <span class="title class_">Analytics</span>(&#123;</span><br><span class="line">  <span class="attr">serverUrl</span>: <span class="string">&#x27;https://your-server-url.com&#x27;</span>,</span><br><span class="line">  <span class="attr">appId</span>: <span class="string">&#x27;your-app-id&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录页面访问事件</span></span><br><span class="line">analytics.<span class="title function_">track</span>(<span class="string">&#x27;page_view&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">page</span>: <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录按钮点击事件</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;btn&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  analytics.<span class="title function_">track</span>(<span class="string">&#x27;button_click&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">button_id</span>: <span class="string">&#x27;btn&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="第三方工具"><a href="#第三方工具" class="headerlink" title="第三方工具"></a>第三方工具</h3><h4 id="异常监控实例：使用-Sentry"><a href="#异常监控实例：使用-Sentry" class="headerlink" title="异常监控实例：使用 Sentry"></a>异常监控实例：使用 Sentry</h4><p><a href="https://sentry.io/">Sentry</a> 是一个流行的异常监控工具，提供了强大的异常监控和错误追踪功能。以下是使用 Sentry 的示例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Sentry</span> <span class="keyword">from</span> <span class="string">&#x27;@sentry/browser&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Sentry</span>.<span class="title function_">init</span>(&#123;</span><br><span class="line">  <span class="attr">dsn</span>: <span class="string">&#x27;YOUR_SENTRY_DSN&#x27;</span>,</span><br><span class="line">  <span class="comment">// 其他配置项...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 捕获 JavaScript 运行时错误</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params">message, source, lineno, colno, error</span>) &#123;</span><br><span class="line">  <span class="title class_">Sentry</span>.<span class="title function_">captureException</span>(error);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听资源加载失败事件</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="title class_">Sentry</span>.<span class="title function_">captureException</span>(event.<span class="property">error</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过以上代码，我们可以将 JavaScript 运行时错误和资源加载失败等异常信息实时上报到 Sentry 平台，方便开发者及时发现和解决问题。</p>
<h4 id="埋点收集实例：使用神策分析"><a href="#埋点收集实例：使用神策分析" class="headerlink" title="埋点收集实例：使用神策分析"></a>埋点收集实例：使用神策分析</h4><p><a href="https://sensorsdata.cn/">神策分析</a> 是国内领先的用户行为分析工具，提供了强大的埋点收集和数据分析功能。以下是使用神策分析的示例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加埋点代码</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;btn&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  sa.<span class="title function_">track</span>(<span class="string">&#x27;button_click&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">button_id</span>: <span class="string">&#x27;btn&#x27;</span>,</span><br><span class="line">    <span class="attr">page_url</span>: <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上报数据</span></span><br><span class="line">sa.<span class="title function_">quick</span>(<span class="string">&#x27;autoTrackSinglePage&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>通过以上代码，我们可以在按钮点击事件中添加埋点代码，记录按钮的点击行为，并将相关信息上报到神策分析后台，以便后续分析用户行为和优化产品。</p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>通过设计和实现一个前端埋点收集SDK，我们可以更好地了解用户行为，优化产品体验，并及时发现和解决问题。</p>
<p>本文详细介绍了实现埋点收集SDK的各个模块及其功能。如果你有更多的需求或问题，可以在此基础上进行扩展和优化。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/06/01/burial-point-sdk/" data-id="cly0yww8k0001q5qhab82a2cs" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-service-worker-detail" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/05/28/service-worker-detail/" class="article-date">
  <time datetime="2024-05-28T18:20:12.000Z" itemprop="datePublished">2024-05-28</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/05/28/service-worker-detail/">Service Worker：提升Web应用性能和体验的利器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="Service-Worker：提升Web应用性能和体验的利器"><a href="#Service-Worker：提升Web应用性能和体验的利器" class="headerlink" title="Service Worker：提升Web应用性能和体验的利器"></a>Service Worker：提升Web应用性能和体验的利器</h2><p>在现代Web开发中，用户体验和性能至关重要。Service Worker作为一种独特的Web API，通过在后台独立于网页运行的脚本，为我们提供了强大的功能，可以显著提升Web应用的性能和用户体验。在本文中，我们将深入探讨Service Worker的工作原理、使用场景，并通过详细案例展示如何实现离线支持、推送通知以及跨标签页消息通信。</p>
<h3 id="什么是Service-Worker？"><a href="#什么是Service-Worker？" class="headerlink" title="什么是Service Worker？"></a>什么是Service Worker？</h3><p>Service Worker是一种驻留在用户浏览器中的后台脚本，可以拦截和控制网络请求，缓存资源，并处理推送通知等功能。与传统的Web Worker不同，Service Worker具有以下特点：</p>
<ol>
<li><strong>独立线程</strong>：Service Worker在浏览器的单独线程中运行，不会阻塞主线程。</li>
<li><strong>拦截网络请求</strong>：可以拦截、修改甚至完全取代网络请求。</li>
<li><strong>离线支持</strong>：通过缓存关键资源，实现离线访问。</li>
<li><strong>推送通知</strong>：支持后台推送通知，无需打开网页。</li>
<li><strong>跨标签页消息通信</strong>：在不同标签页之间发送和接收消息。</li>
<li><strong>生命周期管理</strong>：包括安装、激活和运行等生命周期事件。</li>
</ol>
<h3 id="Service-Worker的注册与安装"><a href="#Service-Worker的注册与安装" class="headerlink" title="Service Worker的注册与安装"></a>Service Worker的注册与安装</h3><p>在使用Service Worker之前，需要在JavaScript中注册它。以下是一个简单的注册示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;serviceWorker&#x27;</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">&#x27;/service-worker.js&#x27;</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">registration</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Service Worker registered with scope:&#x27;</span>, registration.<span class="property">scope</span>);</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Service Worker registration failed:&#x27;</span>, error);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述代码中，我们首先检查浏览器是否支持Service Worker。然后，在页面加载完成后，注册<code>/service-worker.js</code>文件。注册成功后，将输出注册成功的信息。</p>
<h3 id="Service-Worker的生命周期"><a href="#Service-Worker的生命周期" class="headerlink" title="Service Worker的生命周期"></a>Service Worker的生命周期</h3><p>Service Worker的生命周期包括以下几个阶段：</p>
<ol>
<li><strong>安装（Install）</strong>：在此阶段，Service Worker开始安装。通常，我们会在此阶段缓存应用的必要资源。</li>
<li><strong>激活（Activate）</strong>：安装完成后，Service Worker进入激活阶段。此时，我们可以清除旧的缓存。</li>
<li><strong>运行（Fetch）</strong>：激活后，Service Worker可以拦截和处理网络请求。</li>
</ol>
<h4 id="安装阶段"><a href="#安装阶段" class="headerlink" title="安装阶段"></a>安装阶段</h4><p>在安装阶段，我们可以预缓存应用的关键资源：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;install&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  event.<span class="title function_">waitUntil</span>(</span><br><span class="line">    caches.<span class="title function_">open</span>(<span class="string">&#x27;v1&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">cache</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> cache.<span class="title function_">addAll</span>([</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/index.html&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/styles.css&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/script.js&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/images/logo.png&#x27;</span></span><br><span class="line">      ]);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在上述代码中，<code>install</code>事件被触发时，Service Worker会打开名为<code>v1</code>的缓存，并将所有指定的资源添加到缓存中。</p>
<h4 id="激活阶段"><a href="#激活阶段" class="headerlink" title="激活阶段"></a>激活阶段</h4><p>在激活阶段，我们可以清理旧的缓存，以确保使用的是最新的资源：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;activate&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cacheWhitelist = [<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">  event.<span class="title function_">waitUntil</span>(</span><br><span class="line">    caches.<span class="title function_">keys</span>().<span class="title function_">then</span>(<span class="function"><span class="params">cacheNames</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">        cacheNames.<span class="title function_">map</span>(<span class="function"><span class="params">cacheName</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (cacheWhitelist.<span class="title function_">indexOf</span>(cacheName) === -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> caches.<span class="title function_">delete</span>(cacheName);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在上述代码中，我们定义了一个白名单<code>cacheWhitelist</code>，仅保留名为<code>v1</code>的缓存，删除其他所有缓存。</p>
<h4 id="运行阶段"><a href="#运行阶段" class="headerlink" title="运行阶段"></a>运行阶段</h4><p>在运行阶段，Service Worker可以拦截网络请求，并根据缓存策略返回缓存资源或发起网络请求：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  event.<span class="title function_">respondWith</span>(</span><br><span class="line">    caches.<span class="title function_">match</span>(event.<span class="property">request</span>).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (response) &#123;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">fetch</span>(event.<span class="property">request</span>).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> caches.<span class="title function_">open</span>(<span class="string">&#x27;v1&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">cache</span> =&gt;</span> &#123;</span><br><span class="line">          cache.<span class="title function_">put</span>(event.<span class="property">request</span>, response.<span class="title function_">clone</span>());</span><br><span class="line">          <span class="keyword">return</span> response;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在上述代码中，<code>fetch</code>事件被触发时，Service Worker首先检查缓存中是否有匹配的请求。如果有，直接返回缓存的响应；如果没有，发起网络请求，并将请求的响应添加到缓存中。</p>
<h3 id="实践案例：实现离线支持"><a href="#实践案例：实现离线支持" class="headerlink" title="实践案例：实现离线支持"></a>实践案例：实现离线支持</h3><p>为了更好地理解Service Worker，我们将通过一个实际案例来演示如何实现离线支持。假设我们有一个简单的静态网站，包括以下文件：</p>
<ul>
<li><code>index.html</code></li>
<li><code>styles.css</code></li>
<li><code>script.js</code></li>
<li><code>logo.png</code></li>
</ul>
<p>我们希望在用户第一次访问网站后，即使没有网络连接，也能离线访问这些资源。</p>
<h4 id="步骤1：创建Service-Worker文件"><a href="#步骤1：创建Service-Worker文件" class="headerlink" title="步骤1：创建Service Worker文件"></a>步骤1：创建Service Worker文件</h4><p>首先，创建一个名为<code>service-worker.js</code>的文件，包含以下内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">CACHE_NAME</span> = <span class="string">&#x27;v1&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> urlsToCache = [</span><br><span class="line">  <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;/index.html&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;/styles.css&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;/script.js&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;/images/logo.png&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;install&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  event.<span class="title function_">waitUntil</span>(</span><br><span class="line">    caches.<span class="title function_">open</span>(<span class="variable constant_">CACHE_NAME</span>).<span class="title function_">then</span>(<span class="function"><span class="params">cache</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> cache.<span class="title function_">addAll</span>(urlsToCache);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;activate&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cacheWhitelist = [<span class="variable constant_">CACHE_NAME</span>];</span><br><span class="line">  event.<span class="title function_">waitUntil</span>(</span><br><span class="line">    caches.<span class="title function_">keys</span>().<span class="title function_">then</span>(<span class="function"><span class="params">cacheNames</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">        cacheNames.<span class="title function_">map</span>(<span class="function"><span class="params">cacheName</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (cacheWhitelist.<span class="title function_">indexOf</span>(cacheName) === -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> caches.<span class="title function_">delete</span>(cacheName);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  event.<span class="title function_">respondWith</span>(</span><br><span class="line">    caches.<span class="title function_">match</span>(event.<span class="property">request</span>).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (response) &#123;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">fetch</span>(event.<span class="property">request</span>).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> caches.<span class="title function_">open</span>(<span class="variable constant_">CACHE_NAME</span>).<span class="title function_">then</span>(<span class="function"><span class="params">cache</span> =&gt;</span> &#123;</span><br><span class="line">          cache.<span class="title function_">put</span>(event.<span class="property">request</span>, response.<span class="title function_">clone</span>());</span><br><span class="line">          <span class="keyword">return</span> response;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：注册Service-Worker"><a href="#步骤2：注册Service-Worker" class="headerlink" title="步骤2：注册Service Worker"></a>步骤2：注册Service Worker</h4><p>接下来，在你的主JavaScript文件中注册Service Worker，例如在<code>script.js</code>中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;serviceWorker&#x27;</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">&#x27;/service-worker.js&#x27;</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">registration</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Service Worker registered with scope:&#x27;</span>, registration.<span class="property">scope</span>);</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Service Worker registration failed:&#x27;</span>, error);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤3：创建HTML文件"><a href="#步骤3：创建HTML文件" class="headerlink" title="步骤3：创建HTML文件"></a>步骤3：创建HTML文件</h4><p>最后，创建一个简单的<code>index.html</code>文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Service Worker Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/styles.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Service Worker Example<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>这个页面可以离线访问。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/images/logo.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Logo&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/script.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤4：创建CSS和其他资源文件"><a href="#步骤4：创建CSS和其他资源文件" class="headerlink" title="步骤4：创建CSS和其他资源文件"></a>步骤4：创建CSS和其他资源文件</h4><p>创建一个简单的<code>styles.css</code>文件：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: Arial, sans-serif;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">50px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">h1</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及一个示例图片<code>logo.png</code>和一个空的<code>script.js</code>文件。</p>
<h4 id="验证离线支持"><a href="#验证离线支持" class="headerlink" title="验证离线支持"></a>验证离线支持</h4><p>完成上述步骤后，启动你的服务器并访问网页。首次加载后，断开网络连接，刷新页面，应该能够看到缓存的内容，从而实现离线访问。</p>
<h3 id="推送通知"><a href="#推送通知" class="headerlink" title="推送通知"></a>推送通知</h3><p>除了离线支持和缓存策略，Service Worker还可以用于实现推送通知。推送通知可以在用户不活跃时向其发送信息，增加用户的参与度。以下是实现推送通知的步骤。</p>
<h4 id="步骤1：获取用户许可"><a href="#步骤1：获取用户许可" class="headerlink" title="步骤1：获取用户许可"></a>步骤1：获取用户许可</h4><p>首先，我们需要获取用户的许可来显示通知：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Notification</span>.<span class="title function_">requestPermission</span>().<span class="title function_">then</span>(<span class="function"><span class="params">permission</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (permission === <span class="string">&#x27;granted&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Notification permission granted.&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Notification permission denied.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：订阅推送服务"><a href="#步骤2：订阅推送服务" class="headerlink" title="步骤2：订阅推送服务"></a>步骤2：订阅推送服务</h4><p>我们需要使用浏览器的推送API订阅推送服务。这里我们假设你已经在服务器上设置了推送服务。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="property">serviceWorker</span>.<span class="property">ready</span>.<span class="title function_">then</span>(<span class="function"><span class="params">registration</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> publicKey = <span class="string">&#x27;YOUR_PUBLIC_VAPID_KEY&#x27;</span>; <span class="comment">// 使用VAPID公钥</span></span><br><span class="line">  registration.<span class="property">pushManager</span>.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">userVisibleOnly</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">applicationServerKey</span>: <span class="title function_">urlBase64ToUint8Array</span>(publicKey)</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">subscription</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;User is subscribed:&#x27;</span>, subscription);</span><br><span class="line">    <span class="comment">// 发送订阅信息到服务器</span></span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to subscribe the user: &#x27;</span>, err);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">urlBase64ToUint8Array</span>(<span class="params">base64String</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> padding = <span class="string">&#x27;=&#x27;</span>.<span class="title function_">repeat</span>((<span class="number">4</span> - base64String.<span class="property">length</span> % <span class="number">4</span>) % <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">const</span> base64 = (base64String + padding)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/\-/g</span>, <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/_/g</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rawData = <span class="variable language_">window</span>.<span class="title function_">atob</span>(base64</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line">  <span class="keyword">const</span> outputArray = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(rawData.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; rawData.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">    outputArray[i] = rawData.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> outputArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤3：处理推送事件"><a href="#步骤3：处理推送事件" class="headerlink" title="步骤3：处理推送事件"></a>步骤3：处理推送事件</h4><p>在<code>service-worker.js</code>中，我们需要监听推送事件，并显示通知：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;push&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> data = event.<span class="property">data</span>.<span class="title function_">json</span>();</span><br><span class="line">  <span class="keyword">const</span> options = &#123;</span><br><span class="line">    <span class="attr">body</span>: data.<span class="property">body</span>,</span><br><span class="line">    <span class="attr">icon</span>: <span class="string">&#x27;images/logo.png&#x27;</span>,</span><br><span class="line">    <span class="attr">badge</span>: <span class="string">&#x27;images/badge.png&#x27;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  event.<span class="title function_">waitUntil</span>(</span><br><span class="line">    self.<span class="property">registration</span>.<span class="title function_">showNotification</span>(data.<span class="property">title</span>, options)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="步骤4：响应通知点击事件"><a href="#步骤4：响应通知点击事件" class="headerlink" title="步骤4：响应通知点击事件"></a>步骤4：响应通知点击事件</h4><p>我们可以处理用户点击通知的事件，例如打开特定的页面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;notificationclick&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  event.<span class="property">notification</span>.<span class="title function_">close</span>();</span><br><span class="line">  event.<span class="title function_">waitUntil</span>(</span><br><span class="line">    clients.<span class="title function_">openWindow</span>(<span class="string">&#x27;https://www.example.com&#x27;</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="跨标签页消息通信"><a href="#跨标签页消息通信" class="headerlink" title="跨标签页消息通信"></a>跨标签页消息通信</h3><p>Service Worker还可以在不同的标签页或窗口之间进行消息通信，这对于同步数据或通知多个打开的页面非常有用。</p>
<h4 id="步骤1：向Service-Worker发送消息"><a href="#步骤1：向Service-Worker发送消息" class="headerlink" title="步骤1：向Service Worker发送消息"></a>步骤1：向Service Worker发送消息</h4><p>首先，我们需要向Service Worker发送消息。例如，在<code>script.js</code>中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>) &#123;</span><br><span class="line">  navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;SYNC_DATA&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123; <span class="attr">key</span>: <span class="string">&#x27;value&#x27;</span> &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：在Service-Worker中接收消息"><a href="#步骤2：在Service-Worker中接收消息" class="headerlink" title="步骤2：在Service Worker中接收消息"></a>步骤2：在Service Worker中接收消息</h4><p>在<code>service-worker.js</code>中，我们需要监听消息事件，并处理消息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Received message from main thread:&#x27;</span>, event.<span class="property">data</span>);</span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">data</span>.<span class="property">type</span> === <span class="string">&#x27;SYNC_DATA&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 处理接收到的数据</span></span><br><span class="line">    <span class="title function_">syncDataAcrossClients</span>(event.<span class="property">data</span>.<span class="property">data</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">syncDataAcrossClients</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  clients.<span class="title function_">matchAll</span>().<span class="title function_">then</span>(<span class="function"><span class="params">clientList</span> =&gt;</span> &#123;</span><br><span class="line">    clientList.<span class="title function_">forEach</span>(<span class="function"><span class="params">client</span> =&gt;</span> &#123;</span><br><span class="line">      client.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;DATA_SYNC&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: data</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤3：在标签页中接收消息"><a href="#步骤3：在标签页中接收消息" class="headerlink" title="步骤3：在标签页中接收消息"></a>步骤3：在标签页中接收消息</h4><p>最后，在其他标签页中接收来自Service Worker的消息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="property">serviceWorker</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">data</span>.<span class="property">type</span> === <span class="string">&#x27;DATA_SYNC&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Received sync data:&#x27;</span>, event.<span class="property">data</span>.<span class="property">data</span>);</span><br><span class="line">    <span class="comment">// 更新页面或执行其他操作</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过本文，我们详细介绍了Service Worker的工作原理、生命周期及其注册和使用方法。我们通过简单的案例展示了如何实现离线支持、推送通知以及跨标签页消息通信。Service Worker不仅可以提升网页性能，还能为用户提供更好的体验，使应用能够在离线状态下依然可用，并通过推送通知和跨标签页消息通信增强用户参与度。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/service-worker/" rel="tag">service worker</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/05/28/service-worker-detail/" data-id="cly0yww9d001uq5qh7xxg70se" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-limit_batch_request" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/05/20/limit_batch_request/" class="article-date">
  <time datetime="2024-05-20T15:20:12.000Z" itemprop="datePublished">2024-05-20</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/05/20/limit_batch_request/">JavaScript 批量请求管理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="JavaScript-批量请求管理"><a href="#JavaScript-批量请求管理" class="headerlink" title="JavaScript 批量请求管理"></a>JavaScript 批量请求管理</h2><p>在现代前端开发中，高效地管理多个并发请求至关重要。无论是从 API 获取数据、处理用户交互，还是处理文件，管理和限制同时进行的请求数量都能显著影响应用的性能和可靠性。在这篇博客文章中，我们将深入探讨使用 JavaScript 管理并发请求的细节，重点介绍如何实现限制并发请求数量的实用方案。</p>
<h3 id="为什么要限制并发请求？"><a href="#为什么要限制并发请求？" class="headerlink" title="为什么要限制并发请求？"></a>为什么要限制并发请求？</h3><p>在深入代码之前，让我们讨论一下为什么限制并发请求很重要：</p>
<ol>
<li><strong>服务器负载管理</strong>：限制并发请求数量可以防止服务器过载，从而更好地利用资源并保持服务器稳定。</li>
<li><strong>浏览器限制</strong>：浏览器对单个域名的同时连接数有限制，超过这个限制会导致请求排队，进而降低性能。</li>
<li><strong>速率限制</strong>：许多 API 强制执行速率限制，控制并发请求数量有助于遵守这些限制，避免被限速或禁止。</li>
<li><strong>用户体验</strong>：管理并发请求可以提高用户体验，确保应用保持响应，不会因为过多的后台活动而卡顿。</li>
</ol>
<h3 id="实现请求队列"><a href="#实现请求队列" class="headerlink" title="实现请求队列"></a>实现请求队列</h3><p>让我们在 JavaScript 中实现一个请求队列，以限制并发请求的数量。首先，定义一个模拟异步请求的 <code>fetch</code> 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fetch</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(url);</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个 <code>fetch</code> 函数接受一个 URL，返回一个在 3 秒后解决的 promise，模拟网络请求。</p>
<p>接下来，我们实现一个创建请求函数 <code>createRequest</code>，它能够限制并发请求的数量：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">createRequest</span> = (<span class="params">limit</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> queue = [];</span><br><span class="line">  <span class="keyword">let</span> working = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">url</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (working &lt; limit) &#123;</span><br><span class="line">        <span class="title function_">fetch</span>(url)</span><br><span class="line">          .<span class="title function_">then</span>(resolve, reject)</span><br><span class="line">          .<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            working--;</span><br><span class="line">            <span class="keyword">if</span> (queue.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">const</span> cur = queue.<span class="title function_">shift</span>();</span><br><span class="line">              <span class="title function_">request</span>(cur.<span class="property">url</span>).<span class="title function_">then</span>(cur.<span class="property">resolve</span>, cur.<span class="property">reject</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        working++;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        queue.<span class="title function_">push</span>(&#123; url, resolve, reject &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个 <code>createRequest</code> 函数接受一个限制数 <code>limit</code> 作为参数，返回一个请求函数 <code>request</code>。在 <code>request</code> 函数内部：</p>
<ul>
<li>如果当前正在进行的请求数量 <code>working</code> 小于 <code>limit</code>，则直接发起请求。</li>
<li>否则，将请求添加到队列 <code>queue</code> 中。</li>
</ul>
<p>在每个请求完成后，减少正在进行的请求数量 <code>working</code>，并检查队列中是否有待处理的请求，如果有，继续处理队列中的请求。</p>
<p>下面，我们来看看如何使用这个请求函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 等前五个任意一个请求结束后，真正发送请求</span></span><br><span class="line"><span class="keyword">const</span> request = <span class="title function_">createRequest</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">request</span>(<span class="string">&#x27;url1&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>, a));</span><br><span class="line"><span class="title function_">request</span>(<span class="string">&#x27;url2&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>, a));</span><br><span class="line"><span class="title function_">request</span>(<span class="string">&#x27;url3&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>, a));</span><br><span class="line"><span class="title function_">request</span>(<span class="string">&#x27;url4&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4&#x27;</span>, a));</span><br><span class="line"><span class="title function_">request</span>(<span class="string">&#x27;url5&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;5&#x27;</span>, a));</span><br><span class="line"><span class="title function_">request</span>(<span class="string">&#x27;url6&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;6&#x27;</span>, a));</span><br><span class="line"><span class="title function_">request</span>(<span class="string">&#x27;url7&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;7&#x27;</span>, a));</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们创建了一个限制并发请求数为 5 的 <code>request</code> 函数，并依次发起了 7 个请求。只有在前 5 个请求中的任意一个完成后，才会开始处理后续的请求。</p>
<h3 id="实践案例"><a href="#实践案例" class="headerlink" title="实践案例"></a>实践案例</h3><p>假设我们有一个需要批量请求 API 的应用，比如一个展示用户数据的界面。我们希望同时发起的请求数不超过 5 个，以确保服务器稳定并优化用户体验。</p>
<p>首先，我们定义一个模拟 API 请求的 <code>fetchUserData</code> 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fetchUserData</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(<span class="string">`UserData for user <span class="subst">$&#123;userId&#125;</span>`</span>);</span><br><span class="line">    &#125;, <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">2000</span> + <span class="number">1000</span>); <span class="comment">// 随机延迟 1 到 3 秒</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们使用 <code>createRequest</code> 函数创建一个限制并发请求数为 5 的 <code>requestUserData</code> 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> requestUserData = <span class="title function_">createRequest</span>(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<p>接下来，我们批量请求用户数据，并将结果打印到控制台：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">  <span class="title function_">requestUserData</span>(<span class="string">`user<span class="subst">$&#123;i&#125;</span>`</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们模拟了 10 个用户数据请求，每次最多只有 5 个请求并发进行。每个请求完成后，立即处理队列中的下一个请求。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在这篇文章中，我们探讨了为什么限制并发请求很重要，并通过一个实用的例子演示了如何在 JavaScript 中实现一个请求队列。这个方法可以帮助我们更好地管理服务器负载、遵守 API 速率限制、优化浏览器性能，并提供更好的用户体验。</p>
<p>通过合理地管理并发请求，我们可以确保应用的稳定性和响应性，从而提升整体性能。如果你在开发中遇到需要批量处理请求的情况，希望本文的方法能对你有所帮助。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/05/20/limit_batch_request/" data-id="cly0yww90000vq5qh351q7w21" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-css-cloud" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/05/16/css-cloud/" class="article-date">
  <time datetime="2024-05-16T16:20:12.000Z" itemprop="datePublished">2024-05-16</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/05/16/css-cloud/">使用 CSS 创建逼真的云效果</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="使用-CSS-创建逼真的云效果"><a href="#使用-CSS-创建逼真的云效果" class="headerlink" title="使用 CSS 创建逼真的云效果"></a>使用 CSS 创建逼真的云效果</h2><p>在现代网页设计中，精美的视觉效果可以极大地提升用户体验。今天我们将学习如何使用 CSS 创建一个动态且逼真的云效果。本文将详细讲解实现这一效果的每一步，让你能够在自己的项目中轻松复用。</p>
<h3 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h3><p>我们将分步骤讲解以下代码片段，它展示了如何使用 CSS 和 SVG 滤镜创建云效果：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100vw</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">165deg</span>, <span class="number">#527785</span> <span class="number">0%</span>, <span class="number">#7FB4C7</span> <span class="number">100%</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">left</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-left</span>: -<span class="number">250px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.cloud</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">500px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">275px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">top</span>: -<span class="number">35vh</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">left</span>: -<span class="number">25vw</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-id">#cloud-back</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">filter</span>: <span class="built_in">url</span>(<span class="string">#filter-back</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-shadow</span>: <span class="number">300px</span> <span class="number">300px</span> <span class="number">30px</span> -<span class="number">20px</span> <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-id">#cloud-mid</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">filter</span>: <span class="built_in">url</span>(<span class="string">#filter-mid</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-shadow</span>: <span class="number">300px</span> <span class="number">340px</span> <span class="number">70px</span> -<span class="number">60px</span> <span class="built_in">rgba</span>(<span class="number">158</span>, <span class="number">168</span>, <span class="number">179</span>, <span class="number">0.5</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">left</span>: -<span class="number">25vw</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-id">#cloud-front</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">filter</span>: <span class="built_in">url</span>(<span class="string">#filter-front</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-shadow</span>: <span class="number">300px</span> <span class="number">370px</span> <span class="number">60px</span> -<span class="number">100px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">left</span>: -<span class="number">25vw</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cloud&quot;</span> <span class="attr">id</span>=<span class="string">&quot;cloud-back&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cloud&quot;</span> <span class="attr">id</span>=<span class="string">&quot;cloud-mid&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cloud&quot;</span> <span class="attr">id</span>=<span class="string">&quot;cloud-front&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;0&quot;</span> <span class="attr">height</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--Top Layer--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">id</span>=<span class="string">&quot;filter-back&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;4&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;170&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">id</span>=<span class="string">&quot;filter-mid&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;2&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;150&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">id</span>=<span class="string">&quot;filter-front&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;2&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;100&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="分析代码"><a href="#分析代码" class="headerlink" title="分析代码"></a>分析代码</h3><h4 id="1-设置背景和基本样式"><a href="#1-设置背景和基本样式" class="headerlink" title="1. 设置背景和基本样式"></a>1. 设置背景和基本样式</h4><p>首先，我们在 <code>body</code> 元素中设置了背景和基本样式：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100vw</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">165deg</span>, <span class="number">#527785</span> <span class="number">0%</span>, <span class="number">#7FB4C7</span> <span class="number">100%</span>);</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码为页面设置了全屏的线性渐变背景，从深蓝色渐变到浅蓝色，模拟天空的颜色。<code>margin</code> 和 <code>padding</code> 被设为 0，确保背景覆盖整个页面。</p>
<h4 id="2-创建容器"><a href="#2-创建容器" class="headerlink" title="2. 创建容器"></a>2. 创建容器</h4><p>接下来，我们创建了一个容器来包含云的元素：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">margin-left</span>: -<span class="number">250px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>container</code> 容器使用了 <code>relative</code> 定位，并通过 <code>left: 50%</code> 和 <code>margin-left: -250px</code> 将其水平居中。这个容器的宽度为 500px，因此通过负边距将其中心对齐。</p>
<h4 id="3-定义云的样式"><a href="#3-定义云的样式" class="headerlink" title="3. 定义云的样式"></a>3. 定义云的样式</h4><p>云是使用 <code>.cloud</code> 类创建的，我们定义了它的基本样式：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.cloud</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">500px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">275px</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">top</span>: -<span class="number">35vh</span>;</span><br><span class="line">  <span class="attribute">left</span>: -<span class="number">25vw</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个云元素都是一个 500px 宽、275px 高的椭圆形，使用 <code>border-radius: 50%</code> 来实现圆角。云的位置使用 <code>absolute</code> 定位，并通过 <code>top</code> 和 <code>left</code> 属性调整其初始位置。</p>
<h4 id="4-应用滤镜效果"><a href="#4-应用滤镜效果" class="headerlink" title="4. 应用滤镜效果"></a>4. 应用滤镜效果</h4><p>云的外观通过 SVG 滤镜实现，分别为不同层次的云定义了不同的滤镜效果：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#cloud-back</span> &#123;</span><br><span class="line">  <span class="attribute">filter</span>: <span class="built_in">url</span>(<span class="string">#filter-back</span>);</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">300px</span> <span class="number">300px</span> <span class="number">30px</span> -<span class="number">20px</span> <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#cloud-mid</span> &#123;</span><br><span class="line">  <span class="attribute">filter</span>: <span class="built_in">url</span>(<span class="string">#filter-mid</span>);</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">300px</span> <span class="number">340px</span> <span class="number">70px</span> -<span class="number">60px</span> <span class="built_in">rgba</span>(<span class="number">158</span>, <span class="number">168</span>, <span class="number">179</span>, <span class="number">0.5</span>);</span><br><span class="line">  <span class="attribute">left</span>: -<span class="number">25vw</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#cloud-front</span> &#123;</span><br><span class="line">  <span class="attribute">filter</span>: <span class="built_in">url</span>(<span class="string">#filter-front</span>);</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">300px</span> <span class="number">370px</span> <span class="number">60px</span> -<span class="number">100px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);</span><br><span class="line">  <span class="attribute">left</span>: -<span class="number">25vw</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个云元素都应用了不同的 SVG 滤镜，并使用 <code>box-shadow</code> 添加阴影效果。滤镜效果在 <code>svg</code> 标签中定义：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;0&quot;</span> <span class="attr">height</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--Top Layer--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span> <span class="attr">id</span>=<span class="string">&quot;filter-back&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;4&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;170&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span> <span class="attr">id</span>=<span class="string">&quot;filter-mid&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;2&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;150&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span> <span class="attr">id</span>=<span class="string">&quot;filter-front&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;2&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;100&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="5-滤镜详解"><a href="#5-滤镜详解" class="headerlink" title="5. 滤镜详解"></a>5. 滤镜详解</h4><h5 id="feTurbulence"><a href="#feTurbulence" class="headerlink" title="feTurbulence"></a><code>feTurbulence</code></h5><p><code>feTurbulence</code> 元素生成基于分形噪声的图像，创建一种类似于云的纹理：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;4&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>type</code>：指定噪声类型为分形噪声。</li>
<li><code>baseFrequency</code>：设置噪声频率，值越小，噪声图案越大。</li>
<li><code>numOctaves</code>：定义分形噪声的层数，值越大，细节越多。</li>
<li><code>seed</code>：确定噪声图案的随机种子。</li>
</ul>
<h5 id="feDisplacementMap"><a href="#feDisplacementMap" class="headerlink" title="feDisplacementMap"></a><code>feDisplacementMap</code></h5><p><code>feDisplacementMap</code> 元素使用噪声图像来变形云的形状，创建更加自然的外观：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;170&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>in</code>：指定输入图像。</li>
<li><code>scale</code>：定义位移的强度，值越大，变形效果越明显。</li>
</ul>
<h3 id="完整实现"><a href="#完整实现" class="headerlink" title="完整实现"></a>完整实现</h3><p>通过结合上述所有步骤，我们实现了一个逼真的云效果。以下是完整的代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100vw</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">165deg</span>, <span class="number">#527785</span> <span class="number">0%</span>, <span class="number">#7FB4C7</span> <span class="number">100%</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">left</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin-left</span>: -<span class="number">250px</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.cloud</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">500px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">275px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">top</span>: -<span class="number">35vh</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">left</span>: -<span class="number">25vw</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-id">#cloud-back</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">filter</span>: <span class="built_in">url</span>(<span class="string">#filter-back</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-shadow</span>: <span class="number">300px</span> <span class="number">300px</span> <span class="number">30px</span> -<span class="number">20px</span> <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-id">#cloud-mid</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">filter</span>: <span class="built_in">url</span>(<span class="string">#filter-mid</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-shadow</span>: <span class="number">300px</span> <span class="number">340px</span> <span class="number">70px</span> -<span class="number">60px</span> <span class="built_in">rgba</span>(<span class="number">158</span>, <span class="number">168</span>, <span class="number">179</span>, <span class="number">0.5</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">left</span>: -<span class="number">25vw</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-id">#cloud-front</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">filter</span>: <span class="built_in">url</span>(<span class="string">#filter-front</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">box-shadow</span>: <span class="number">300px</span> <span class="number">370px</span> <span class="number">60px</span> -<span class="number">100px</span></span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">left</span>: -<span class="number">25vw</span>;</span></span><br><span class="line"><span class="language-css">      &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cloud&quot;</span> <span class="attr">id</span>=<span class="string">&quot;cloud-back&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cloud&quot;</span> <span class="attr">id</span>=<span class="string">&quot;cloud-mid&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;cloud&quot;</span> <span class="attr">id</span>=<span class="string">&quot;cloud-front&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;0&quot;</span> <span class="attr">height</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--Top Layer--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">id</span>=<span class="string">&quot;filter-back&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;4&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;170&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">id</span>=<span class="string">&quot;filter-mid&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;2&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;150&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">id</span>=<span class="string">&quot;filter-front&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feTurbulence</span> <span class="attr">type</span>=<span class="string">&quot;fractalNoise&quot;</span> <span class="attr">baseFrequency</span>=<span class="string">&quot;0.012&quot;</span> <span class="attr">numOctaves</span>=<span class="string">&quot;2&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feTurbulence</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">feDisplacementMap</span> <span class="attr">in</span>=<span class="string">&quot;SourceGraphic&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;100&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">feDisplacementMap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过上述步骤，我们成功地使用 CSS 和 SVG 滤镜创建了一个逼真的云效果。这种技术可以用于多种场景，如背景动画、图形特效等。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/html/" rel="tag">html</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/05/16/css-cloud/" data-id="cly0yww8q0009q5qh32h3dzd4" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-typescript-config" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/05/12/typescript-config/" class="article-date">
  <time datetime="2024-05-12T08:12:06.000Z" itemprop="datePublished">2024-05-12</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/05/12/typescript-config/">TypeScript 配置详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="TypeScript-配置详解"><a href="#TypeScript-配置详解" class="headerlink" title="TypeScript 配置详解"></a>TypeScript 配置详解</h2><p>TypeScript 是一种由微软开发的开源编程语言，它是 JavaScript 的一个超集，添加了可选的静态类型和基于类的面向对象编程。</p>
<p>在 TypeScript 项目中，<code>tsconfig.json</code> 是一个用于配置 TypeScript 编译器的配置文件。通过配置 <code>tsconfig.json</code> 文件，我们可以指定编译器如何处理 TypeScript 代码，并设置一些编译选项来满足项目的需求。</p>
<p>以下是一个典型的 <code>tsconfig.json</code> 配置示例，我们将逐个字段进行详细解释：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">/* 通用编译选项 */</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">/* 基本选项 */</span></span><br><span class="line">    <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;es5&quot;</span><span class="punctuation">,</span>                       <span class="comment">// 指定 ECMAScript 目标版本: &#x27;ES3&#x27; (default), &#x27;ES5&#x27;, &#x27;ES6&#x27;/&#x27;ES2015&#x27;, &#x27;ES2016&#x27;, &#x27;ES2017&#x27;, or &#x27;ESNEXT&#x27;</span></span><br><span class="line">    <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;commonjs&quot;</span><span class="punctuation">,</span>                  <span class="comment">// 指定使用模块: &#x27;commonjs&#x27;, &#x27;amd&#x27;, &#x27;system&#x27;, &#x27;umd&#x27; or &#x27;es2015&#x27;</span></span><br><span class="line">    <span class="attr">&quot;lib&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>                             <span class="comment">// 指定要包含在编译中的库文件</span></span><br><span class="line">    <span class="attr">&quot;allowJs&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                       <span class="comment">// 允许编译 javascript 文件</span></span><br><span class="line">    <span class="attr">&quot;checkJs&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                       <span class="comment">// 报告 javascript 文件中的错误</span></span><br><span class="line">    <span class="attr">&quot;jsx&quot;</span><span class="punctuation">:</span> <span class="string">&quot;preserve&quot;</span><span class="punctuation">,</span>                     <span class="comment">// 指定 jsx 代码的生成: &#x27;preserve&#x27;, &#x27;react-native&#x27;, &#x27;react&#x27; or &#x27;react-jsx&#x27;等</span></span><br><span class="line">    <span class="attr">&quot;declaration&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                   <span class="comment">// 生成相应的 &#x27;.d.ts&#x27; 文件</span></span><br><span class="line">    <span class="attr">&quot;sourceMap&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                     <span class="comment">// 生成相应的 &#x27;.map&#x27; 文件</span></span><br><span class="line">    <span class="attr">&quot;outFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./&quot;</span><span class="punctuation">,</span>                       <span class="comment">// 将输出文件合并为一个文件</span></span><br><span class="line">    <span class="attr">&quot;outDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./&quot;</span><span class="punctuation">,</span>                        <span class="comment">// 指定输出目录</span></span><br><span class="line">    <span class="attr">&quot;rootDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./&quot;</span><span class="punctuation">,</span>                       <span class="comment">// 用来控制输出目录结构 --outDir.</span></span><br><span class="line">    <span class="attr">&quot;removeComments&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                <span class="comment">// 删除编译后的所有的注释</span></span><br><span class="line">    <span class="attr">&quot;noEmit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                        <span class="comment">// 不生成输出文件</span></span><br><span class="line">    <span class="attr">&quot;importHelpers&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                 <span class="comment">// 从 tslib 导入辅助工具函数</span></span><br><span class="line">    <span class="attr">&quot;isolatedModules&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>               <span class="comment">// 将每个文件作为单独的模块 （与 &#x27;ts.transpileModule&#x27; 类似）.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 严格的类型检查选项 */</span></span><br><span class="line">    <span class="attr">&quot;strict&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                        <span class="comment">// 启用所有严格类型检查选项</span></span><br><span class="line">    <span class="attr">&quot;noImplicitAny&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                 <span class="comment">// 在表达式和声明上有隐含的 any 类型时报错</span></span><br><span class="line">    <span class="attr">&quot;strictNullChecks&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>              <span class="comment">// 启用严格的 null 检查</span></span><br><span class="line">    <span class="attr">&quot;noImplicitThis&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                <span class="comment">// 当 this 表达式值为 any 类型的时候，生成一个错误</span></span><br><span class="line">    <span class="attr">&quot;alwaysStrict&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                  <span class="comment">// 以严格模式检查每个模块，并在每个文件里加入 &#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 额外的检查 */</span></span><br><span class="line">    <span class="attr">&quot;noUnusedLocals&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                <span class="comment">// 有未使用的变量时，抛出错误</span></span><br><span class="line">    <span class="attr">&quot;noUnusedParameters&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>            <span class="comment">// 有未使用的参数时，抛出错误</span></span><br><span class="line">    <span class="attr">&quot;noImplicitReturns&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>             <span class="comment">// 并不是所有函数里的代码都有返回值时，抛出错误</span></span><br><span class="line">    <span class="attr">&quot;noFallthroughCasesInSwitch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>    <span class="comment">// 报告 switch 语句的 fallthrough 错误。（即，不允许 switch 的 case 语句贯穿）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 模块解析选项 */</span></span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span>            <span class="comment">// 选择模块解析策略： &#x27;node&#x27; (Node.js) or &#x27;classic&#x27; (TypeScript pre-1.6)</span></span><br><span class="line">    <span class="attr">&quot;baseUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./&quot;</span><span class="punctuation">,</span>                       <span class="comment">// 用于解析非相对模块名称的基目录</span></span><br><span class="line">    <span class="attr">&quot;paths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>                           <span class="comment">// 模块名到基于 baseUrl 的路径映射的列表</span></span><br><span class="line">    <span class="attr">&quot;rootDirs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>                        <span class="comment">// 根文件夹列表，其组合内容表示项目运行时的结构内容</span></span><br><span class="line">    <span class="attr">&quot;typeRoots&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>                       <span class="comment">// 包含类型声明的文件列表</span></span><br><span class="line">    <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>                           <span class="comment">// 需要包含的类型声明文件名列表</span></span><br><span class="line">    <span class="attr">&quot;allowSyntheticDefaultImports&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>  <span class="comment">// 允许从没有设置默认导出的模块中默认导入。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Source Map Options */</span></span><br><span class="line">    <span class="attr">&quot;sourceRoot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./&quot;</span><span class="punctuation">,</span>                    <span class="comment">// 指定调试器应该找到 TypeScript 文件而不是源文件的位置</span></span><br><span class="line">    <span class="attr">&quot;mapRoot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./&quot;</span><span class="punctuation">,</span>                       <span class="comment">// 指定调试器应该找到映射文件而不是生成文件的位置</span></span><br><span class="line">    <span class="attr">&quot;inlineSourceMap&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>               <span class="comment">// 生成单个 soucemaps 文件，而不是将 sourcemaps 生成不同的文件</span></span><br><span class="line">    <span class="attr">&quot;inlineSources&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                 <span class="comment">// 将代码与 sourcemaps 生成到一个文件中，要求同时设置了 --inlineSourceMap 或 --sourceMap 属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 其他选项 */</span></span><br><span class="line">    <span class="attr">&quot;experimentalDecorators&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>        <span class="comment">// 启用装饰器</span></span><br><span class="line">    <span class="attr">&quot;emitDecoratorMetadata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>          <span class="comment">// 为装饰器提供元数据的支持</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">/* 其他配置选项 */</span></span><br><span class="line">  <span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;src/**/*.ts&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span>                <span class="comment">// 需要编译的文件路径</span></span><br><span class="line">  <span class="attr">&quot;exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;node_modules&quot;</span><span class="punctuation">,</span> <span class="string">&quot;dist&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span>        <span class="comment">// 不需要编译的文件路径</span></span><br><span class="line">  <span class="attr">&quot;extends&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./base.tsconfig.json&quot;</span><span class="punctuation">,</span>          <span class="comment">// 继承另一个配置文件</span></span><br><span class="line">  <span class="attr">&quot;references&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./packages/core&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">]</span>  <span class="comment">// 引用其他 TypeScript 项目</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>现在，让我们详细了解每个配置选项的含义和可选值。</p>
<h3 id="compilerOptions-字段"><a href="#compilerOptions-字段" class="headerlink" title="compilerOptions 字段"></a>compilerOptions 字段</h3><ul>
<li><p><code>target</code>: 编译后的 JavaScript 目标版本。可选值包括 <code>&quot;es3&quot;</code>, <code>&quot;es5&quot;</code>, <code>&quot;es6&quot;/&quot;es2015&quot;</code>, <code>&quot;es2016&quot;</code>, <code>&quot;es2017&quot;</code>, <code>&quot;es2018&quot;</code>, <code>&quot;es2019&quot;</code>, <code>&quot;es2020&quot;</code>, <code>&quot;esnext&quot;</code>。</p>
</li>
<li><p><code>module</code>: 生成模块代码的模块系统。可选值包括 <code>&quot;commonjs&quot;</code>, <code>&quot;amd&quot;</code>, <code>&quot;system&quot;</code>, <code>&quot;umd&quot;</code>, <code>&quot;es2015&quot;</code>。</p>
</li>
<li><p><code>lib</code>: 编译时需要引入的库文件。例如，<code>[&quot;es5&quot;, &quot;dom&quot;, &quot;es2015.promise&quot;]</code> 表示编译时将引入 ES5、DOM 和 Promise 相关的库文件。</p>
</li>
<li><p><code>allowJs</code>: 允许编译 JavaScript 文件。设置为 <code>true</code> 表示允许编译 JavaScript 文件。</p>
</li>
<li><p><code>checkJs</code>: 对 JavaScript 文件进行类型检查。设置为 <code>true</code> 表示在编译 JavaScript 文件时进行类型检查。</p>
</li>
<li><p><code>jsx</code>: 支持 JSX 语法，并指定 JSX 转换方式。可选值包括  <code>&quot;preserve&quot;</code>, <code>&quot;react&quot;</code>, <code>&quot;react-native&quot;</code>, <code>&quot;react-jsx&quot;</code>, <code>&quot;react-jsxdev&quot;</code>, <code>&quot;react-native&quot;</code>, <code>&quot;react-native-svg&quot;</code>等。</p>
</li>
<li><p><code>declaration</code>: 生成对外部使用者的声明文件。设置为 <code>true</code> 表示生成 <code>.d.ts</code> 文件。</p>
</li>
<li><p><code>sourceMap</code>: 生成源映射文件。设置为 <code>true</code> 表示生成 <code>.map</code> 文件。</p>
</li>
<li><p><code>outDir</code>: 编译输出目录。指定编译后的 JavaScript 文件的输出目录。</p>
</li>
<li><p><code>rootDir</code>: 源代码根目录。用来控制输出目录结构。</p>
</li>
<li><p><code>removeComments</code>: 删除生成文件中的注释。设置为 <code>true</code> 表示删除编译后的所有注释。</p>
</li>
<li><p><code>noEmit</code>: 不生成编译结果。设置为 <code>true</code> 表示不生成输出文件。</p>
</li>
<li><p><code>strict</code>: 启用所有严格类型检查选项。设置为 <code>true</code> 表示启用所有严格类型检查选项。</p>
</li>
</ul>
<h3 id="2-include-和-exclude-字段"><a href="#2-include-和-exclude-字段" class="headerlink" title="2. include 和 exclude 字段"></a>2. include 和 exclude 字段</h3><p>include 和 exclude 字段用于指定要包含和排除的文件或目录。它们可以是字符串或字符串数组。例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;src/**/*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;node_modules&quot;</span><span class="punctuation">,</span> <span class="string">&quot;**/*.spec.ts&quot;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="3-extends-字段"><a href="#3-extends-字段" class="headerlink" title="3. extends 字段"></a>3. extends 字段</h3><p>extends 字段用于继承另一个配置文件的设置。例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;extends&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./baseConfig.json&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-files-和-references-字段"><a href="#4-files-和-references-字段" class="headerlink" title="4. files 和 references 字段"></a>4. files 和 references 字段</h3><p>files 字段用于显式地指定要编译的文件列表。references 字段用于指定项目之间的引用关系。例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;src/main.ts&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;references&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;../otherProject&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>以上是 TypeScript 中 <code>tsconfig.json</code> 配置文件的详细解释和说明。根据项目的需要，可以灵活配置编译选项，以满足项目的需求。</p>
<h3 id="TypeScript-编译"><a href="#TypeScript-编译" class="headerlink" title="TypeScript 编译"></a>TypeScript 编译</h3><p>好的 <code>IDE</code> 支持对 <code>TypeScript</code> 的即时编译。但是，如果你想在使用 <code>tsconfig.json</code> 时从命令行手动运行 <code>TypeScript</code> 编译器，你可以通过以下方式：</p>
<ul>
<li>运行 <code>tsc</code>，它会在当前目录或者是父级目录寻找 <code>tsconfig.json</code> 文件。</li>
<li>运行 <code>tsc -p ./path-to-project-directory</code>。当然，这个路径可以是绝对路径，也可以是相对于当前目录的相对路径。</li>
</ul>
<p>你甚至可以使用 <code>tsc -w</code> 来启用 <code>TypeScript</code> 编译器的观测模式，在检测到文件改动之后，它将重新编译。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过对 tsconfig.json 配置文件的详细解释，我们可以更好地理解和配置 TypeScript 项目。合理地配置 tsconfig.json 可以提高项目的开发效率和代码质量，使得 TypeScript 的强大功能得以充分发挥。希望本文能够帮助读者更加深入地了解 TypeScript 的配置选项和使用方法。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/typescript/" rel="tag">typescript</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/05/12/typescript-config/" data-id="cly0yww9f001zq5qhg2yd0p6d" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-github-action-auto-git-tag" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/05/02/github-action-auto-git-tag/" class="article-date">
  <time datetime="2024-05-02T18:12:20.000Z" itemprop="datePublished">2024-05-02</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/05/02/github-action-auto-git-tag/">使用 GitHub Actions 自动推送 Git Tag</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="使用-GitHub-Actions-自动推送-Git-Tag"><a href="#使用-GitHub-Actions-自动推送-Git-Tag" class="headerlink" title="使用 GitHub Actions 自动推送 Git Tag"></a>使用 GitHub Actions 自动推送 Git Tag</h2><p><code>GitHub Actions</code> 是 <code>GitHub</code> 提供的一项功能，用于实现自动化工作流程，可以帮助您自动执行多种任务，例如构建、测试、部署等。其中，自动推送 <code>Git Tag</code> 是一个常见的用例，特别是当您希望将版本号从项目的 <code>package.json</code> 文件中提取并自动发布为 <code>Git Tag</code> 时。</p>
<p><img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/github/github-original.svg" alt="GitHub Actions Logo"></p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>在开始之前，您需要确保您具备以下条件：</p>
<ol>
<li>一个 <code>GitHub</code> 账号，并且您拥有要推送标签的仓库的写权限。</li>
<li>项目使用了 <code>Git</code> 来进行版本控制，并且 <code>package.json</code> 文件中包含了版本号信息。</li>
<li>对 <code>GitHub Actions</code> 有一定的了解，包括如何编写和配置工作流文件。</li>
</ol>
<h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>下面是实现自动推送 <code>Git Tag</code> 的详细步骤：</p>
<h4 id="1-创建-Workflow-文件"><a href="#1-创建-Workflow-文件" class="headerlink" title="1. 创建 Workflow 文件"></a>1. 创建 Workflow 文件</h4><p>首先，在您的 GitHub 仓库中创建一个新的 <code>Workflow</code> 文件，该文件将定义自动化工作流程。您可以在 <code>.github/workflows</code> 目录下创建一个 YAML 格式的文件，例如 <code>push-tag.yml</code>。</p>
<h4 id="2-编写-Workflow-文件"><a href="#2-编写-Workflow-文件" class="headerlink" title="2. 编写 Workflow 文件"></a>2. 编写 Workflow 文件</h4><p>在 <code>Workflow</code> 文件中，我们需要定义一个工作流程，该工作流程将在满足特定条件时触发，并执行推送标签的操作。下面是一个示例 <code>Workflow</code> 文件的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Push</span> <span class="string">Tag</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">push-tag:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">version</span> <span class="string">from</span> <span class="string">package.json</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">version</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;VERSION=$(node -p &#x27;require(`./package.json`).version&#x27;)&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Push</span> <span class="string">tag</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          git config --local user.email &quot;action@github.com&quot;</span></span><br><span class="line"><span class="string">          git config --local user.name &quot;GitHub Action&quot;</span></span><br><span class="line"><span class="string">          git tag -a v$&#123;&#123; env.VERSION &#125;&#125; -m &quot;Auto-generated tag from GitHub Actions&quot;</span></span><br><span class="line"><span class="string">          git push origin v$&#123;&#123; env.VERSION &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>在这个示例中：</p>
<ul>
<li>定义了一个名为 <code>Push Tag</code> 的工作流，它将在推送到 <code>master</code> 分支时触发。</li>
<li>创建了一个名为 <code>push-tag</code> 的 <code>job</code>，它在 <code>Ubuntu</code> 环境中运行。</li>
<li>工作流程包含三个步骤：检出仓库、从 <code>package.json</code> 文件中获取版本号、推送标签到远程仓库。</li>
<li>使用 <code>echo</code> 命令将从 <code>package.json</code> 文件中获取的版本号写入到环境文件中，该环境文件由 <code>GitHub Actions</code> 自动读取。</li>
<li>然后使用 <code>env</code> 关键字来获取环境变量中的版本号，并使用该版本号创建标签和推送标签。</li>
</ul>
<h4 id="3-提交并部署-Workflow-文件"><a href="#3-提交并部署-Workflow-文件" class="headerlink" title="3. 提交并部署 Workflow 文件"></a>3. 提交并部署 Workflow 文件</h4><p>将编写好的 <code>Workflow</code> 文件提交到您的 <code>GitHub</code> 仓库中，并等待 <code>GitHub Actions</code> 自动触发工作流程。当您推送代码到 <code>master</code> 分支时，<code>GitHub Actions</code> 将自动运行该工作流程，并根据 <code>package.json</code> 文件中的版本号创建并推送一个新的 <code>Git Tag</code>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/github/github-original.svg" alt="GitHub Actions Workflow"></p>
<h3 id="GitHub-Actions-YAML-配置参数"><a href="#GitHub-Actions-YAML-配置参数" class="headerlink" title="GitHub Actions YAML 配置参数"></a>GitHub Actions YAML 配置参数</h3><p><code>GitHub Actions</code> 的 <code>YAML</code> 文件用于定义工作流程，其中包含了触发条件、作业配置和任务步骤等信息。以下是对 <code>YAML</code> 文件中常用字段的解释：</p>
<ol>
<li><p><code>name</code>: 定义工作流程的名称。</p>
</li>
<li><p><code>on</code>: 定义触发工作流程的事件。可以是以下任何一个或组合：</p>
<ul>
<li><code>push</code>: 当代码推送到仓库时触发。</li>
<li><code>pull_request</code>: 当创建或更新拉取请求时触发。</li>
<li><code>schedule</code>: 按计划执行工作流程。</li>
<li><code>workflow_dispatch</code>: 通过 <code>GitHub UI</code> 或 <code>API</code> 手动触发。</li>
</ul>
</li>
<li><p><code>jobs</code>: 定义工作流程中的作业列表，每个作业可以包含一个或多个步骤。</p>
<ul>
<li><code>name</code>: 定义作业的名称。</li>
<li><code>runs-on</code>: 指定作业运行的操作系统环境，例如 <code>ubuntu-latest</code>、<code>macos-latest</code>、<code>windows-latest</code> 等。</li>
<li><code>steps</code>: 定义作业中的任务步骤列表。</li>
</ul>
</li>
<li><p><code>steps</code>: 定义作业中的任务步骤列表，每个步骤可以是一个预定义的操作或自定义的命令。</p>
<ul>
<li><code>name</code>: 定义步骤的名称。</li>
<li><code>uses</code>: 指定要使用的预定义操作。例如 <code>actions/checkout@v2</code> 表示使用 <code>GitHub</code> 提供的 <code>checkout</code> 操作。</li>
<li><code>run</code>: 指定要执行的自定义命令。可以是单个命令或多行脚本。</li>
</ul>
</li>
</ol>
<p>以下是一个简单的 <code>GitHub Actions YAML</code> 文件示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">CI</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">project</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">tests</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>

<p>在这个示例中，工作流程名为 <code>CI</code>，当代码推送到 <code>main</code> 分支时触发。工作流程包含一个名为 <code>build</code> 的作业，该作业在 <code>ubuntu-latest</code> 环境中运行。作业中包含一系列步骤，依次为检出仓库、安装依赖、构建项目和运行测试。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过使用 <code>GitHub Actions</code>，您可以轻松地实现自动推送 <code>Git Tag</code> 的功能，并且可以从项目的 <code>package.json</code> 文件中自动提取版本号。这样，您就可以自动化管理软件包的发布流程，提高开发效率，同时确保版本控制的一致性和可追踪性。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tag/" rel="tag">tag</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/05/02/github-action-auto-git-tag/" data-id="cly0yww8t000fq5qh1doggvld" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
    <article id="post-react-fiber-struct" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2024/04/24/react-fiber-struct/" class="article-date">
  <time datetime="2024-04-24T10:52:26.000Z" itemprop="datePublished">2024-04-24</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-true">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/04/24/react-fiber-struct/">浅入解析 React Fiber 结构</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h3 id="浅入解析-React-Fiber-结构"><a href="#浅入解析-React-Fiber-结构" class="headerlink" title="浅入解析 React Fiber 结构"></a>浅入解析 React Fiber 结构</h3><p>React Fiber 是 React 中用于表示组件树的一种数据结构，它的设计和实现是 React 中的一项重要内容。本文将深入探讨 React Fiber 的结构，包括其所有属性及其含义，并对属性中的对象类型进行详细说明和解释。通过阅读本文，读者将更好地理解 React Fiber 的内部机制。</p>
<h3 id="React-18-Fiber-结构概述"><a href="#React-18-Fiber-结构概述" class="headerlink" title="React@18+ Fiber 结构概述"></a>React@18+ Fiber 结构概述</h3><p>在 React 中，每个组件都对应一个 Fiber 对象，用于表示组件树中的一个节点。以下是 Fiber 对象的结构定义：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Fiber</span> = &#123;</span><br><span class="line">  <span class="attr">tag</span>: <span class="title class_">WorkTag</span>,</span><br><span class="line">  <span class="attr">key</span>: <span class="literal">null</span> | <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">elementType</span>: <span class="built_in">string</span> | <span class="title class_">FunctionComponent</span> | <span class="title class_">ClassComponent</span> | <span class="title class_">HostComponent</span> | <span class="title class_">SuspenseComponent</span> | ...,</span><br><span class="line">  <span class="attr">type</span>: <span class="built_in">string</span> | <span class="title class_">FunctionComponent</span> | <span class="title class_">ClassComponent</span> | <span class="title class_">HostComponent</span> | <span class="title class_">SuspenseComponent</span> | ...,</span><br><span class="line">  <span class="attr">stateNode</span>: <span class="title class_">HTMLElement</span> | <span class="title class_">Component</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">return</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">child</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">sibling</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">index</span>: <span class="built_in">number</span>,</span><br><span class="line">  <span class="attr">ref</span>: <span class="title class_">RefObject</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">pendingProps</span>: <span class="built_in">any</span>,</span><br><span class="line">  <span class="attr">memoizedProps</span>: <span class="built_in">any</span>,</span><br><span class="line">  <span class="attr">updateQueue</span>: <span class="title class_">UpdateQueue</span>&lt;<span class="built_in">any</span>&gt; | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">memoizedState</span>: <span class="title class_">Hook</span> | <span class="title class_">StateObject</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">dependencies</span>: <span class="title class_">Dependencies</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">mode</span>: <span class="title class_">TypeOfMode</span>,</span><br><span class="line">  <span class="attr">effectTag</span>: <span class="title class_">SideEffectTag</span>,</span><br><span class="line">  <span class="attr">nextEffect</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">firstEffect</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">lastEffect</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">lanes</span>: <span class="title class_">Lanes</span>,</span><br><span class="line">  <span class="attr">childLanes</span>: <span class="title class_">Lanes</span>,</span><br><span class="line">  <span class="attr">alternate</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>根据提供的 Fiber 类型定义，下面是完整的 Fiber 节点的属性列表：</p>
<ol>
<li><p><strong>tag</strong>：</p>
<ul>
<li>标识 Fiber 节点的类型，如 <code>HostComponent</code>、<code>ClassComponent</code>、<code>FunctionComponent</code> 等。</li>
</ul>
</li>
<li><p><strong>key</strong>：</p>
<ul>
<li>用于在DOM更新期间识别节点。可以是字符串类型或 null。</li>
</ul>
</li>
<li><p><strong>elementType</strong>：</p>
<ul>
<li>元素类型，通常是 <code>React.createElement()</code> 中传递的类型，用于保持节点的身份。</li>
</ul>
</li>
<li><p><strong>type</strong>：</p>
<ul>
<li>节点的具体类型，与 elementType 相似，但对于 ClassComponent 等需要再次处理。</li>
</ul>
</li>
<li><p><strong>stateNode</strong>：</p>
<ul>
<li>与此 Fiber 节点关联的实际 DOM 节点、组件实例或其他实体。</li>
</ul>
</li>
<li><p><strong>return</strong>：</p>
<ul>
<li>指向此节点的父节点。</li>
</ul>
</li>
<li><p><strong>child</strong>：</p>
<ul>
<li>指向此节点的第一个子节点。</li>
</ul>
</li>
<li><p><strong>sibling</strong>：</p>
<ul>
<li>指向此节点的下一个兄弟节点。</li>
</ul>
</li>
<li><p><strong>index</strong>：</p>
<ul>
<li>表示节点在兄弟节点中的位置索引。</li>
</ul>
</li>
<li><p><strong>ref</strong>：</p>
<ul>
<li>表示与此节点关联的 ref，可以是函数、字符串或 RefObject 对象。</li>
</ul>
</li>
<li><p><strong>refCleanup</strong>：</p>
<ul>
<li>用于清理 ref 的函数。</li>
</ul>
</li>
<li><p><strong>pendingProps</strong>：</p>
<ul>
<li>待处理的属性，即将应用于此节点的属性。</li>
</ul>
</li>
<li><p><strong>memoizedProps</strong>：</p>
<ul>
<li>表示此节点最近一次渲染时应用的属性。</li>
</ul>
</li>
<li><p><strong>updateQueue</strong>：</p>
<ul>
<li>包含了所有待处理的更新操作。</li>
</ul>
</li>
<li><p><strong>memoizedState</strong>：</p>
<ul>
<li>上一次渲染时的状态。如果组件使用了 Hooks，那么 memoizedState 就应该是一个链表结构，每个节点表示一个 Hook 的状态值。如果组件是类组件，则 memoizedState 应该是该组件在上一次渲染时的状态对象。</li>
</ul>
</li>
<li><p><strong>dependencies</strong>：</p>
<ul>
<li>表示此节点更新所依赖的上下文、Props、State等信息。</li>
</ul>
</li>
<li><p><strong>mode</strong>：</p>
<ul>
<li>表示当前渲染模式，如并发模式。</li>
</ul>
</li>
<li><p><strong>flags</strong>：</p>
<ul>
<li>描述 Fiber 节点和其子树的一些属性的位标志，用于标记节点需要执行的操作。</li>
</ul>
</li>
<li><p><strong>subtreeFlags</strong>：</p>
<ul>
<li>描述 Fiber 子树的属性的位标志，用于标记节点需要执行的操作。</li>
</ul>
</li>
<li><p><strong>deletions</strong>：</p>
<ul>
<li>用于存储要删除的 Fiber 节点。</li>
</ul>
</li>
<li><p><strong>lanes</strong>：</p>
<ul>
<li>表示此节点的调度优先级。</li>
</ul>
</li>
<li><p><strong>childLanes</strong>：</p>
<ul>
<li>表示此节点子树中的调度优先级。</li>
</ul>
</li>
<li><p><strong>alternate</strong>：</p>
<ul>
<li>指向上一次渲染时与当前 Fiber 节点对应的 Fiber 节点。</li>
</ul>
</li>
<li><p><strong>actualDuration</strong>：</p>
<ul>
<li>当前渲染阶段的实际持续时间，用于性能分析。</li>
</ul>
</li>
<li><p><strong>actualStartTime</strong>：</p>
<ul>
<li>当前渲染阶段的开始时间，用于性能分析。</li>
</ul>
</li>
<li><p><strong>selfBaseDuration</strong>：</p>
<ul>
<li>最近一次渲染阶段的持续时间，不包括子节点。</li>
</ul>
</li>
<li><p><strong>treeBaseDuration</strong>：</p>
<ul>
<li>所有子节点渲染阶段持续时间的总和。</li>
</ul>
</li>
<li><p><strong>_debugInfo</strong>：</p>
<ul>
<li>用于调试的附加信息。</li>
</ul>
</li>
<li><p><strong>_debugOwner</strong>：</p>
<ul>
<li>指向此节点的拥有者。</li>
</ul>
</li>
<li><p><strong>_debugIsCurrentlyTiming</strong>：</p>
<ul>
<li>标志位，指示当前是否正在记录渲染时间。</li>
</ul>
</li>
<li><p><strong>_debugNeedsRemount</strong>：</p>
<ul>
<li>标志位，指示是否需要重新挂载组件。</li>
</ul>
</li>
<li><p><strong>_debugHookTypes</strong>：</p>
<ul>
<li>用于调试的 hook 类型信息。</li>
</ul>
</li>
</ol>
<p>这些属性组成了 Fiber 节点的完整表示，用于 React 内部的渲染和更新过程。</p>
<h3 id="属性详解"><a href="#属性详解" class="headerlink" title="属性详解"></a>属性详解</h3><h4 id="tag"><a href="#tag" class="headerlink" title="tag"></a>tag</h4><p>tag 属性表示 Fiber 节点的类型，其值可以是以下几种之一：</p>
<ul>
<li><strong>HostRoot:</strong> 表示根节点。</li>
<li><strong>FunctionComponent:</strong> 表示函数组件。</li>
<li><strong>ClassComponent:</strong> 表示类组件。</li>
<li><strong>HostComponent:</strong> 表示 DOM 元素。</li>
<li><strong>ContextProvider:</strong> 表示 Context 提供者。</li>
<li><strong>ContextConsumer:</strong> 表示 Context 消费者。</li>
<li><strong>SuspenseComponent:</strong> 表示 Suspense 组件。</li>
<li><strong>DehydratedFragment:</strong> 表示脱水片段。</li>
</ul>
<h4 id="memoizedState"><a href="#memoizedState" class="headerlink" title="memoizedState"></a>memoizedState</h4><p>memoizedState 属性表示组件在上一次渲染时的状态，其类型根据组件的具体情况而定。如果组件使用了 Hooks，那么 memoizedState 就应该是一个链表结构，每个节点表示一个 Hook 的状态值。如果组件是类组件，则 memoizedState 应该是该组件在上一次渲染时的状态对象。memoizedState 具体的属性如下所示</p>
<ul>
<li><strong>memoizedState:</strong> 组件的记忆状态，即上次渲染时的状态。</li>
<li><strong>next:</strong> 指向下一个 hook 节点的指针。</li>
</ul>
<h4 id="flags"><a href="#flags" class="headerlink" title="flags"></a>flags</h4><p>flags 属性用于标记节点需要执行的操作，其值是一个位掩码，描述 Fiber 节点的不同状态和行为，并在调度和渲染过程中起着重要作用，包含以下几种标记：</p>
<p>这里有一些重要的标志位和常量的含义：</p>
<ul>
<li><strong>NoFlags:</strong> 用于表示没有任何状态或行为。</li>
<li><strong>Update:</strong> 表示组件需要更新。</li>
<li><strong>Placement:</strong> 表示组件需要被放置到 DOM 树中。</li>
<li><strong>ChildDeletion:</strong> 表示组件的子节点被删除。</li>
<li><strong>Callback:</strong> 表示需要执行回调函数。</li>
<li><strong>Visibility:</strong> 表示组件的可见性发生变化。</li>
<li><strong>Ref:</strong> 表示组件的引用发生变化。</li>
<li><strong>Snapshot:</strong> 表示需要获取组件的快照。</li>
<li><strong>Passive:</strong> 表示组件处于被动模式。</li>
<li><strong>StoreConsistency:</strong> 表示需要保持状态的一致性。</li>
</ul>
<blockquote>
<p>以前使用 <code>effectTag</code> 属性来表示副作用。</p>
</blockquote>
<h3 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h3><p>React Fiber 的源码位于 React 源码库中的 <code>react-reconciler</code> 模块。读者可以在该模块中找到 Fiber 结构的定义以及相关的操作和算法实现。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文浅入解析了 React Fiber 结构，介绍了其所有属性及其含义，并对对象类型的属性进行了进一步说明和解释。通过深入理解 Fiber 结构，可以更好地理解 React 内部的工作原理，并能够更加高效地使用 React 进行开发。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

        <a data-url="https://hankliu62.github.io/2024/04/24/react-fiber-struct/" data-id="cly0yww98001eq5qhd0wucupb" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
</article>



  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/06/20/node-ffmpeg/">使用 Node.js 和 FFmpeg 构建视频服务器</a>
          </li>
        
          <li>
            <a href="/2024/06/12/rspack/">Rspack：下一代前端编译工具</a>
          </li>
        
          <li>
            <a href="/2024/06/08/nextjs-nuxtjs-nestjs/">Next.js、Nuxt.js 和 NestJS 的全面介绍</a>
          </li>
        
          <li>
            <a href="/2024/06/01/burial-point-sdk/">前端异常监控与埋点收集SDK</a>
          </li>
        
          <li>
            <a href="/2024/05/28/service-worker-detail/">Service Worker：提升Web应用性能和体验的利器</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/" rel="tag">canvas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csrf/" rel="tag">csrf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debugging/" rel="tag">debugging</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github-pages/" rel="tag">github pages</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/homebrew/" rel="tag">homebrew</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html/" rel="tag">html</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html5/" rel="tag">html5</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/loader/" rel="tag">loader</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/miniprogram/" rel="tag">miniprogram</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mobile/" rel="tag">mobile</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nestjs/" rel="tag">nestjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">network</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nextjs/" rel="tag">nextjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nuxtjs/" rel="tag">nuxtjs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/optimize/" rel="tag">optimize</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reptile/" rel="tag">reptile</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rspack/" rel="tag">rspack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/service-worker/" rel="tag">service worker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tag/" rel="tag">tag</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/translate/" rel="tag">translate</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/typescript/" rel="tag">typescript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vitepress/" rel="tag">vitepress</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webrtc/" rel="tag">webrtc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webworker/" rel="tag">webworker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weinre/" rel="tag">weinre</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yuv/" rel="tag">yuv</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">六月 2024</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">五月 2024</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">四月 2024</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 HankLiu, Inc. All rights reserved.<br>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">文章</a>
  
    <a href="/toolkit" class="mobile-nav-link">小工具</a>
  
    <a href="/resume" class="mobile-nav-link">小简介</a>
  
    <a href="/about" class="mobile-nav-link">小关于</a>
  
  <a href="#search" class="mobile-nav-link st-search-show-outputs">Search</a>
</nav>
  

<!-- totop start -->
<div id="totop">
	<a title="To Top"></a>
</div>
<!-- totop end -->

<!-- swiftype search start -->

<!-- swiftype search end -->



<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/lrsjng.jquery-qrcode/0.12.0/jquery.qrcode.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


</div>
</body>
</html>
