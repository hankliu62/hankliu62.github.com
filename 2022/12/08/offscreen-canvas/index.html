
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  
  <title>OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度 | HankLiu的博客小屋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度OffscreenCanvas提供了一个可以脱离屏幕渲染的canvas对象。 有了离屏Canvas，你可以不用在你的主线程中绘制图像了！ Canvas 是一个非常受欢迎的表现方式，同时也是WebGL的入口。它能绘制图形，图片，展示动画，甚至是处理视频内容。它经常被用来在富媒体web应用中创建炫">
<meta property="og:type" content="article">
<meta property="og:title" content="OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度">
<meta property="og:url" content="https://hankliu62.github.io/2022/12/08/offscreen-canvas/index.html">
<meta property="og:site_name" content="HankLiu的博客小屋">
<meta property="og:description" content="OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度OffscreenCanvas提供了一个可以脱离屏幕渲染的canvas对象。 有了离屏Canvas，你可以不用在你的主线程中绘制图像了！ Canvas 是一个非常受欢迎的表现方式，同时也是WebGL的入口。它能绘制图形，图片，展示动画，甚至是处理视频内容。它经常被用来在富媒体web应用中创建炫">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://user-images.githubusercontent.com/8088864/126027990-d476b78e-e6c9-4438-998d-7ccc4ae79f8b.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/8088864/126027866-d78a65fc-8f0f-4a7e-9adf-7eb09a03b956.png">
<meta property="article:published_time" content="2022-12-08T12:12:26.000Z">
<meta property="article:modified_time" content="2024-05-14T23:42:33.752Z">
<meta property="article:author" content="HankLiu">
<meta property="article:tag" content="html">
<meta property="article:tag" content="canvas">
<meta property="article:tag" content="webworker">
<meta property="article:tag" content="yuv">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/8088864/126027990-d476b78e-e6c9-4438-998d-7ccc4ae79f8b.png">
  
  
    <link rel="icon" href="/img/favicon.ico" sizes="16x16">
  
  <link rel="stylesheet" href="/css/style.css?t=1">
  
    <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
  

<meta name="generator" content="Hexo 7.1.1"></head>

<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner">
    <div id="banner-mask"></div>
  </div>
  <div id="header-outer" class="outer">
    <nav id="upper-nav" class="inner">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <div class="sub-nav">
        
        
          <a id="nav-github" class="nav-icon" href="https://github.com/hankliu62"></a>
        
      </div>
    </nav>
    <div id="header-title">
      
        <h1 id="blog-title-wrap">
          <a href="/" id="blog-title">HankLiu的博客小屋</a>
        </h1>
      
      
        <h5 class="blog-subtitle-wrap">努力去听风的声音，不必在意风的方向。</h5>
      
    </div>
    <div id="contenedor">
      <ul class="cube">
        <li class="cara"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="100" width="100" viewBox="-50 -50 200 200">
          <circle cx="50" cy="50" r="45" stroke-width="5" stroke="black" stroke-opacity="0.5" fill-opacity="0"></circle>
          <rect id="clockwise" x="47.5" y="27.5" width="5" height="25" rx="2.5" ry="2.5" fill="black" fill-opacity="0.5" transform="rotate(330 50 50)"></rect>
          <rect id="minute" x="48.5" y="16.5" width="3" height="35" rx="1.5" ry="1.5" fill="black" fill-opacity="0.5"></rect>
        </svg></li>
        <li class="cara">P</li>
        <li class="cara">X</li>
        <li class="cara">L</li>
        <li class="cara">C</li>
        <li class="cara">Y</li>
      </ul>
    </div>
    <nav id="main-nav">
      
        <a class="main-nav-link" href="/">主页</a>
      
        <a class="main-nav-link" href="/archives">文章</a>
      
        <a class="main-nav-link" href="/toolkit">小工具</a>
      
        <a class="main-nav-link" href="/resume">小简介</a>
      
        <a class="main-nav-link" href="/about">小关于</a>
      
    </nav>
  </div>
</header>

    <div class="outer">
      <section id="main"><article id="post-offscreen-canvas" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2022/12/08/offscreen-canvas/" class="article-date">
  <time datetime="2022-12-08T12:12:26.000Z" itemprop="datePublished">2022-12-08</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content fill-content-false">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="OffscreenCanvas-离屏Canvas-—-使用Web-Worker提高你的Canvas运行速度"><a href="#OffscreenCanvas-离屏Canvas-—-使用Web-Worker提高你的Canvas运行速度" class="headerlink" title="OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度"></a>OffscreenCanvas 离屏Canvas — 使用Web Worker提高你的Canvas运行速度</h2><p>OffscreenCanvas提供了一个可以脱离屏幕渲染的canvas对象。</p>
<p>有了离屏Canvas，你可以不用在你的主线程中绘制图像了！</p>
<p>Canvas 是一个非常受欢迎的表现方式，同时也是WebGL的入口。它能绘制图形，图片，展示动画，甚至是处理视频内容。它经常被用来在富媒体web应用中创建炫酷的用户界面或者是制作在线（web）游戏。</p>
<p>它是非常灵活的，这意味着绘制在Canvas的内容可以被编程。JavaScript就提供了Canvas的系列API。这些给了Canvas非常好的灵活度。</p>
<p>但同时，在一些现代化的web站点，脚本解析运行是实现流畅用户反馈的最大的问题之一。因为Canvas计算和渲染和用户操作响应都发生在同一个线程中，在动画中（有时候很耗时）的计算操作将会导致App卡顿，降低用户体验。</p>
<p>幸运的是, <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/OffscreenCanvas">OffscreenCanvas</a> 离屏Canvas可以非常棒的解决这个麻烦！</p>
<p>到目前为止，Canvas的绘制功能都与<code>&lt;canvas&gt;</code>标签绑定在一起，这意味着Canvas API和DOM是耦合的。而OffscreenCanvas，正如它的名字一样，通过将Canvas移出屏幕来解耦了DOM和Canvas API。</p>
<p>由于这种解耦，OffscreenCanvas的渲染与DOM完全分离了开来，并且比普通Canvas速度提升了一些，而这只是因为两者（Canvas和DOM）之间没有同步。但更重要的是，将两者分离后，Canvas将可以在Web Worker中使用，即使在Web Worker中没有DOM。这给Canvas提供了更多的可能性。</p>
<h3 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h3><p>这是一个实验中的功能<br>此功能某些浏览器尚在开发中，请参考浏览器兼容性表格以得到在不同浏览器中适合使用的前缀。由于该功能对应的标准文档可能被重新修订，所以在未来版本的浏览器中该功能的语法和行为可能随之改变。</p>
<p>支持浏览器如下图所示：</p>
<p><img src="https://user-images.githubusercontent.com/8088864/126027990-d476b78e-e6c9-4438-998d-7ccc4ae79f8b.png" alt="OffscreenCanvas兼容性"></p>
<h3 id="在Worker中使用OffscreenCanvas"><a href="#在Worker中使用OffscreenCanvas" class="headerlink" title="在Worker中使用OffscreenCanvas"></a>在Worker中使用OffscreenCanvas</h3><p>它在窗口环境和web worker环境均有效。</p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API">Workers</a> 是一个Web版的线程——它允许你在幕后运行你的代码。将你的一部分代码放到Worker中可以给你的主线程更多的空闲时间，这可以提高你的用户体验度。就像其没有DOM一样，直到现在，在Worker中都没有Canvas API。</p>
<p>而OffscreenCanvas并不依赖DOM，所以在Worker中Canvas API可以被某种方法来代替。下面是我在Worker中用OffscreenCanvas来计算渐变颜色的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: worker.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getGradientColor</span>(<span class="params">percent</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> canvas = <span class="keyword">new</span> <span class="title class_">OffscreenCanvas</span>(<span class="number">100</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> gradient = ctx.<span class="title function_">createLinearGradient</span>(<span class="number">0</span>, <span class="number">0</span>, canvas.<span class="property">width</span>, <span class="number">0</span>);</span><br><span class="line">    gradient.<span class="title function_">addColorStop</span>(<span class="number">0</span>, <span class="string">&#x27;red&#x27;</span>);</span><br><span class="line">    gradient.<span class="title function_">addColorStop</span>(<span class="number">1</span>, <span class="string">&#x27;blue&#x27;</span>);</span><br><span class="line">    ctx.<span class="property">fillStyle</span> = gradient;</span><br><span class="line">    ctx.<span class="title function_">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, ctx.<span class="property">canvas</span>.<span class="property">width</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> imgd = ctx.<span class="title function_">getImageData</span>(<span class="number">0</span>, <span class="number">0</span>, ctx.<span class="property">canvas</span>.<span class="property">width</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> colors = imgd.<span class="property">data</span>.<span class="title function_">slice</span>(percent * <span class="number">4</span>, percent * <span class="number">4</span> + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`rgba(<span class="subst">$&#123;colors[<span class="number">0</span>]&#125;</span>, <span class="subst">$&#123;colors[<span class="number">1</span>]&#125;</span>, <span class="subst">$&#123;colors[<span class="number">2</span>]&#125;</span>, <span class="subst">$&#123;colors[<span class="number">3</span>]&#125;</span>)`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getGradientColor</span>(<span class="number">40</span>);  <span class="comment">// rgba(152, 0, 104, 255)</span></span><br></pre></td></tr></table></figure>

<h3 id="不要阻塞主线程"><a href="#不要阻塞主线程" class="headerlink" title="不要阻塞主线程"></a>不要阻塞主线程</h3><p>当我们将大量的计算移到Worker中运行时，可以释放主线程上的资源，这很有意思。我们可以使用transferControlToOffscreen 方法将常规的Canvas映射到OffscreenCanvas实例上。之后所有应用于OffscreenCanvas的操作将自动呈现在在源Canvas上。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;myCanvas&quot;</span> <span class="attr">width</span>=<span class="string">&quot;600&quot;</span> <span class="attr">height</span>=<span class="string">&quot;500&quot;</span> <span class="attr">style</span>=<span class="string">&quot;border:1px solid #d3d3d3;&quot;</span>&gt;</span></span><br><span class="line">  Your browser does not support the HTML5 canvas tag.</span><br><span class="line"><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myCanvas&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// var context = canvas.getContext(&quot;2d&quot;);</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 画线</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.moveTo(100, 100);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(300, 100);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(300, 200);</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 画第二条线</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 画第二条线</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.moveTo(100, 300);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(300, 300);</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 最后要描边才会出效果</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.stroke();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 创建一张新的玻璃纸</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.beginPath();</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 画第三条线</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.moveTo(400, 100);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(400, 300);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(500, 300);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineTo(500, 200);</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 只要执行stroke，都会玻璃纸上的图形重复印刷一次</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.stroke();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 填充</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.fill();</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.fillStyle = &quot;gray&quot;;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// // 设置描边色</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.strokeStyle = &quot;red&quot;; // 颜色的写法和css写法是一样的</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.stroke();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //填充</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //设置填充色</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.fillStyle = &quot;yellowgreen&quot;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.fill();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //把路径闭合</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.closePath();</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //设置线条的粗细， 不需要加px</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineWidth = 15;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// //线条的头部的设置</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// context.lineCap = &quot;round&quot;; //默认是butt， 记住round</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 注: 如果将canvas转化成离屏canvas时，就不能使用原canvas的cantext来绘制图案，否则会报错，已经绘制了的canvas不同通过transferControlToOffscreen转换成OffscreenCanvas</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// Uncaught DOMException: Failed to execute &#x27;transferControlToOffscreen&#x27; on &#x27;HTMLCanvasElement&#x27;: Cannot transfer control from a canvas that has a rendering context.</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> offscreen = canvas.<span class="title function_">transferControlToOffscreen</span>();</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;worker.js&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">worker.<span class="title function_">postMessage</span>(&#123; <span class="attr">canvas</span>: offscreen &#125;, [offscreen]);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>OffscreenCanvas 是可转移的，除了将其指定为传递信息中的字段之一以外，还需要将其作为postMessage（传递信息给Worker的方法）中的第二个参数传递出去，以便可以在Worker线程的context（上下文）中使用它。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// worker.js</span></span><br><span class="line"></span><br><span class="line">self.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取传送过来的离屏Canvas(OffscreenCanvas)</span></span><br><span class="line">  <span class="keyword">var</span> canvas = event.<span class="property">data</span>.<span class="property">canvas</span>;</span><br><span class="line">  <span class="keyword">var</span> context = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 画一个曲径球体</span></span><br><span class="line">  <span class="keyword">var</span> c1 = &#123;<span class="attr">x</span>: <span class="number">240</span>, <span class="attr">y</span>: <span class="number">160</span>, <span class="attr">r</span>: <span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">var</span> c2 = &#123;<span class="attr">x</span>: <span class="number">300</span>, <span class="attr">y</span>: <span class="number">200</span>, <span class="attr">r</span>: <span class="number">120</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> gradient = context.<span class="title function_">createRadialGradient</span>(c1.<span class="property">x</span>, c1.<span class="property">y</span>, c1.<span class="property">r</span>, c2.<span class="property">x</span>, c2.<span class="property">y</span>, c2.<span class="property">r</span>);</span><br><span class="line">  gradient.<span class="title function_">addColorStop</span>(<span class="number">1</span>, <span class="string">&quot;gray&quot;</span>);</span><br><span class="line">  gradient.<span class="title function_">addColorStop</span>(<span class="number">0</span>, <span class="string">&quot;lightgray&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//2. 将渐变对象设为填充色</span></span><br><span class="line">  context.<span class="property">fillStyle</span> = gradient;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//3. 画圆并填充</span></span><br><span class="line">  context.<span class="title function_">arc</span>(c2.<span class="property">x</span>, c2.<span class="property">y</span>, c2.<span class="property">r</span>, <span class="number">0</span>, <span class="number">2</span>*<span class="title class_">Math</span>.<span class="property">PI</span>);</span><br><span class="line">  context.<span class="title function_">fill</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下所示:</p>
<p><img src="https://user-images.githubusercontent.com/8088864/126027866-d78a65fc-8f0f-4a7e-9adf-7eb09a03b956.png" alt="WebWorker中OffscreenCanvas绘制径向渐变画球"></p>
<p>任务繁忙的主线程也不会影响在Worker上运行的动画。所以即使主线程非常繁忙，你也可以通过此功能来避免掉帧并保证流畅的动画</p>
<h3 id="WebRTC的YUV媒体流数据的离屏渲染"><a href="#WebRTC的YUV媒体流数据的离屏渲染" class="headerlink" title="WebRTC的YUV媒体流数据的离屏渲染"></a>WebRTC的YUV媒体流数据的离屏渲染</h3><p>从 WebRTC 中拿到的是 YUV 的原始视频流，将原始的 YUV 视频帧直接转发过来，通过第三方库直接在 Cavans 上渲染。</p>
<p>可以使用<a href="https://github.com/brion/yuv-canvas">yuv-canvas</a>和<a href="https://github.com/brion/yuv-buffer">yuv-buffer</a>第三方库来渲染YUV的原始视频流。</p>
<h4 id="主进程render-js"><a href="#主进程render-js" class="headerlink" title="主进程render.js"></a>主进程render.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">__esModule</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">var</span> isEqual = <span class="built_in">require</span>(<span class="string">&#x27;lodash.isequal&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">YUVBuffer</span> = <span class="built_in">require</span>(<span class="string">&#x27;yuv-buffer&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">YUVCanvas</span> = <span class="built_in">require</span>(<span class="string">&#x27;yuv-canvas&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Renderer</span> = <span class="comment">/** <span class="doctag">@class</span> */</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">Renderer</span>(<span class="params">workSource</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_sendCanvas</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            _this.<span class="property">canvasSent</span> = <span class="literal">true</span>;</span><br><span class="line">            _this.<span class="property">worker</span> &amp;&amp; _this.<span class="property">worker</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;constructor&#x27;</span>,</span><br><span class="line">                <span class="attr">data</span>: &#123;</span><br><span class="line">                    <span class="attr">canvas</span>: _this.<span class="property">offCanvas</span>,</span><br><span class="line">                    <span class="attr">id</span>: (_this.<span class="property">element</span> &amp;&amp; _this.<span class="property">element</span>.<span class="property">id</span>) || (<span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">slice</span>(<span class="number">2</span>) + <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">slice</span>(<span class="number">2</span>))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, [_this.<span class="property">offCanvas</span>]);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 判断使用渲染的方式</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_checkRendererWay</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">workerReady</span> &amp;&amp; _this.<span class="property">worker</span> &amp;&amp; _this.<span class="property">offCanvas</span> &amp;&amp; _this.<span class="property">enableWorker</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;worker&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;software&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// workerCanvas渲染</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_workDrawFrame</span> = <span class="keyword">function</span> (<span class="params">width, height, yUint8Array, uUint8Array, vUint8Array</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">canvasWrapper</span> &amp;&amp; _this.<span class="property">canvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> !== <span class="string">&#x27;none&#x27;</span>) &#123;</span><br><span class="line">                _this.<span class="property">canvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">workerCanvasWrapper</span> &amp;&amp; _this.<span class="property">workerCanvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> === <span class="string">&#x27;none&#x27;</span>) &#123;</span><br><span class="line">                _this.<span class="property">workerCanvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            _this.<span class="property">worker</span> &amp;&amp; _this.<span class="property">worker</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;drawFrame&#x27;</span>,</span><br><span class="line">                <span class="attr">data</span>: &#123;</span><br><span class="line">                    <span class="attr">width</span>: width,</span><br><span class="line">                    <span class="attr">height</span>: height,</span><br><span class="line">                    <span class="attr">yUint8Array</span>: yUint8Array,</span><br><span class="line">                    <span class="attr">uUint8Array</span>: uUint8Array,</span><br><span class="line">                    <span class="attr">vUint8Array</span>: vUint8Array</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, [yUint8Array, uUint8Array, vUint8Array]);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 实际渲染Canvas</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_softwareDrawFrame</span> = <span class="keyword">function</span> (<span class="params">width, height, yUint8Array, uUint8Array, vUint8Array</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">workerCanvasWrapper</span> &amp;&amp; _this.<span class="property">workerCanvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> !== <span class="string">&#x27;none&#x27;</span>) &#123;</span><br><span class="line">                _this.<span class="property">workerCanvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">canvasWrapper</span> &amp;&amp; _this.<span class="property">canvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> === <span class="string">&#x27;none&#x27;</span>) &#123;</span><br><span class="line">                _this.<span class="property">canvasWrapper</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;flex&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> format = <span class="title class_">YUVBuffer</span>.<span class="title function_">format</span>(&#123;</span><br><span class="line">                <span class="attr">width</span>: width,</span><br><span class="line">                <span class="attr">height</span>: height,</span><br><span class="line">                <span class="attr">chromaWidth</span>: width / <span class="number">2</span>,</span><br><span class="line">                <span class="attr">chromaHeight</span>: height / <span class="number">2</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">var</span> y = <span class="title class_">YUVBuffer</span>.<span class="title function_">lumaPlane</span>(format, yUint8Array);</span><br><span class="line">            <span class="keyword">var</span> u = <span class="title class_">YUVBuffer</span>.<span class="title function_">chromaPlane</span>(format, uUint8Array);</span><br><span class="line">            <span class="keyword">var</span> v = <span class="title class_">YUVBuffer</span>.<span class="title function_">chromaPlane</span>(format, vUint8Array);</span><br><span class="line">            <span class="keyword">var</span> frame = <span class="title class_">YUVBuffer</span>.<span class="title function_">frame</span>(format, y, u, v);</span><br><span class="line">            _this.<span class="property">yuv</span>.<span class="title function_">drawFrame</span>(frame);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheCanvasOpts</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">yuv</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ready</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contentMode</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">offCanvas</span> = &#123;&#125;;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">enableWorker</span> = !!workSource;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">enableWorker</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">worker</span> = <span class="keyword">new</span> <span class="title class_">Worker</span>(workSource);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerReady</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvasSent</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">worker</span>.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;[WorkerRenderer]: the renderer worker catch error: &#x27;</span>, evt);</span><br><span class="line">                _this.<span class="property">workerReady</span> = <span class="literal">false</span>;</span><br><span class="line">                _this.<span class="property">enableWorker</span> = <span class="literal">false</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">worker</span>.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> data = evt.<span class="property">data</span>;</span><br><span class="line">                <span class="keyword">switch</span> (data.<span class="property">type</span>) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;ready&#x27;</span>: &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[WorkerRenderer]: the renderer worker was ready&#x27;</span>);</span><br><span class="line">                        _this.<span class="property">workerReady</span> = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">if</span> (_this.<span class="property">offCanvas</span>) &#123;</span><br><span class="line">                            _this.<span class="title function_">_sendCanvas</span>();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;exited&#x27;</span>: &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[WorkerRenderer]: the renderer worker was exited&#x27;</span>);</span><br><span class="line">                        _this.<span class="property">workerReady</span> = <span class="literal">false</span>;</span><br><span class="line">                        _this.<span class="property">enableWorker</span> = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_calcZoom</span> = <span class="keyword">function</span> (<span class="params">vertical, contentMode, width, height, clientWidth, clientHeight</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vertical === <span class="keyword">void</span> <span class="number">0</span>) &#123; vertical = <span class="literal">false</span>; &#125;</span><br><span class="line">        <span class="keyword">if</span> (contentMode === <span class="keyword">void</span> <span class="number">0</span>) &#123; contentMode = <span class="number">0</span>; &#125;</span><br><span class="line">        <span class="keyword">var</span> localRatio = clientWidth / clientHeight;</span><br><span class="line">        <span class="keyword">var</span> tempRatio = width / height;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isNaN</span>(localRatio) || <span class="built_in">isNaN</span>(tempRatio)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!contentMode) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vertical) &#123;</span><br><span class="line">                <span class="keyword">return</span> localRatio &gt; tempRatio ?</span><br><span class="line">                    clientHeight / height : clientWidth / width;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> localRatio &lt; tempRatio ?</span><br><span class="line">                    clientHeight / height : clientWidth / width;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (vertical) &#123;</span><br><span class="line">                <span class="keyword">return</span> localRatio &lt; tempRatio ?</span><br><span class="line">                    clientHeight / height : clientWidth / width;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> localRatio &gt; tempRatio ?</span><br><span class="line">                    clientHeight / height : clientWidth / width;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getBindingElement</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">element</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">bind</span> = <span class="keyword">function</span> (<span class="params">element</span>) &#123;</span><br><span class="line">        <span class="comment">// record element</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> = element;</span><br><span class="line">        <span class="comment">// create container</span></span><br><span class="line">        <span class="keyword">var</span> container = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        container.<span class="property">className</span> += <span class="string">&#x27; video-canvas-container&#x27;</span>;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">assign</span>(container.<span class="property">style</span>, &#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">display</span>: <span class="string">&#x27;flex&#x27;</span>,</span><br><span class="line">            <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">position</span>: <span class="string">&#x27;relative&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> = container;</span><br><span class="line">        element &amp;&amp; element.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">container</span>);</span><br><span class="line">        <span class="comment">// 创建两个canvas，一个在主线程中渲染，如果web worker中的离屏canvas渲染进程出错了，还可以切换到主进程的canvas进行渲染</span></span><br><span class="line">        <span class="keyword">var</span> canvasWrapper = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        canvasWrapper.<span class="property">className</span> += <span class="string">&#x27; video-canvas-wrapper canvas-renderer&#x27;</span>;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">assign</span>(canvasWrapper.<span class="property">style</span>, &#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">position</span>: <span class="string">&#x27;absolute&#x27;</span>,</span><br><span class="line">            <span class="attr">left</span>: <span class="string">&#x27;0px&#x27;</span>,</span><br><span class="line">            <span class="attr">right</span>: <span class="string">&#x27;0px&#x27;</span>,</span><br><span class="line">            <span class="attr">display</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span> = canvasWrapper;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">canvasWrapper</span>);</span><br><span class="line">        <span class="keyword">var</span> workerCanvasWrapper = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        workerCanvasWrapper.<span class="property">className</span> += <span class="string">&#x27; video-canvas-wrapper webworker-renderer&#x27;</span>;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">assign</span>(workerCanvasWrapper.<span class="property">style</span>, &#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">            <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">            <span class="attr">position</span>: <span class="string">&#x27;absolute&#x27;</span>,</span><br><span class="line">            <span class="attr">left</span>: <span class="string">&#x27;0px&#x27;</span>,</span><br><span class="line">            <span class="attr">right</span>: <span class="string">&#x27;0px&#x27;</span>,</span><br><span class="line">            <span class="attr">display</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span> = workerCanvasWrapper;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span>);</span><br><span class="line">        <span class="comment">// create canvas</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvas</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">workerCanvas</span>);</span><br><span class="line">        <span class="comment">// 创建 OffscreenCanvas 对象</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">offCanvas</span> = <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="title function_">transferControlToOffscreen</span>();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">canvasSent</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">offCanvas</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">worker</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">workerReady</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">_sendCanvas</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">yuv</span> = <span class="title class_">YUVCanvas</span>.<span class="title function_">attach</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>, &#123; <span class="attr">webGL</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">unbind</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">canvasWrapper</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">canvas</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">workerCanvas</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">canvasWrapper</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">container</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">element</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>.<span class="property">container</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">worker</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">worker</span>.<span class="title function_">terminate</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerReady</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasSent</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">yuv</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">container</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvasWrapper</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvasWrapper</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">element</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvas</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">offCanvas</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">worker</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">refreshCanvas</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// Not implemented for software renderer</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">updateCanvas</span> = <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (options === <span class="keyword">void</span> <span class="number">0</span>) &#123; options = &#123;</span><br><span class="line">            <span class="attr">width</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">rotation</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">mirrorView</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">contentMode</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">clientWidth</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">clientHeight</span>: <span class="number">0</span></span><br><span class="line">        &#125;; &#125;</span><br><span class="line">        <span class="comment">// check if display options changed</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isEqual</span>(<span class="variable language_">this</span>.<span class="property">cacheCanvasOpts</span>, options)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheCanvasOpts</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, options);</span><br><span class="line">        <span class="comment">// check for rotation</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">rotation</span> === <span class="number">0</span> || options.<span class="property">rotation</span> === <span class="number">180</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span> = options.<span class="property">width</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span> = options.<span class="property">height</span>;</span><br><span class="line">            <span class="comment">// canvas 调用 transferControlToOffscreen 方法后无法修改canvas的宽度和高度，只允许修改canvas的style属性</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">width</span> = options.<span class="property">width</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">height</span> = options.<span class="property">height</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">rotation</span> === <span class="number">90</span> || options.<span class="property">rotation</span> === <span class="number">270</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">height</span> = options.<span class="property">width</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">width</span> = options.<span class="property">height</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">height</span> = options.<span class="property">width</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">width</span> = options.<span class="property">height</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Invalid value for rotation. Only support 0, 90, 180, 270&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> transformItems = [];</span><br><span class="line">        transformItems.<span class="title function_">push</span>(<span class="string">&quot;rotateZ(&quot;</span> + options.<span class="property">rotation</span> + <span class="string">&quot;deg)&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> scale = <span class="variable language_">this</span>.<span class="title function_">_calcZoom</span>(options.<span class="property">rotation</span> === <span class="number">90</span> || options.<span class="property">rotation</span> === <span class="number">270</span>, options.<span class="property">contentMode</span>, options.<span class="property">width</span>, options.<span class="property">height</span>, options.<span class="property">clientWidth</span>, options.<span class="property">clientHeight</span>);</span><br><span class="line">        <span class="comment">// transformItems.push(`scale($&#123;scale&#125;)`)</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">zoom</span> = scale;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">zoom</span> = scale;</span><br><span class="line">        <span class="comment">// check for mirror</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">mirrorView</span>) &#123;</span><br><span class="line">            <span class="comment">// this.canvas.style.transform = &#x27;rotateY(180deg)&#x27;;</span></span><br><span class="line">            transformItems.<span class="title function_">push</span>(<span class="string">&#x27;rotateY(180deg)&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (transformItems.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> transform = <span class="string">&quot;&quot;</span> + transformItems.<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="property">style</span>.<span class="property">transform</span> = transform;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">workerCanvas</span>.<span class="property">style</span>.<span class="property">transform</span> = transform;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">drawFrame</span> = <span class="keyword">function</span> (<span class="params">imageData</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">ready</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ready</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(imageData.<span class="property">header</span>);</span><br><span class="line">        <span class="comment">// let format = dv.getUint8(0);</span></span><br><span class="line">        <span class="keyword">var</span> mirror = dv.<span class="title function_">getUint8</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> contentWidth = dv.<span class="title function_">getUint16</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> contentHeight = dv.<span class="title function_">getUint16</span>(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">var</span> left = dv.<span class="title function_">getUint16</span>(<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">var</span> top = dv.<span class="title function_">getUint16</span>(<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">var</span> right = dv.<span class="title function_">getUint16</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">var</span> bottom = dv.<span class="title function_">getUint16</span>(<span class="number">12</span>);</span><br><span class="line">        <span class="keyword">var</span> rotation = dv.<span class="title function_">getUint16</span>(<span class="number">14</span>);</span><br><span class="line">        <span class="comment">// let ts = dv.getUint32(16);</span></span><br><span class="line">        <span class="keyword">var</span> width = contentWidth + left + right;</span><br><span class="line">        <span class="keyword">var</span> height = contentHeight + top + bottom;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateCanvas</span>(&#123;</span><br><span class="line">            <span class="attr">width</span>: width, <span class="attr">height</span>: height, <span class="attr">rotation</span>: rotation,</span><br><span class="line">            <span class="attr">mirrorView</span>: !!mirror,</span><br><span class="line">            <span class="attr">contentMode</span>: <span class="variable language_">this</span>.<span class="property">contentMode</span>,</span><br><span class="line">            <span class="attr">clientWidth</span>: <span class="variable language_">this</span>.<span class="property">container</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">clientWidth</span>,</span><br><span class="line">            <span class="attr">clientHeight</span>: <span class="variable language_">this</span>.<span class="property">container</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">container</span>.<span class="property">clientHeight</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">_checkRendererWay</span>() === <span class="string">&#x27;software&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 实际渲染canvas</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">_softwareDrawFrame</span>(width, height, imageData.<span class="property">yUint8Array</span>, imageData.<span class="property">uUint8Array</span>, imageData.<span class="property">vUint8Array</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">_workDrawFrame</span>(width, height, imageData.<span class="property">yUint8Array</span>, imageData.<span class="property">uUint8Array</span>, imageData.<span class="property">vUint8Array</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空整个Canvas面板</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@memberof</span> <span class="variable">Renderer</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">clearFrame</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">_checkRendererWay</span>() === <span class="string">&#x27;software&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">yuv</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">yuv</span>.<span class="title function_">clear</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">worker</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">worker</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;clearFrame&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Renderer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setContentMode</span> = <span class="keyword">function</span> (<span class="params">mode</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="keyword">void</span> <span class="number">0</span>) &#123; mode = <span class="number">0</span>; &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">contentMode</span> = mode;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Renderer</span>;</span><br><span class="line">&#125;());</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = <span class="title class_">Renderer</span>;</span><br></pre></td></tr></table></figure>

<h4 id="渲染-WebWorker"><a href="#渲染-WebWorker" class="headerlink" title="渲染 WebWorker"></a>渲染 WebWorker</h4><p>具体代码如下所示:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// render worker</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dateFormat = <span class="keyword">function</span>(<span class="params">date, formatter = <span class="string">&#x27;YYYY-MM-DD hh:mm:ss SSS&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!date) &#123;</span><br><span class="line">      <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      time = <span class="keyword">new</span> <span class="title class_">Date</span>(date);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> oDate = &#123;</span><br><span class="line">      <span class="attr">Y</span>: time.<span class="title function_">getFullYear</span>(),</span><br><span class="line">      <span class="attr">M</span>: time.<span class="title function_">getMonth</span>() + <span class="number">1</span>,</span><br><span class="line">      <span class="attr">D</span>: time.<span class="title function_">getDate</span>(),</span><br><span class="line">      <span class="attr">h</span>: time.<span class="title function_">getHours</span>(),</span><br><span class="line">      <span class="attr">m</span>: time.<span class="title function_">getMinutes</span>(),</span><br><span class="line">      <span class="attr">s</span>: time.<span class="title function_">getSeconds</span>(),</span><br><span class="line">      <span class="attr">S</span>: time.<span class="title function_">getMilliseconds</span>()</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> formatter.<span class="title function_">replace</span>(<span class="regexp">/(Y|M|D|h|m|s|S)+/g</span>, <span class="function">(<span class="params">res, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> len = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (res.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">          len = res.<span class="title function_">slice</span>(<span class="number">1</span>, <span class="number">0</span>) === <span class="string">&#x27;Y&#x27;</span> ? <span class="number">4</span> : <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          len = <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          len = <span class="number">3</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">          len = <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          len = <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> (<span class="string">`0<span class="subst">$&#123;oDate[key]&#125;</span>`</span>).<span class="title function_">slice</span>(-len);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> yuv;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-buffer/yuv-buffer.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/shaders.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/depower.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/YCbCr.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/FrameSink.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/SoftwareFrameSink.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/WebGLFrameSink.js&#x27;</span>);</span><br><span class="line">    importScripts(<span class="string">&#x27;./yuv-canvas/yuv-canvas.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> data = e.<span class="property">data</span>;</span><br><span class="line">      <span class="keyword">switch</span> (data.<span class="property">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;constructor&#x27;</span>:</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;dateFormat(<span class="keyword">new</span> <span class="built_in">Date</span>())&#125;</span> RENDER_WORKER [INFO]: received canvas: `</span>, data.<span class="property">data</span>.<span class="property">canvas</span>, data.<span class="property">data</span>.<span class="property">id</span>);</span><br><span class="line">          yuv = <span class="title class_">YUVCanvas</span>.<span class="title function_">attach</span>(data.<span class="property">data</span>.<span class="property">canvas</span>, &#123; <span class="attr">webGL</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;drawFrame&#x27;</span>:</span><br><span class="line">          <span class="comment">// 考虑是否使用requestAnimationFrame进行渲染，控制每一帧显示的频率</span></span><br><span class="line">          <span class="keyword">const</span> width = data.<span class="property">data</span>.<span class="property">width</span>;</span><br><span class="line">          <span class="keyword">const</span> height = data.<span class="property">data</span>.<span class="property">height</span>;</span><br><span class="line">          <span class="keyword">const</span> yUint8Array = data.<span class="property">data</span>.<span class="property">yUint8Array</span>;</span><br><span class="line">          <span class="keyword">const</span> uUint8Array = data.<span class="property">data</span>.<span class="property">uUint8Array</span>;</span><br><span class="line">          <span class="keyword">const</span> vUint8Array = data.<span class="property">data</span>.<span class="property">vUint8Array</span>;</span><br><span class="line">          <span class="keyword">const</span> format = <span class="title class_">YUVBuffer</span>.<span class="title function_">format</span>(&#123;</span><br><span class="line">            <span class="attr">width</span>: width,</span><br><span class="line">            <span class="attr">height</span>: height,</span><br><span class="line">            <span class="attr">chromaWidth</span>: width / <span class="number">2</span>,</span><br><span class="line">            <span class="attr">chromaHeight</span>: height / <span class="number">2</span></span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">const</span> y = <span class="title class_">YUVBuffer</span>.<span class="title function_">lumaPlane</span>(format, yUint8Array);</span><br><span class="line">          <span class="keyword">const</span> u = <span class="title class_">YUVBuffer</span>.<span class="title function_">chromaPlane</span>(format, uUint8Array);</span><br><span class="line">          <span class="keyword">const</span> v = <span class="title class_">YUVBuffer</span>.<span class="title function_">chromaPlane</span>(format, vUint8Array);</span><br><span class="line">          <span class="keyword">const</span> frame = <span class="title class_">YUVBuffer</span>.<span class="title function_">frame</span>(format, y, u, v);</span><br><span class="line">          yuv &amp;&amp; yuv.<span class="title function_">drawFrame</span>(frame);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;clearFrame&#x27;</span>: &#123;</span><br><span class="line">          yuv &amp;&amp; yuv.<span class="title function_">clear</span>(frame);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;dateFormat(<span class="keyword">new</span> <span class="built_in">Date</span>())&#125;</span> RENDER_WORKER [INFO]: [RendererWorker]: Unknown message: `</span>, data);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    self.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;ready&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    self.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;exited&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;dateFormat(<span class="keyword">new</span> <span class="built_in">Date</span>())&#125;</span> RENDER_WORKER [INFO]: [RendererWorker]: catch error`</span>, error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>如果你对图像绘画使用得非常多，OffscreenCanvas可以有效的提高你APP的性能。它使得Worker可以处理canvas的渲染绘制，让你的APP更好地利用了多核系统。</p>
<p>OffscreenCanvas在Chrome 69中已经不需要开启flag（实验性功能）就可以使用了。它也正在被 Firefox 实现。由于其API与普通canvas元素非常相似，所以你可以轻松地对其进行特征检测并循序渐进地使用它，而不会破坏现有的APP或库的运行逻辑。OffscreenCanvas在任何涉及到图形计算以及动画表现且与DOM关系并不密切（即依赖DOM API不多）的情况下，它都具有性能优势。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/canvas/" rel="tag">canvas</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/html/" rel="tag">html</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webworker/" rel="tag">webworker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/yuv/" rel="tag">yuv</a></li></ul>

        <a data-url="https://hankliu62.github.io/2022/12/08/offscreen-canvas/" data-id="clw71fv0i000xs8ow1lh2hesu" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/01/10/cache-loader/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          cache-loader
        
      </div>
    </a>
  
  
    <a href="/2022/07/20/webwork-postmessage/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">WebWorker 和 postMessage 使用指南</div>
    </a>
  
</nav>

  
</article>


</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/05/02/github-action-auto-git-tag/">使用 GitHub Actions 自动推送 Git Tag</a>
          </li>
        
          <li>
            <a href="/2024/04/24/react-fiber-struct/">浅入解析 React Fiber 结构</a>
          </li>
        
          <li>
            <a href="/2024/04/20/communication-across-browser-tabs/">跨浏览器标签页进行通讯的方式简介</a>
          </li>
        
          <li>
            <a href="/2024/04/16/webrtc/">WebRTC:实时通信的未来</a>
          </li>
        
          <li>
            <a href="/2024/04/14/fontend-optimize-indicators/">Web前端最新优化指标：从FP到FPS的全面解析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/" rel="tag">canvas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csrf/" rel="tag">csrf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debugging/" rel="tag">debugging</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github-pages/" rel="tag">github pages</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/homebrew/" rel="tag">homebrew</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html/" rel="tag">html</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html5/" rel="tag">html5</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/loader/" rel="tag">loader</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/miniprogram/" rel="tag">miniprogram</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mobile/" rel="tag">mobile</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">network</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/optimize/" rel="tag">optimize</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reptile/" rel="tag">reptile</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/service-worker/" rel="tag">service worker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tag/" rel="tag">tag</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/translate/" rel="tag">translate</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vitepress/" rel="tag">vitepress</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webrtc/" rel="tag">webrtc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webworker/" rel="tag">webworker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weinre/" rel="tag">weinre</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yuv/" rel="tag">yuv</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">五月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">四月 2024</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 HankLiu, Inc. All rights reserved.<br>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">文章</a>
  
    <a href="/toolkit" class="mobile-nav-link">小工具</a>
  
    <a href="/resume" class="mobile-nav-link">小简介</a>
  
    <a href="/about" class="mobile-nav-link">小关于</a>
  
  <a href="#search" class="mobile-nav-link st-search-show-outputs">Search</a>
</nav>
  

<!-- totop start -->
<div id="totop">
	<a title="To Top"></a>
</div>
<!-- totop end -->

<!-- swiftype search start -->

<!-- swiftype search end -->



<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/lrsjng.jquery-qrcode/0.12.0/jquery.qrcode.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


</div>
</body>
</html>
